import streamlit as st
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
from datetime import datetime, timedelta
import numpy as np
import re
import os
import hashlib
import itertools
import warnings

# è­¦å‘Šã‚’éè¡¨ç¤ºã«ã™ã‚‹
warnings.filterwarnings('ignore', category=FutureWarning, module='yfinance')

# --- ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼è¨­å®š ---
USERS = {
    "admin": "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8",  # "password"
    "user1": "fcf730b6d95236ecd3c9fc2d92d7b6b2bb061514961aec041d6c7a7192f592e4",  # "secret123"
    "demo": "2a97516c354b68848cdbd8f54a226a0a55b21ed138e207ad6c5cbb9c00aa5aea",   # "demo"
    "eddy80524": "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225",  # "123456789"
    "aoto7043": "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225",   # "123456789"
    "yu-ado43": "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225",   # "123456789"
    "seita": "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225",      # "123456789"
    "yiuka3555": "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225",   # "123456789"
}

# åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥
INITIAL_PASSWORD_HASH = "15e2b0d3c33891ebb0f1ef609ec419420c20e320ce94c65fbc8c3312448eb225"  # "123456789"

def load_user_data():
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿"""
    user_file = "user_data.txt"
    if os.path.exists(user_file):
        users = {}
        with open(user_file, 'r', encoding='utf-8') as f:
            for line in f:
                if ':' in line:
                    username, password_hash = line.strip().split(':', 1)
                    users[username] = password_hash
        return users
    return USERS.copy()

def save_user_data(users):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
    user_file = "user_data.txt"
    with open(user_file, 'w', encoding='utf-8') as f:
        for username, password_hash in users.items():
            f.write(f"{username}:{password_hash}\n")

def update_password(username, new_password):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°"""
    users = load_user_data()
    users[username] = hash_password(new_password)
    save_user_data(users)
    return True

def is_initial_password(username, password):
    """åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯"""
    return hash_password(password) == INITIAL_PASSWORD_HASH

def hash_password(password):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SHA256ã§ãƒãƒƒã‚·ãƒ¥åŒ–"""
    return hashlib.sha256(password.encode()).hexdigest()

def check_login(username, password):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼"""
    users = load_user_data()
    if username in users:
        return users[username] == hash_password(password)
    return False

def login_page():
    """ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸"""
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
    st.markdown("""
    <style>
    .css-1d391kg {display: none}
    .st-emotion-cache-1cypcdb {display: none}
    .st-emotion-cache-1gwvy71 {display: none}
    [data-testid="stSidebar"] {display: none}
    </style>
    """, unsafe_allow_html=True)
    
    st.title("ğŸ” æ ªå¼åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ãƒ­ã‚°ã‚¤ãƒ³")
    
    # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
    if 'password_change_required' in st.session_state and st.session_state.password_change_required:
        st.warning("âš ï¸ åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã§ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚")
        
        with st.form("password_change_form"):
            st.write("### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´")
            new_password = st.text_input("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
            confirm_password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª", type="password")
            
            col1, col2, col3 = st.columns([1, 1, 2])
            with col2:
                change_button = st.form_submit_button("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´", use_container_width=True)
            
            if change_button:
                if new_password != confirm_password:
                    st.error("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚")
                elif len(new_password) < 6:
                    st.error("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
                elif new_password == "123456789":
                    st.error("âŒ åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¨­å®šã§ãã¾ã›ã‚“ã€‚")
                else:
                    if update_password(st.session_state.temp_username, new_password):
                        st.success("âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼")
                        st.session_state.authenticated = True
                        st.session_state.username = st.session_state.temp_username
                        st.session_state.password_change_required = False
                        if 'temp_username' in st.session_state:
                            del st.session_state.temp_username
                        st.rerun()
                    else:
                        st.error("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
        return
    
    # é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
    with st.form("login_form"):
        st.write("### ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
        username = st.text_input("ãƒ¦ãƒ¼ã‚¶ãƒ¼å")
        password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
        
        col1, col2, col3 = st.columns([1, 1, 2])
        with col2:
            submit_button = st.form_submit_button("ãƒ­ã‚°ã‚¤ãƒ³", use_container_width=True)
        
        if submit_button:
            if check_login(username, password):
                # åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‹ãƒã‚§ãƒƒã‚¯
                if is_initial_password(username, password):
                    st.session_state.password_change_required = True
                    st.session_state.temp_username = username
                    st.info("ğŸ”‘ åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚")
                    st.rerun()
                else:
                    st.session_state.authenticated = True
                    st.session_state.username = username
                    st.success("âœ… ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸï¼")
                    st.rerun()
            else:
                st.error("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")

def password_change_page():
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒšãƒ¼ã‚¸"""
    st.title("ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´")
    
    with st.form("password_change_form"):
        st.write("### æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š")
        current_password = st.text_input("ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
        new_password = st.text_input("æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰", type="password")
        confirm_password = st.text_input("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª", type="password")
        
        col1, col2, col3 = st.columns([1, 1, 2])
        with col2:
            change_button = st.form_submit_button("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´", use_container_width=True)
        
        if change_button:
            # ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
            if not check_login(st.session_state.username, current_password):
                st.error("âŒ ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚")
            elif new_password != confirm_password:
                st.error("âŒ æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚")
            elif len(new_password) < 6:
                st.error("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
            elif new_password == current_password:
                st.error("âŒ ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è¨­å®šã§ãã¾ã›ã‚“ã€‚")
            else:
                if update_password(st.session_state.username, new_password):
                    st.success("âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸï¼")
                    st.info("æ¬¡å›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã‹ã‚‰æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚")
                else:
                    st.error("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
    
    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³
    st.write("---")
    if st.button("ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹", type="primary"):
        st.session_state.page = 'dashboard'
        st.rerun()

def logout():
    """ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†"""
    st.session_state.authenticated = False
    st.session_state.username = None
    if 'page' in st.session_state:
        st.session_state.page = 'dashboard'
    st.rerun()

# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(
    page_title="çµ±åˆæ ªå¼åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
    page_icon="ğŸ“ˆ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ– ---
if 'authenticated' not in st.session_state:
    st.session_state.authenticated = False
if 'username' not in st.session_state:
    st.session_state.username = None
if 'page' not in st.session_state:
    st.session_state.page = 'dashboard'
if 'selected_ticker' not in st.session_state:
    st.session_state.selected_ticker = None

# --- æ—¥æœ¬ä¼æ¥­åãƒãƒƒãƒ”ãƒ³ã‚° ---
JAPANESE_COMPANY_NAMES = {
    '6357.T': 'ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º',
    '4816.T': 'æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³',
    '2991.T': 'ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆ',
    '7564.T': 'ãƒ¯ãƒ¼ã‚¯ãƒãƒ³',
    '7711.T': 'åŠ©å·é›»æ°—å·¥æ¥­',
    '6405.T': 'éˆ´èŒ‚å™¨å·¥',
    '2428.T': 'ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆ',
    '6231.T': 'æœ¨æ‘å·¥æ©Ÿ',
    '6855.T': 'æ—¥æœ¬é›»å­ææ–™',
    '4832.T': 'JFEã‚·ã‚¹ãƒ†ãƒ ã‚º',
    '4767.T': 'ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼',
    # æ—¢å­˜ã®å¤§å‹æ ª
    '1308.T': 'TOPIXã‚³ã‚¢30é€£å‹•å‹ETF',
    '6758.T': 'ã‚½ãƒ‹ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—',
    '7203.T': 'ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Š',
    '6861.T': 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹',
    '4568.T': 'ç¬¬ä¸€ä¸‰å…±',
    '8035.T': 'æ±äº¬ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ³',
    '8306.T': 'ä¸‰è±UFJãƒ•ã‚£ãƒŠãƒ³ã‚·ãƒ£ãƒ«ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—',
    '9983.T': 'ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒªãƒ†ã‚¤ãƒªãƒ³ã‚°',
    '6752.T': 'ãƒ‘ãƒŠã‚½ãƒ‹ãƒƒã‚¯',
}

# TICKER_NAMESã¨ã—ã¦ã‚‚ä½¿ç”¨å¯èƒ½
TICKER_NAMES = JAPANESE_COMPANY_NAMES

# --- ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºæ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_6357 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/09 æ±º70.000
-
5.000
-
5.300
-
-
3.200
-
171.410
-
60.000
-
2025/08/07 æ±º70.000
â†’
5.000
â†’
5.300
â†’
-
3.200
â†’
171.410
â†’
60.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/09 æ±º64.000
-
5.100
-
5.400
-
-
3.300
-
177.480
-
50.000
-
2024/08/08 æ±º64.000
â†’
5.100
â†’
5.400
â†’
-
3.300
â†’
177.480
â†’
50.000
â†’
2024/11/14 æ±º64.000
â†’
5.100
â†’
5.400
â†’
-
3.300
â†’
177.480
â†’
50.000
â†’
2025/02/13 æ±º64.000
â†’
5.100
â†’
5.400
â†’
-
3.300
â†’
177.480
â†’
50.000
â†’
2025/05/09 å®Ÿ61.862
â†“(-2.138)
4.797
â†“(-0.303)
5.294
â†“(-0.106)
5.300
-
2.995
â†“(-0.305)
160.450
â†“(-17.030)
55.000
â†‘(+5.000)
Delta from Initial Guidanceâ†“(-2.138)
â†“(-0.303)
â†“(-0.106)
-
â†“(-0.305)
â†“(-17.030)
â†‘(+5.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/11 æ±º47.000
-
2.900
-
2.900
-
-
2.000
-
107.760
-
40.000
-
2023/08/10 æ±º47.000
â†’
2.900
â†’
2.900
â†’
-
2.000
â†’
107.760
â†’
40.000
â†’
2023/11/09 æ±º47.000
â†’
2.900
â†’
2.900
â†’
-
2.000
â†’
107.760
â†’
40.000
â†’
2024/02/08 æ±º47.000
â†’
2.900
â†’
2.900
â†’
-
2.000
â†’
107.760
â†’
40.000
â†’
2024/05/09 å®Ÿ52.307
â†‘(+5.307)
3.156
â†‘(+0.256)
3.597
â†‘(+0.697)
3.585
-
2.072
â†‘(+0.072)
111.450
â†‘(+3.690)
40.000
â†’
Delta from Initial Guidanceâ†‘(+5.307)
â†‘(+0.256)
â†‘(+0.697)
-
â†‘(+0.072)
â†‘(+3.690)
â†’
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/13 æ±º40.500
-
2.000
-
2.000
-
-
1.500
-
81.060
-
35.000
-
2022/08/04 æ±º40.500
â†’
2.000
â†’
2.000
â†’
-
1.500
â†’
81.060
â†’
35.000
â†’
2022/11/10 æ±º40.500
â†’
2.000
â†’
2.000
â†’
-
1.500
â†’
81.060
â†’
35.000
â†’
2023/02/09 æ±º40.500
â†’
2.000
â†’
2.000
â†’
-
1.500
â†’
81.060
â†’
35.000
â†’
2023/05/11 å®Ÿ40.684
â†‘(+0.184)
2.007
â†‘(+0.007)
2.758
â†‘(+0.758)
2.758
-
1.704
â†‘(+0.204)
91.890
â†‘(+10.830)
37.500
â†‘(+2.500)
Delta from Initial Guidanceâ†‘(+0.184)
â†‘(+0.007)
â†‘(+0.758)
-
â†‘(+0.204)
â†‘(+10.830)
â†‘(+2.500)
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/05/14 æ±º36.000
-
1.500
-
2.000
-
-
1.100
-
59.470
-
35.000
-
2021/08/05 æ±º36.000
â†’
1.500
â†’
2.000
â†’
-
1.100
â†’
59.470
â†’
35.000
â†’
2021/11/11 æ±º36.000
â†’
1.500
â†’
2.000
â†’
-
1.100
â†’
59.470
â†’
35.000
â†’
2022/02/10 æ±º36.000
â†’
1.500
â†’
2.000
â†’
-
1.100
â†’
59.470
â†’
35.000
â†’
2022/05/13 å®Ÿ34.404
â†“(-1.596)
1.040
â†“(-0.460)
1.881
â†“(-0.119)
2.541
-
1.449
â†‘(+0.349)
78.290
â†‘(+18.820)
35.000
â†’
Delta from Initial Guidanceâ†“(-1.596)
â†“(-0.460)
â†“(-0.119)
-
â†‘(+0.349)
â†‘(+18.820)
â†’
FY 2021.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2020/11/12 æ±º37.000
-
0.540
-
0.540
-
-
-0.240
-
-12.980
-
30.000
-
2021/02/10 æ±º37.000
â†’
0.540
â†’
0.540
â†’
-
-0.240
â†’
-12.980
â†’
30.000
â†’
2021/04/28 ä¿®36.500
â†“(-0.500)
1.400
â†‘(+0.860)
1.500
â†‘(+0.960)
-
0.700
â†‘(+0.940)
37.850
â†‘(+50.830)
-
2021/05/14 å®Ÿ36.538
â†‘(+0.038)
1.423
â†‘(+0.023)
1.544
â†‘(+0.044)
1.544
-
0.751
â†‘(+0.051)
40.620
â†‘(+2.770)
35.000
-
Delta from Initial Guidanceâ†“(-0.462)
â†‘(+0.883)
â†‘(+1.004)
-
â†‘(+0.991)
â†‘(+53.600)
â†‘(+5.000)
FY 2020.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2019/11/14 æ±º50.000
-
3.300
-
3.200
-
-
1.250
-
67.740
-
35.000
-
2020/02/13 æ±º50.000
â†’
3.300
â†’
3.200
â†’
-
1.250
â†’
67.740
â†’
35.000
â†’
2020/05/15 å®Ÿ45.078
â†“(-4.922)
2.872
â†“(-0.428)
2.890
â†“(-0.310)
2.602
-
1.421
â†‘(+0.171)
76.950
â†‘(+9.210)
35.000
â†’
Delta from Initial Guidanceâ†“(-4.922)
â†“(-0.428)
â†“(-0.310)
-
â†‘(+0.171)
â†‘(+9.210)
â†’
"""

# --- æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_4816 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/16 æ±º88.000
-
26.000
-
26.700
-
-
19.100
-
93.400
-
41.000
-
2025/07/30 æ±º88.000
â†’
26.000
â†’
26.700
â†’
-
19.100
â†’
93.400
â†’
41.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/13 æ±º82.000
-
20.000
-
20.500
-
-
15.000
-
73.360
-
31.000
-
2024/07/31 æ±º82.000
â†’
20.000
â†’
20.500
â†’
-
15.000
â†’
73.360
â†’
31.000
â†’
2024/10/28 ä¿®90.000
â†‘(+8.000)
27.000
â†‘(+7.000)
27.500
â†‘(+7.000)
-
19.500
â†‘(+4.500)
95.360
â†‘(+22.000)
-
2024/10/30 æ±º90.000
â†’
27.000
â†’
27.500
â†’
-
19.500
â†’
95.360
â†’
31.000
-
2025/01/30 æ±º90.000
â†’
27.000
â†’
27.500
â†’
-
19.500
â†’
95.360
â†’
31.000
â†’
2025/05/14 ä¿®100.800
â†‘(+10.800)
32.400
â†‘(+5.400)
33.100
â†‘(+5.600)
-
23.600
â†‘(+4.100)
115.410
â†‘(+20.050)
-
2025/05/16 å®Ÿ100.836
â†‘(+0.036)
32.432
â†‘(+0.032)
33.188
â†‘(+0.088)
32.809
-
23.623
â†‘(+0.023)
115.520
â†‘(+0.110)
41.000
-
Delta from Initial Guidanceâ†‘(+18.836)
â†‘(+12.432)
â†‘(+12.688)
-
â†‘(+8.623)
â†‘(+42.160)
â†‘(+10.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/11 æ±º72.000
-
17.500
-
17.800
-
-
12.000
-
293.490
-
90.000
-
2023/07/28 æ±º72.000
â†’
17.500
â†’
17.800
â†’
-
12.000
â†’
293.490
â†’
90.000
â†’
2023/10/24 ä¿®82.000
â†‘(+10.000)
19.000
â†‘(+1.500)
20.000
â†‘(+2.200)
-
13.500
â†‘(+1.500)
330.130
â†‘(+36.640)
-
2023/10/27 æ±º82.000
â†’
19.000
â†’
20.000
â†’
-
13.500
â†’
330.130
â†’
90.000
-
2024/01/29 æ±º83.000
â†‘(+1.000)
20.500
â†‘(+1.500)
21.500
â†‘(+1.500)
-
15.500
â†‘(+2.000)
379.040
â†‘(+48.910)
114.000
â†‘(+24.000)
2024/05/13 å®Ÿ88.654
â†‘(+5.654)
23.364
â†‘(+2.864)
26.453
â†‘(+4.953)
26.707
-
18.795
â†‘(+3.295)
91.930
â†“(-287.110)
155.000
â†‘(+41.000)
Delta from Initial Guidanceâ†‘(+16.654)
â†‘(+5.864)
â†‘(+8.653)
-
â†‘(+6.795)
â†“(-201.560)
â†‘(+65.000)
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/12 æ±º70.000
-
18.300
-
18.900
-
-
13.500
-
330.080
-
99.000
-
2022/07/28 æ±º70.000
â†’
18.300
â†’
18.900
â†’
-
13.500
â†’
330.080
â†’
99.000
â†’
2022/10/21 ä¿®76.000
â†‘(+6.000)
23.500
â†‘(+5.200)
25.000
â†‘(+6.100)
-
18.000
â†‘(+4.500)
440.150
â†‘(+110.070)
-
2022/10/27 æ±º76.000
â†’
23.500
â†’
25.000
â†’
-
18.000
â†’
440.150
â†’
99.000
-
2023/01/30 æ±º76.000
â†’
23.500
â†’
25.000
â†’
-
18.000
â†’
440.150
â†’
99.000
â†’
2023/04/25 ä¿®87.400
â†‘(+11.400)
28.600
â†‘(+5.100)
29.700
â†‘(+4.700)
-
20.900
â†‘(+2.900)
511.110
â†‘(+70.960)
-
2023/05/11 å®Ÿ87.457
â†‘(+0.057)
28.669
â†‘(+0.069)
29.791
â†‘(+0.091)
29.791
-
20.900
â†’
102.220
â†“(-408.890)
155.000
-
Delta from Initial Guidanceâ†‘(+17.457)
â†‘(+10.369)
â†‘(+10.891)
-
â†‘(+7.400)
â†“(-227.860)
â†‘(+56.000)
"""

# --- ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆæ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_2991 = """
FY 2025.07å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/09/09 æ±º96.241
-
3.262
-
2.821
-
-
1.881
-
314.940
-
31.500
-
2024/10/15 ä¿®-
-
-
-
-
-
15.750
â†“(-15.750)
2024/12/09 æ±º96.241
-
3.262
-
2.821
-
-
1.881
-
157.470
-
15.750
â†’
2025/03/10 æ±º98.241
â†‘(+2.000)
3.847
â†‘(+0.585)
3.437
â†‘(+0.616)
-
2.332
â†‘(+0.451)
195.130
â†‘(+37.660)
19.550
â†‘(+3.800)
2025/06/09 æ±º98.241
â†’
3.847
â†’
3.437
â†’
-
2.332
â†’
195.130
â†’
19.550
â†’
FY 2024.07å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/09/08 æ±º73.857
-
1.794
-
1.565
-
-
1.044
-
175.420
-
18.500
-
2023/12/08 æ±º73.857
â†’
1.794
â†’
1.565
â†’
-
1.044
â†’
175.420
â†’
18.500
â†’
2024/03/08 æ±º73.857
â†’
1.794
â†’
1.565
â†’
-
1.044
â†’
175.420
â†’
18.500
â†’
2024/06/07 æ±º73.857
â†’
1.794
â†’
1.565
â†’
-
1.044
â†’
175.420
â†’
18.500
â†’
2024/07/26 ä¿®75.880
â†‘(+2.023)
2.408
â†‘(+0.614)
2.133
â†‘(+0.568)
-
1.520
â†‘(+0.476)
254.430
â†‘(+79.010)
25.500
â†‘(+7.000)
2024/09/09 å®Ÿ77.791
â†‘(+1.911)
2.786
â†‘(+0.378)
2.519
â†‘(+0.386)
2.753
-
1.840
â†‘(+0.320)
308.830
â†‘(+54.400)
30.750
â†‘(+5.250)
Delta from Initial Guidanceâ†‘(+3.934)
â†‘(+0.992)
â†‘(+0.954)
-
â†‘(+0.796)
â†‘(+133.410)
â†‘(+12.250)
FY 2023.07å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/09/09 æ±º60.099
-
1.869
-
1.704
-
-
1.097
-
369.800
-
37.000
-
2022/11/14 ä¿®-
-
-
-
-
-
18.500
â†“(-18.500)
2022/12/12 æ±º60.099
-
1.869
-
1.704
-
-
1.097
-
184.900
-
18.500
â†’
2023/03/10 æ±º60.099
â†’
1.869
â†’
1.704
â†’
-
1.097
â†’
184.450
â†“(-0.450)
18.500
â†’
2023/06/09 æ±º60.099
â†’
1.869
â†’
1.704
â†’
-
1.097
â†’
184.450
â†’
18.500
â†’
2023/09/08 å®Ÿ63.648
â†‘(+3.549)
1.521
â†“(-0.348)
1.362
â†“(-0.342)
1.478
-
0.988
â†“(-0.109)
166.090
â†“(-18.360)
18.500
â†’
Delta from Initial Guidanceâ†‘(+3.549)
â†“(-0.348)
â†“(-0.342)
-
â†“(-0.109)
â†“(-203.710)
â†“(-18.500)
FY 2022.07å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/09/10 æ±º48.721
-
1.502
-
1.405
-
-
0.969
-
654.530
-
51.500
-
2021/12/10 æ±º48.721
â†’
1.502
â†’
1.405
â†’
-
0.969
â†’
654.530
â†’
51.500
â†’
2022/03/11 æ±º48.721
â†’
1.502
â†’
1.405
â†’
-
0.969
â†’
654.530
â†’
51.500
â†’
2022/05/16 ä¿®-
-
-
-
-
-
25.750
â†“(-25.750)
2022/06/10 æ±º48.721
-
1.502
-
1.405
-
-
0.969
-
327.270
-
25.750
â†’
2022/09/09 å®Ÿ51.871
â†‘(+3.150)
1.505
â†‘(+0.003)
1.389
â†“(-0.016)
1.433
-
0.956
â†“(-0.013)
161.110
â†“(-166.160)
32.250
â†‘(+6.500)
Delta from Initial Guidanceâ†‘(+3.150)
â†‘(+0.003)
â†“(-0.016)
-
â†“(-0.013)
â†“(-493.420)
â†“(-19.250)
"""

# --- ãƒ¯ãƒ¼ã‚¯ãƒãƒ³æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_7564 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/12 æ±º147.152
-
26.005
-
26.760
-
-
18.100
-
221.790
-
73.000
-
2025/08/04 æ±º147.152
â†’
26.005
â†’
26.760
â†’
-
18.100
â†’
221.790
â†’
73.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/07 æ±º138.564
-
23.632
-
24.167
-
-
16.325
-
200.040
-
68.000
-
2024/08/05 æ±º138.564
â†’
23.632
â†’
24.167
â†’
-
16.325
â†’
200.040
â†’
68.000
â†’
2024/11/05 æ±º138.564
â†’
23.632
â†’
24.167
â†’
-
16.325
â†’
200.040
â†’
68.000
â†’
2025/02/10 æ±º138.564
â†’
23.632
â†’
24.167
â†’
-
16.325
â†’
200.040
â†’
68.000
â†’
2025/05/12 å®Ÿ136.933
â†“(-1.631)
24.394
â†‘(+0.762)
24.904
â†‘(+0.737)
24.890
-
16.892
â†‘(+0.567)
206.990
â†‘(+6.950)
73.000
â†‘(+5.000)
Delta from Initial Guidanceâ†“(-1.631)
â†‘(+0.762)
â†‘(+0.737)
-
â†‘(+0.567)
â†‘(+6.950)
â†‘(+5.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/08 æ±º136.576
-
25.720
-
26.214
-
-
17.563
-
215.210
-
68.000
-
2023/08/07 æ±º136.576
â†’
25.720
â†’
26.214
â†’
-
17.563
â†’
215.210
â†’
68.000
â†’
2023/11/06 æ±º136.576
â†’
25.720
â†’
26.214
â†’
-
17.563
â†’
215.210
â†’
68.000
â†’
2024/02/05 æ±º134.993
â†“(-1.583)
23.440
â†“(-2.280)
23.955
â†“(-2.259)
-
16.030
â†“(-1.533)
196.420
â†“(-18.790)
68.000
â†’
2024/05/07 å®Ÿ132.651
â†“(-2.342)
23.142
â†“(-0.298)
23.666
â†“(-0.289)
23.636
-
15.986
â†“(-0.044)
195.880
â†“(-0.540)
68.000
â†’
Delta from Initial Guidanceâ†“(-3.925)
â†“(-2.578)
â†“(-2.548)
-
â†“(-1.577)
â†“(-19.330)
â†’
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/09 æ±º124.110
-
24.461
-
25.063
-
-
16.782
-
205.650
-
68.000
-
2022/08/08 æ±º124.110
â†’
24.461
â†’
25.063
â†’
-
16.782
â†’
205.650
â†’
68.000
â†’
2022/11/07 æ±º125.213
â†‘(+1.103)
21.774
â†“(-2.687)
22.355
â†“(-2.708)
-
14.897
â†“(-1.885)
182.550
â†“(-23.100)
68.000
â†’
2023/02/06 æ±º125.213
â†’
21.774
â†’
22.355
â†’
-
14.897
â†’
182.550
â†’
68.000
â†’
2023/05/08 å®Ÿ128.289
â†‘(+3.076)
24.106
â†‘(+2.332)
24.664
â†‘(+2.309)
24.655
-
16.656
â†‘(+1.759)
204.100
â†‘(+21.550)
68.000
â†’
Delta from Initial Guidanceâ†‘(+4.179)
â†“(-0.355)
â†“(-0.399)
-
â†“(-0.126)
â†“(-1.550)
â†’
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/05/10 æ±º114.445
-
26.673
-
27.200
-
-
18.155
-
222.460
-
64.000
-
2021/08/10 æ±º114.445
â†’
26.673
â†’
27.200
â†’
-
18.155
â†’
222.460
â†’
64.000
â†’
2021/11/08 æ±º114.445
â†’
26.673
â†’
27.200
â†’
-
18.155
â†’
222.460
â†’
64.000
â†’
2022/02/07 æ±º114.445
â†’
26.673
â†’
27.200
â†’
-
18.155
â†’
222.460
â†’
64.000
â†’
2022/05/09 å®Ÿ116.264
â†‘(+1.819)
26.802
â†‘(+0.129)
27.395
â†‘(+0.195)
27.313
-
18.303
â†‘(+0.148)
224.280
â†‘(+1.820)
68.000
â†‘(+4.000)
Delta from Initial Guidanceâ†‘(+1.819)
â†‘(+0.129)
â†‘(+0.195)
-
â†‘(+0.148)
â†‘(+1.820)
â†‘(+4.000)
FY 2021.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2020/08/11 æ±º99.009
-
21.847
-
23.343
-
-
15.539
-
190.410
-
50.000
-
2020/11/09 æ±º99.009
â†’
21.847
â†’
23.343
â†’
-
15.539
â†’
190.410
â†’
50.000
â†’
2021/02/08 æ±º99.009
â†’
21.847
â†’
23.343
â†’
-
15.539
â†’
190.410
â†’
50.000
â†’
2021/05/10 å®Ÿ105.815
â†‘(+6.806)
23.955
â†‘(+2.108)
25.409
â†‘(+2.066)
25.356
-
17.039
â†‘(+1.500)
208.800
â†‘(+18.390)
64.000
â†‘(+14.000)
Delta from Initial Guidanceâ†‘(+6.806)
â†‘(+2.108)
â†‘(+2.066)
-
â†‘(+1.500)
â†‘(+18.390)
â†‘(+14.000)
"""

# --- åŠ©å·é›»æ°—å·¥æ¥­æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_7711 = """
FY 2025.09å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/11/07 æ±º5.060
-
0.836
-
0.843
-
-
0.590
-
106.980
-
36.000
-
2024/12/06 æ±º5.060
â†’
0.836
â†’
0.843
â†’
-
0.590
â†’
106.980
â†’
36.000
â†’
2025/02/06 æ±º5.060
â†’
0.836
â†’
0.843
â†’
-
0.590
â†’
106.980
â†’
36.000
â†’
2025/05/08 æ±º5.480
â†‘(+0.420)
1.020
â†‘(+0.184)
1.029
â†‘(+0.186)
-
0.724
â†‘(+0.134)
131.280
â†‘(+24.300)
38.000
â†‘(+2.000)
2025/08/07 æ±º5.700
â†‘(+0.220)
1.210
â†‘(+0.190)
1.224
â†‘(+0.195)
-
0.829
â†‘(+0.105)
150.320
â†‘(+19.040)
40.000
â†‘(+2.000)
FY 2024.09å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/11/09 æ±º4.590
-
0.514
-
0.519
-
-
0.363
-
65.820
-
30.000
-
2024/02/08 æ±º4.779
â†‘(+0.189)
0.650
â†‘(+0.136)
0.652
â†‘(+0.133)
-
0.456
â†‘(+0.093)
82.680
â†‘(+16.860)
30.000
â†’
2024/05/09 æ±º4.779
â†’
0.725
â†‘(+0.075)
0.731
â†‘(+0.079)
-
0.517
â†‘(+0.061)
93.750
â†‘(+11.070)
31.000
â†‘(+1.000)
2024/08/08 æ±º4.779
â†’
0.789
â†‘(+0.064)
0.797
â†‘(+0.066)
-
0.565
â†‘(+0.048)
102.450
â†‘(+8.700)
32.000
â†‘(+1.000)
2024/11/07 å®Ÿ4.965
â†‘(+0.186)
0.916
â†‘(+0.127)
0.917
â†‘(+0.120)
0.893
-
0.637
â†‘(+0.072)
115.680
â†‘(+13.230)
34.000
â†‘(+2.000)
Delta from Initial Guidanceâ†‘(+0.375)
â†‘(+0.402)
â†‘(+0.398)
-
â†‘(+0.274)
â†‘(+49.860)
â†‘(+4.000)
FY 2023.09å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/11/10 æ±º4.539
-
0.479
-
0.472
-
-
0.293
-
49.930
-
28.000
-
2023/02/09 æ±º4.539
â†’
0.479
â†’
0.472
â†’
-
0.293
â†’
49.930
â†’
28.000
â†’
2023/05/11 æ±º4.539
â†’
0.479
â†’
0.472
â†’
-
0.293
â†’
52.570
â†‘(+2.640)
28.000
â†’
2023/08/09 æ±º4.549
â†‘(+0.010)
0.517
â†‘(+0.038)
0.525
â†‘(+0.053)
-
0.344
â†‘(+0.051)
61.720
â†‘(+9.150)
29.000
â†‘(+1.000)
2023/11/09 å®Ÿ4.577
â†‘(+0.028)
0.590
â†‘(+0.073)
0.597
â†‘(+0.072)
0.564
-
0.397
â†‘(+0.053)
71.370
â†‘(+9.650)
29.000
â†’
Delta from Initial Guidanceâ†‘(+0.038)
â†‘(+0.111)
â†‘(+0.125)
-
â†‘(+0.104)
â†‘(+21.440)
â†‘(+1.000)
FY 2022.09å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/11/11 æ±º4.222
-
0.363
-
0.365
-
-
0.252
-
42.940
-
26.000
-
2022/02/08 æ±º4.539
â†‘(+0.317)
0.472
â†‘(+0.109)
0.474
â†‘(+0.109)
-
0.321
â†‘(+0.069)
54.700
â†‘(+11.760)
26.000
â†’
2022/05/10 æ±º4.539
â†’
0.472
â†’
0.474
â†’
-
0.321
â†’
54.700
â†’
26.000
â†’
2022/08/09 æ±º4.539
â†’
0.472
â†’
0.474
â†’
-
0.321
â†’
54.700
â†’
26.000
â†’
2022/11/10 å®Ÿ4.332
â†“(-0.207)
0.445
â†“(-0.027)
0.469
â†“(-0.005)
0.469
-
0.325
â†‘(+0.004)
55.460
â†‘(+0.760)
27.000
â†‘(+1.000)
Delta from Initial Guidanceâ†‘(+0.110)
â†‘(+0.082)
â†‘(+0.104)
-
â†‘(+0.073)
â†‘(+12.520)
â†‘(+1.000)
FY 2021.09å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2020/11/10 æ±º3.574
-
0.093
-
0.094
-
-
0.060
-
10.220
-
24.000
-
2021/02/09 æ±º3.574
â†’
0.093
â†’
0.094
â†’
-
0.060
â†’
10.220
â†’
24.000
â†’
2021/04/28 ä¿®3.622
â†‘(+0.048)
0.219
â†‘(+0.126)
0.221
â†‘(+0.127)
-
0.177
â†‘(+0.117)
30.160
â†‘(+19.940)
-
2021/05/06 æ±º3.622
â†’
0.219
â†’
0.221
â†’
-
0.177
â†’
30.160
â†’
24.000
-
2021/08/05 æ±º3.622
â†’
0.219
â†’
0.221
â†’
-
0.177
â†’
30.160
â†’
24.000
â†’
2021/11/04 ä¿®3.698
â†‘(+0.076)
0.292
â†‘(+0.073)
0.288
â†‘(+0.067)
-
0.199
â†‘(+0.022)
33.910
â†‘(+3.750)
-
2021/11/11 å®Ÿ3.698
â†’
0.293
â†‘(+0.001)
0.289
â†‘(+0.001)
0.289
-
0.199
â†’
33.980
â†‘(+0.070)
24.000
-
Delta from Initial Guidanceâ†‘(+0.124)
â†‘(+0.200)
â†‘(+0.195)
-
â†‘(+0.139)
â†‘(+23.760)
â†’
"""

# --- éˆ´èŒ‚å™¨å·¥æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_6405 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/13 æ±º17.870
-
2.000
-
2.045
-
-
1.495
-
115.540
-
35.000
-
2025/08/08 æ±º17.870
â†’
2.000
â†’
2.045
â†’
-
1.495
â†’
115.540
â†’
35.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/13 æ±º15.960
-
1.900
-
1.915
-
-
1.350
-
104.410
-
33.000
-
2024/06/18 æ±º15.960
â†’
1.900
â†’
1.915
â†’
-
1.350
â†’
104.410
â†’
33.000
â†’
2024/08/09 æ±º15.960
â†’
1.900
â†’
1.915
â†’
-
1.350
â†’
104.410
â†’
33.000
â†’
2024/11/14 æ±º15.960
â†’
1.900
â†’
1.915
â†’
-
1.350
â†’
104.410
â†’
33.000
â†’
2025/02/14 æ±º15.960
â†’
1.900
â†’
1.915
â†’
-
1.350
â†’
104.410
â†’
33.000
â†’
2025/05/13 å®Ÿ15.568
â†“(-0.392)
1.890
â†“(-0.010)
1.948
â†‘(+0.033)
1.970
-
1.463
â†‘(+0.113)
113.090
â†‘(+8.680)
34.000
â†‘(+1.000)
Delta from Initial Guidanceâ†“(-0.392)
â†“(-0.010)
â†‘(+0.033)
-
â†‘(+0.113)
â†‘(+8.680)
â†‘(+1.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/12 æ±º15.000
-
1.500
-
1.505
-
-
1.020
-
78.880
-
31.000
-
2023/08/10 æ±º15.000
â†’
1.500
â†’
1.505
â†’
-
1.020
â†’
78.880
â†’
31.000
â†’
2024/02/14 æ±º15.000
â†’
1.500
â†’
1.505
â†’
-
1.020
â†’
78.880
â†’
31.000
â†’
2024/05/13 å®Ÿ14.515
â†“(-0.485)
1.475
â†“(-0.025)
1.498
â†“(-0.007)
1.545
-
1.141
â†‘(+0.121)
88.230
â†‘(+9.350)
32.000
â†‘(+1.000)
Delta from Initial Guidanceâ†“(-0.485)
â†“(-0.025)
â†“(-0.007)
-
â†‘(+0.121)
â†‘(+9.350)
â†‘(+1.000)
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/13 æ±º13.000
-
1.800
-
1.800
-
-
1.315
-
203.620
-
62.000
-
2022/06/07 ä¿®-
-
-
-
-
-
31.000
â†“(-31.000)
2022/08/10 æ±º13.000
-
1.800
-
1.800
-
-
1.315
-
101.810
-
31.000
â†’
2022/11/11 æ±º13.000
â†’
1.800
â†’
1.800
â†’
-
1.315
â†’
101.810
â†’
31.000
â†’
2023/02/10 æ±º13.390
â†‘(+0.390)
1.230
â†“(-0.570)
1.150
â†“(-0.650)
-
0.770
â†“(-0.545)
59.600
â†“(-42.210)
31.000
â†’
2023/05/12 å®Ÿ13.456
â†‘(+0.066)
1.204
â†“(-0.026)
1.140
â†“(-0.010)
1.236
-
0.826
â†‘(+0.056)
63.930
â†‘(+4.330)
31.000
â†’
Delta from Initial Guidanceâ†‘(+0.456)
â†“(-0.596)
â†“(-0.660)
-
â†“(-0.489)
â†“(-139.690)
â†“(-31.000)
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/05/14 æ±º10.000
-
0.930
-
0.930
-
-
0.630
-
97.760
-
20.000
-
2021/08/06 æ±º10.000
â†’
0.930
â†’
0.930
â†’
-
0.630
â†’
97.760
â†’
20.000
â†’
2021/11/12 æ±º10.000
â†’
0.930
â†’
0.930
â†’
-
0.630
â†’
97.760
â†’
20.000
â†’
2022/02/10 æ±º11.770
â†‘(+1.770)
1.700
â†‘(+0.770)
1.710
â†‘(+0.780)
-
1.150
â†‘(+0.520)
178.300
â†‘(+80.540)
40.000
â†‘(+20.000)
2022/05/13 å®Ÿ11.566
â†“(-0.204)
1.517
â†“(-0.183)
1.544
â†“(-0.166)
1.582
-
1.070
â†“(-0.080)
82.960
â†“(-95.340)
40.000
â†’
Delta from Initial Guidanceâ†‘(+1.566)
â†‘(+0.587)
â†‘(+0.614)
-
â†‘(+0.440)
â†“(-14.800)
â†‘(+20.000)
FY 2021.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2020/05/15 æ±º-
-
-
-
-
-
20.000
-
2020/08/07 æ±º-
-
-
-
-
-
20.000
â†’
2020/09/11 ä¿®8.600
-
0.430
-
0.420
-
-
0.290
-
44.850
-
-
2020/11/13 æ±º8.600
-
0.430
-
0.420
-
-
0.290
-
44.850
-
20.000
-
2021/02/10 ä¿®9.160
-
0.715
-
0.710
-
-
0.490
-
75.790
-
-
2021/02/10 æ±º9.160
-
0.715
-
0.710
-
-
0.490
-
75.790
-
20.000
-
2021/05/11 ä¿®9.480
-
0.915
-
0.920
-
-
0.680
-
105.230
-
-
2021/05/14 å®Ÿ9.486
-
0.919
-
0.921
-
0.962
-
0.683
-
105.760
-
20.000
-
Delta from Initial Guidance-
-
-
-
-
-
â†’
"""

# --- ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆæ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_2428 = """
FY 2026.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/08/08 æ±º11.500
-
1.680
-
1.700
-
-
1.100
-
58.550
-
29.500
-
FY 2025.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/08/14 æ±º12.000
-
-
1.500
-
-
1.000
-
52.910
-
26.460
-
2024/10/30 æ±º12.000
â†’
-
1.500
â†’
-
1.000
â†’
52.910
â†’
26.460
â†’
2025/01/31 æ±º12.000
â†’
-
1.500
â†’
-
1.000
â†’
52.910
â†’
26.460
â†’
2025/02/14 æ±º12.000
â†’
-
1.500
â†’
-
1.000
â†’
52.910
â†’
26.460
â†’
2025/04/30 æ±º10.800
â†“(-1.200)
-
1.600
â†‘(+0.100)
-
1.050
â†‘(+0.050)
56.000
â†‘(+3.090)
28.000
â†‘(+1.540)
2025/08/08 å®Ÿ10.919
â†‘(+0.119)
1.502
-
1.665
â†‘(+0.065)
1.596
-
1.077
â†‘(+0.027)
57.560
â†‘(+1.560)
29.000
â†‘(+1.000)
Delta from Initial Guidanceâ†“(-1.081)
-
â†‘(+0.165)
-
â†‘(+0.077)
â†‘(+4.650)
â†‘(+2.540)
FY 2024.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/08/14 æ±º10.160
-
-
1.150
-
-
0.790
-
41.860
-
21.000
-
2023/10/30 æ±º10.160
â†’
-
1.150
â†’
-
0.790
â†’
41.860
â†’
21.000
â†’
2024/02/02 æ±º10.160
â†’
-
1.150
â†’
-
0.790
â†’
41.860
â†’
21.000
â†’
2024/05/08 æ±º10.160
â†’
-
1.150
â†’
-
0.790
â†’
41.860
â†’
21.000
â†’
2024/08/14 å®Ÿ10.132
â†“(-0.028)
1.222
-
1.224
â†‘(+0.074)
1.224
-
0.836
â†‘(+0.046)
44.290
â†‘(+2.430)
22.150
â†‘(+1.150)
Delta from Initial Guidanceâ†“(-0.028)
-
â†‘(+0.074)
-
â†‘(+0.046)
â†‘(+2.430)
â†‘(+1.150)
FY 2023.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/09/06 ä¿®9.300
-
-
0.860
-
-
0.600
-
31.830
-
16.000
-
2022/10/31 æ±º9.300
â†’
-
0.860
â†’
-
0.600
â†’
31.830
â†’
16.000
â†’
2023/02/03 æ±º9.300
â†’
-
0.860
â†’
-
0.600
â†’
31.830
â†’
16.000
â†’
2023/05/08 ä¿®9.400
â†‘(+0.100)
-
0.920
â†‘(+0.060)
-
0.620
â†‘(+0.020)
32.850
â†‘(+1.020)
16.430
â†‘(+0.430)
2023/05/08 æ±º9.400
â†’
-
0.920
â†’
-
0.620
â†’
32.850
â†’
16.430
â†’
2023/08/14 å®Ÿ9.424
â†‘(+0.024)
0.939
-
0.936
â†‘(+0.016)
0.962
-
0.635
â†‘(+0.015)
33.680
â†‘(+0.830)
16.840
â†‘(+0.410)
Delta from Initial Guidanceâ†‘(+0.124)
-
â†‘(+0.076)
-
â†‘(+0.035)
â†‘(+1.850)
â†‘(+0.840)
"""

# --- æœ¨æ‘å·¥æ©Ÿæ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_6231 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/14 æ±º16.900
-
3.780
-
3.750
-
-
2.615
-
733.890
-
140.000
-
2025/08/08 æ±º16.900
â†’
3.780
â†’
3.750
â†’
-
2.615
â†’
733.890
â†’
140.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/10 æ±º15.000
-
3.110
-
3.115
-
-
2.105
-
588.510
-
90.000
-
2024/08/09 æ±º15.000
â†’
3.110
â†’
3.115
â†’
-
2.105
â†’
588.510
â†’
90.000
â†’
2024/11/08 æ±º15.000
â†’
3.110
â†’
3.115
â†’
-
2.105
â†’
588.510
â†’
90.000
â†’
2025/02/14 æ±º15.500
â†‘(+0.500)
3.305
â†‘(+0.195)
3.285
â†‘(+0.170)
-
2.230
â†‘(+0.125)
624.450
â†‘(+35.940)
120.000
â†‘(+30.000)
2025/05/14 å®Ÿ16.042
â†‘(+0.542)
3.676
â†‘(+0.371)
3.660
â†‘(+0.375)
3.575
-
2.496
â†‘(+0.266)
699.000
â†‘(+74.550)
120.000
â†’
Delta from Initial Guidanceâ†‘(+1.042)
â†‘(+0.566)
â†‘(+0.545)
-
â†‘(+0.391)
â†‘(+110.490)
â†‘(+30.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/12 æ±º12.400
-
1.580
-
1.570
-
-
1.070
-
298.270
-
40.000
-
2023/08/08 æ±º12.400
â†’
1.580
â†’
1.570
â†’
-
1.070
â†’
298.270
â†’
40.000
â†’
2023/11/10 æ±º13.000
â†‘(+0.600)
2.430
â†‘(+0.850)
2.410
â†‘(+0.840)
-
1.690
â†‘(+0.620)
472.170
â†‘(+173.900)
65.000
â†‘(+25.000)
2024/02/09 æ±º13.000
â†’
2.430
â†’
2.410
â†’
-
1.690
â†’
472.090
â†“(-0.080)
65.000
â†’
2024/03/08 ä¿®13.800
â†‘(+0.800)
2.635
â†‘(+0.205)
2.640
â†‘(+0.230)
-
1.850
â†‘(+0.160)
516.780
â†‘(+44.690)
90.000
â†‘(+25.000)
2024/05/10 å®Ÿ13.853
â†‘(+0.053)
2.679
â†‘(+0.044)
2.683
â†‘(+0.043)
2.682
-
2.065
â†‘(+0.215)
576.990
â†‘(+60.210)
90.000
â†’
Delta from Initial Guidanceâ†‘(+1.453)
â†‘(+1.099)
â†‘(+1.113)
-
â†‘(+0.995)
â†‘(+278.720)
â†‘(+50.000)
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/13 æ±º11.400
-
1.200
-
1.150
-
-
0.710
-
191.670
-
25.000
-
2022/08/10 æ±º11.400
â†’
1.200
â†’
1.150
â†’
-
0.710
â†’
193.120
â†‘(+1.450)
25.000
â†’
2022/11/11 æ±º11.400
â†’
1.200
â†’
1.150
â†’
-
0.710
â†’
195.190
â†‘(+2.070)
25.000
â†’
2023/02/10 æ±º11.400
â†’
1.200
â†’
1.150
â†’
-
0.710
â†’
195.540
â†‘(+0.350)
25.000
â†’
2023/04/14 ä¿®11.700
â†‘(+0.300)
1.520
â†‘(+0.320)
1.510
â†‘(+0.360)
-
0.930
â†‘(+0.220)
256.130
â†‘(+60.590)
-
2023/05/12 å®Ÿ11.703
â†‘(+0.003)
1.573
â†‘(+0.053)
1.568
â†‘(+0.058)
1.427
-
1.037
â†‘(+0.107)
285.640
â†‘(+29.510)
40.000
-
Delta from Initial Guidanceâ†‘(+0.303)
â†‘(+0.373)
â†‘(+0.418)
-
â†‘(+0.327)
â†‘(+93.970)
â†‘(+15.000)
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/05/14 æ±º11.000
-
1.390
-
1.355
-
-
0.900
-
237.750
-
25.000
-
2021/08/11 æ±º11.000
â†’
1.390
â†’
1.355
â†’
-
0.900
â†’
239.050
â†‘(+1.300)
25.000
â†’
2021/11/12 æ±º11.000
â†’
1.390
â†’
1.355
â†’
-
0.900
â†’
239.530
â†‘(+0.480)
25.000
â†’
2022/02/10 æ±º11.000
â†’
1.390
â†’
1.355
â†’
-
0.900
â†’
239.770
â†‘(+0.240)
25.000
â†’
2022/05/13 å®Ÿ10.200
â†“(-0.800)
1.089
â†“(-0.301)
1.331
â†“(-0.024)
1.294
-
0.877
â†“(-0.023)
234.020
â†“(-5.750)
25.000
â†’
Delta from Initial Guidanceâ†“(-0.800)
â†“(-0.301)
â†“(-0.024)
-
â†“(-0.023)
â†“(-3.730)
â†’
FY 2021.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2020/08/07 æ±º10.800
-
1.345
-
1.315
-
-
0.900
-
235.270
-
25.000
-
2020/11/13 æ±º10.800
â†’
1.345
â†’
1.315
â†’
-
0.900
â†’
235.270
â†’
25.000
â†’
2021/02/12 æ±º10.800
â†’
1.345
â†’
1.315
â†’
-
0.900
â†’
235.270
â†’
25.000
â†’
2021/05/14 å®Ÿ10.526
â†“(-0.274)
1.399
â†‘(+0.054)
1.411
â†‘(+0.096)
1.401
-
0.960
â†‘(+0.060)
251.170
â†‘(+15.900)
25.000
â†’
Delta from Initial Guidanceâ†“(-0.274)
â†‘(+0.054)
â†‘(+0.096)
-
â†‘(+0.060)
â†‘(+15.900)
â†’
"""

# --- æ—¥æœ¬é›»å­ææ–™æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_6855 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/05/14 æ±º25.500
-
3.750
-
3.650
-
-
2.500
-
197.920
-
50.000
-
2025/08/07 æ±º25.500
â†’
3.750
â†’
3.650
â†’
-
2.500
â†’
197.920
â†’
50.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/05/14 æ±º21.000
-
2.400
-
2.200
-
-
1.600
-
126.750
-
40.000
-
2024/09/25 ä¿®20.600
â†“(-0.400)
3.600
â†‘(+1.200)
3.400
â†‘(+1.200)
-
2.400
â†‘(+0.800)
190.020
â†‘(+63.270)
55.000
â†‘(+15.000)
2024/11/08 æ±º20.600
â†’
3.600
â†’
3.400
â†’
-
2.400
â†’
190.020
â†’
55.000
â†’
2025/02/07 æ±º20.600
â†’
3.600
â†’
3.400
â†’
-
2.400
â†’
190.020
â†’
55.000
â†’
2025/05/14 å®Ÿ23.829
â†‘(+3.229)
4.585
â†‘(+0.985)
4.640
â†‘(+1.240)
4.627
-
3.454
â†‘(+1.054)
273.530
â†‘(+83.510)
70.000
â†‘(+15.000)
Delta from Initial Guidanceâ†‘(+2.829)
â†‘(+2.185)
â†‘(+2.440)
-
â†‘(+1.854)
â†‘(+146.780)
â†‘(+30.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/05/15 æ±º17.000
-
1.900
-
1.900
-
-
1.400
-
111.080
-
40.000
-
2023/08/08 æ±º17.000
â†’
1.900
â†’
1.900
â†’
-
1.400
â†’
111.080
â†’
40.000
â†’
2023/09/26 ä¿®16.100
â†“(-0.900)
0.300
â†“(-1.600)
0.500
â†“(-1.400)
-
0.390
â†“(-1.010)
30.900
â†“(-80.180)
-
2023/11/09 æ±º16.100
â†’
0.300
â†’
0.500
â†’
-
0.390
â†’
30.900
â†’
40.000
-
2024/02/08 æ±º16.100
â†’
0.300
â†’
0.500
â†’
-
0.390
â†’
30.900
â†’
40.000
â†’
2024/05/14 å®Ÿ17.461
â†‘(+1.361)
0.870
â†‘(+0.570)
1.007
â†‘(+0.507)
1.007
-
0.622
â†‘(+0.232)
49.320
â†‘(+18.420)
40.000
â†’
Delta from Initial Guidanceâ†‘(+0.461)
â†“(-1.030)
â†“(-0.893)
-
â†“(-0.778)
â†“(-61.760)
â†’
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/05/12 æ±º24.000
-
3.600
-
3.600
-
-
2.600
-
212.750
-
40.000
-
2022/08/05 æ±º24.000
â†’
3.600
â†’
3.600
â†’
-
2.600
â†’
212.750
â†’
40.000
â†’
2022/09/22 ä¿®21.400
â†“(-2.600)
2.900
â†“(-0.700)
3.100
â†“(-0.500)
-
2.100
â†“(-0.500)
166.540
â†“(-46.210)
-
2022/11/09 æ±º21.400
â†’
2.900
â†’
3.100
â†’
-
2.100
â†’
166.540
â†’
40.000
-
2023/02/08 æ±º21.400
â†’
2.900
â†’
3.100
â†’
-
2.100
â†’
166.540
â†’
40.000
â†’
2023/05/15 å®Ÿ20.781
â†“(-0.619)
3.205
â†‘(+0.305)
3.338
â†‘(+0.238)
3.465
-
2.612
â†‘(+0.512)
207.250
â†‘(+40.710)
40.000
â†’
Delta from Initial Guidanceâ†“(-3.219)
â†“(-0.395)
â†“(-0.262)
-
â†‘(+0.012)
â†“(-5.500)
â†’
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/05/12 æ±º20.000
-
2.800
-
2.700
-
-
2.300
-
191.110
-
20.000
-
2021/08/06 æ±º20.000
â†’
2.800
â†’
2.700
â†’
-
2.300
â†’
191.110
â†’
20.000
â†’
2021/11/09 æ±º21.126
â†‘(+1.126)
4.211
â†‘(+1.411)
4.244
â†‘(+1.544)
-
3.045
â†‘(+0.745)
253.530
â†‘(+62.420)
40.000
â†‘(+20.000)
2022/02/08 æ±º21.126
â†’
4.211
â†’
4.244
â†’
-
3.045
â†’
251.650
â†“(-1.880)
40.000
â†’
2022/05/12 å®Ÿ23.599
â†‘(+2.473)
4.953
â†‘(+0.742)
5.092
â†‘(+0.848)
5.092
-
3.802
â†‘(+0.757)
311.170
â†‘(+59.520)
40.000
â†’
Delta from Initial Guidanceâ†‘(+3.599)
â†‘(+2.153)
â†‘(+2.392)
-
â†‘(+1.502)
â†‘(+120.060)
â†‘(+20.000)
"""

# --- JFEã‚·ã‚¹ãƒ†ãƒ ã‚ºæ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_4832 = """
FY 2026.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/04/25 æ±º58.620
-
6.300
-
6.400
-
-
4.260
-
135.630
-
68.000
-
2025/07/29 æ±º58.620
â†’
6.300
â†’
6.400
â†’
-
4.260
â†’
135.630
â†’
68.000
â†’
FY 2025.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/04/25 æ±º62.130
-
6.640
-
6.700
-
-
4.550
-
289.720
-
102.000
-
2024/07/26 æ±º62.130
â†’
6.640
â†’
6.700
â†’
-
4.550
â†’
289.720
â†’
102.000
â†’
2024/10/29 æ±º62.130
â†’
6.640
â†’
6.700
â†’
-
4.550
â†’
289.720
â†’
102.000
â†’
2025/01/28 æ±º64.000
â†‘(+1.870)
7.340
â†‘(+0.700)
7.400
â†‘(+0.700)
-
5.140
â†‘(+0.590)
327.290
â†‘(+37.570)
115.000
â†‘(+13.000)
2025/04/25 å®Ÿ58.235
â†“(-5.765)
6.575
â†“(-0.765)
6.808
â†“(-0.592)
7.667
-
5.442
â†‘(+0.302)
173.270
â†“(-154.020)
122.000
â†‘(+7.000)
Delta from Initial Guidanceâ†“(-3.895)
â†“(-0.065)
â†‘(+0.108)
-
â†‘(+0.892)
â†“(-116.450)
â†‘(+20.000)
FY 2024.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/04/27 æ±º57.000
-
6.050
-
6.100
-
-
4.150
-
264.250
-
92.000
-
2023/07/26 æ±º57.000
â†’
6.050
â†’
6.100
â†’
-
4.150
â†’
264.250
â†’
102.000
â†‘(+10.000)
2023/10/26 æ±º61.300
â†‘(+4.300)
6.955
â†‘(+0.905)
7.000
â†‘(+0.900)
-
4.730
â†‘(+0.580)
301.180
â†‘(+36.930)
118.000
â†‘(+16.000)
2024/01/26 æ±º61.300
â†’
6.955
â†’
7.000
â†’
-
4.730
â†’
301.180
â†’
118.000
â†’
2024/04/25 å®Ÿ56.696
â†“(-4.604)
6.529
â†“(-0.426)
6.749
â†“(-0.251)
7.452
-
4.969
â†‘(+0.239)
158.180
â†“(-143.000)
121.000
â†‘(+3.000)
Delta from Initial Guidanceâ†“(-0.304)
â†‘(+0.479)
â†‘(+0.649)
-
â†‘(+0.819)
â†“(-106.070)
â†‘(+29.000)
FY 2023.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/04/26 æ±º54.000
-
5.670
-
5.700
-
-
3.740
-
238.140
-
85.000
-
2022/07/26 æ±º54.000
â†’
5.670
â†’
5.700
â†’
-
3.740
â†’
238.140
â†’
85.000
â†’
2022/10/26 æ±º55.000
â†‘(+1.000)
5.670
â†’
5.700
â†’
-
3.740
â†’
238.140
â†’
85.000
â†’
2023/01/26 æ±º55.000
â†’
6.070
â†‘(+0.400)
6.100
â†‘(+0.400)
-
4.100
â†‘(+0.360)
261.060
â†‘(+22.920)
90.000
â†‘(+5.000)
2023/04/27 å®Ÿ51.617
â†“(-3.383)
5.424
â†“(-0.646)
5.612
â†“(-0.488)
6.282
-
4.323
â†‘(+0.223)
275.290
â†‘(+14.230)
97.000
â†‘(+7.000)
Delta from Initial Guidanceâ†“(-2.383)
â†“(-0.246)
â†“(-0.088)
-
â†‘(+0.583)
â†‘(+37.150)
â†‘(+12.000)
FY 2022.03å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/04/26 æ±º48.000
-
4.760
-
4.800
-
-
3.100
-
197.390
-
60.000
-
2021/07/27 æ±º48.000
â†’
4.760
â†’
4.800
â†’
-
3.100
â†’
197.390
â†’
60.000
â†’
2021/10/27 æ±º51.000
â†‘(+3.000)
5.270
â†‘(+0.510)
5.300
â†‘(+0.500)
-
3.500
â†‘(+0.400)
222.860
â†‘(+25.470)
75.000
â†‘(+15.000)
2022/01/26 æ±º51.000
â†’
5.470
â†‘(+0.200)
5.500
â†‘(+0.200)
-
3.640
â†‘(+0.140)
231.770
â†‘(+8.910)
75.000
â†’
2022/04/26 å®Ÿ46.357
â†“(-4.643)
4.983
â†“(-0.487)
5.111
â†“(-0.389)
5.644
-
3.724
â†‘(+0.084)
237.120
â†‘(+5.350)
75.000
â†’
Delta from Initial Guidanceâ†“(-1.643)
â†‘(+0.223)
â†‘(+0.311)
-
â†‘(+0.624)
â†‘(+39.730)
â†‘(+15.000)
"""

# --- ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ ---
FORECAST_TEXT_4767 = """
-å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2019/12/13 ä¿®-
-
-
-
-
-
31.500
-
FY 2026.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2025/08/07 æ±º18.800
-
2.208
-
2.250
-
-
1.500
-
36.590
-
18.300
-
FY 2025.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2024/08/08 æ±º18.000
-
2.120
-
2.150
-
-
1.428
-
35.170
-
15.000
-
2024/11/14 æ±º18.000
â†’
2.120
â†’
2.150
â†’
-
1.428
â†’
35.170
â†’
15.000
â†’
2025/02/13 æ±º18.000
â†’
2.120
â†’
2.150
â†’
-
1.428
â†’
35.170
â†’
15.000
â†’
2025/05/15 æ±º18.000
â†’
2.120
â†’
2.150
â†’
-
1.428
â†’
35.170
â†’
15.000
â†’
2025/08/07 å®Ÿ17.783
â†“(-0.217)
2.153
â†‘(+0.033)
2.194
â†‘(+0.044)
1.611
-
1.132
â†“(-0.296)
27.720
â†“(-7.450)
15.000
â†’
Delta from Initial Guidanceâ†“(-0.217)
â†‘(+0.033)
â†‘(+0.044)
-
â†“(-0.296)
â†“(-7.450)
â†’
FY 2024.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2023/08/09 æ±º14.000
-
1.370
-
1.400
-
-
0.915
-
22.740
-
14.000
-
2024/02/08 ä¿®16.000
â†‘(+2.000)
1.748
â†‘(+0.378)
1.777
â†‘(+0.377)
-
1.172
â†‘(+0.257)
28.950
â†‘(+6.210)
-
2024/02/08 æ±º16.000
â†’
1.748
â†’
1.777
â†’
-
1.172
â†’
28.950
â†’
14.000
-
2024/05/15 æ±º16.000
â†’
1.748
â†’
1.777
â†’
-
1.172
â†’
28.950
â†’
14.000
â†’
2024/06/14 ä¿®17.300
â†‘(+1.300)
1.920
â†‘(+0.172)
1.950
â†‘(+0.173)
-
1.267
â†‘(+0.095)
31.300
â†‘(+2.350)
-
2024/08/08 å®Ÿ17.504
â†‘(+0.204)
2.007
â†‘(+0.087)
2.058
â†‘(+0.108)
2.055
-
1.406
â†‘(+0.139)
34.710
â†‘(+3.410)
14.000
-
Delta from Initial Guidanceâ†‘(+3.504)
â†‘(+0.637)
â†‘(+0.658)
-
â†‘(+0.491)
â†‘(+11.970)
â†’
FY 2023.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2022/08/09 æ±º11.700
-
0.992
-
1.015
-
-
0.174
-
3.855
-
14.400
-
2022/11/14 æ±º11.700
â†’
0.992
â†’
1.015
â†’
-
0.174
â†’
3.855
â†’
14.400
â†’
2023/02/08 ä¿®12.000
â†‘(+0.300)
1.076
â†‘(+0.084)
1.100
â†‘(+0.085)
-
0.289
â†‘(+0.115)
7.010
â†‘(+3.155)
-
2023/02/08 æ±º12.000
â†’
1.076
â†’
1.100
â†’
-
0.289
â†’
7.010
â†’
14.400
-
2023/05/15 æ±º12.000
â†’
1.076
â†’
1.100
â†’
-
0.289
â†’
7.010
â†’
14.400
â†’
2023/08/09 å®Ÿ11.774
â†“(-0.226)
1.151
â†‘(+0.075)
1.179
â†‘(+0.079)
0.554
-
0.356
â†‘(+0.067)
8.610
â†‘(+1.600)
14.400
â†’
Delta from Initial Guidanceâ†‘(+0.074)
â†‘(+0.159)
â†‘(+0.164)
-
â†‘(+0.182)
â†‘(+4.755)
â†’
FY 2022.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/08/10 æ±º12.339
-
0.967
-
1.000
-
-
0.622
-
13.830
-
14.000
-
2021/11/12 æ±º12.339
â†’
0.967
â†’
1.000
â†’
-
0.622
â†’
13.830
â†’
14.000
â†’
2022/02/08 æ±º12.339
â†’
0.967
â†’
1.000
â†’
-
0.622
â†’
13.830
â†’
14.000
â†’
2022/05/13 æ±º12.339
â†’
0.967
â†’
1.000
â†’
-
0.622
â†’
13.830
â†’
14.000
â†’
2022/06/15 ä¿®11.051
â†“(-1.288)
0.801
â†“(-0.166)
0.841
â†“(-0.159)
-
0.543
â†“(-0.079)
12.020
â†“(-1.810)
-
2022/08/09 å®Ÿ11.134
â†‘(+0.083)
0.884
â†‘(+0.083)
0.924
â†‘(+0.083)
0.927
-
0.598
â†‘(+0.055)
13.220
â†‘(+1.200)
14.000
-
Delta from Initial Guidanceâ†“(-1.205)
â†“(-0.083)
â†“(-0.076)
-
â†“(-0.024)
â†“(-0.610)
â†’
FY 2021.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2021/02/08 ä¿®11.644
-
0.224
-
0.262
-
-
0.158
-
3.530
-
12.900
-
2021/02/08 æ±º11.644
â†’
0.224
â†’
0.262
â†’
-
0.158
â†’
3.530
â†’
12.900
â†’
2021/05/14 ä¿®11.726
â†‘(+0.082)
0.384
â†‘(+0.160)
0.426
â†‘(+0.164)
-
0.269
â†‘(+0.111)
5.990
â†‘(+2.460)
-
2021/05/14 æ±º11.726
â†’
0.384
â†’
0.426
â†’
-
0.269
â†’
5.990
â†’
12.900
-
2021/06/24 ä¿®12.069
â†‘(+0.343)
0.558
â†‘(+0.174)
0.600
â†‘(+0.174)
-
0.387
â†‘(+0.118)
8.630
â†‘(+2.640)
-
2021/08/10 å®Ÿ12.209
â†‘(+0.140)
0.656
â†‘(+0.098)
0.699
â†‘(+0.099)
0.711
-
0.456
â†‘(+0.069)
10.140
â†‘(+1.510)
12.900
-
Delta from Initial Guidanceâ†‘(+0.565)
â†‘(+0.432)
â†‘(+0.437)
-
â†‘(+0.298)
â†‘(+6.610)
â†’
FY 2020.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2019/08/08 æ±º16.829
-
2.040
-
2.040
-
-
1.352
-
60.200
-
30.000
-
2019/11/08 æ±º16.829
â†’
2.040
â†’
2.040
â†’
-
1.352
â†’
60.200
â†’
30.000
â†’
2019/12/13 ä¿®17.424
â†‘(+0.595)
2.102
â†‘(+0.062)
2.115
â†‘(+0.075)
-
1.407
â†‘(+0.055)
62.620
â†‘(+2.420)
-
2020/02/06 æ±º17.424
â†’
2.102
â†’
2.115
â†’
-
1.407
â†’
62.620
â†’
31.500
-
2020/05/15 æ±º17.424
â†’
2.102
â†’
2.115
â†’
-
1.407
â†’
31.310
â†“(-31.310)
24.000
â†“(-7.500)
2020/06/15 ä¿®19.360
â†‘(+1.936)
2.212
â†‘(+0.110)
2.226
â†‘(+0.111)
-
1.486
â†‘(+0.079)
33.070
â†‘(+1.760)
-
2020/08/06 å®Ÿ19.326
â†“(-0.034)
2.317
â†‘(+0.105)
2.333
â†‘(+0.107)
2.339
-
1.585
â†‘(+0.099)
35.260
â†‘(+2.190)
25.000
-
Delta from Initial Guidanceâ†‘(+2.497)
â†‘(+0.277)
â†‘(+0.293)
-
â†‘(+0.233)
â†“(-24.940)
â†“(-5.000)
FY 2019.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2018/08/08 æ±º15.436
-
1.700
-
1.714
-
-
1.129
-
50.280
-
26.000
-
2018/11/09 æ±º15.436
â†’
1.700
â†’
1.714
â†’
-
1.129
â†’
50.280
â†’
26.000
â†’
2019/02/07 æ±º15.436
â†’
1.700
â†’
1.714
â†’
-
1.129
â†’
50.280
â†’
26.000
â†’
2019/05/10 ä¿®-
-
-
-
-
-
28.000
â†‘(+2.000)
2019/05/10 æ±º15.436
-
1.700
-
1.714
-
-
1.129
-
50.280
-
28.000
â†’
2019/06/14 ä¿®16.068
â†‘(+0.632)
1.939
â†‘(+0.239)
1.958
â†‘(+0.244)
-
1.296
â†‘(+0.167)
57.700
â†‘(+7.420)
-
2019/08/08 å®Ÿ16.279
â†‘(+0.211)
1.996
â†‘(+0.057)
2.017
â†‘(+0.059)
2.014
-
1.345
â†‘(+0.049)
29.940
â†“(-27.760)
29.000
-
Delta from Initial Guidanceâ†‘(+0.843)
â†‘(+0.296)
â†‘(+0.303)
-
â†‘(+0.216)
â†“(-20.340)
â†‘(+3.000)
FY 2018.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2017/08/08 æ±º16.673
-
1.851
-
1.851
-
-
1.175
-
52.300
-
-
2017/11/14 æ±º16.673
â†’
1.851
â†’
1.851
â†’
-
1.175
â†’
52.300
â†’
27.000
-
2018/02/08 æ±º16.673
â†’
1.851
â†’
1.851
â†’
-
1.175
â†’
52.300
â†’
27.000
-
2018/05/10 æ±º16.673
â†’
1.851
â†’
1.851
â†’
-
1.175
â†’
52.300
â†’
27.000
-
2018/08/08 å®Ÿ16.689
â†‘(+0.016)
1.826
â†“(-0.025)
1.873
â†‘(+0.022)
1.874
-
1.208
â†‘(+0.033)
53.750
â†‘(+1.450)
27.000
-
Delta from Initial Guidanceâ†‘(+0.016)
â†“(-0.025)
â†‘(+0.022)
-
â†‘(+0.033)
â†‘(+1.450)
-
FY 2017.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2016/08/08 æ±º16.032
-
1.793
-
1.792
-
-
1.185
-
52.920
-
-
2016/11/10 æ±º16.032
â†’
1.793
â†’
1.792
â†’
-
1.185
â†’
52.920
â†’
-
2017/02/09 æ±º16.032
â†’
1.793
â†’
1.792
â†’
-
1.185
â†’
52.820
â†“(-0.100)
-
2017/05/10 æ±º16.032
â†’
1.793
â†’
1.792
â†’
-
1.185
â†’
52.820
â†’
-
2017/08/08 å®Ÿ16.251
â†‘(+0.219)
1.812
â†‘(+0.019)
1.823
â†‘(+0.031)
1.820
-
1.207
â†‘(+0.022)
53.740
â†‘(+0.920)
26.000
-
Delta from Initial Guidanceâ†‘(+0.219)
â†‘(+0.019)
â†‘(+0.031)
-
â†‘(+0.022)
â†‘(+0.820)
-
FY 2016.06å£²ä¸Š Î”å–¶åˆ© Î”çµŒåˆ© Î”ç¨å‰åˆ© Î”ç´”åˆ© Î”ä¸€æ ªç›Š Î”ä¸€æ ªé… Î”2016/05/10 æ±º15.119
-
1.579
-
1.583
-
-
1.012
-
45.200
-
-
2016/08/08 å®Ÿ15.230
â†‘(+0.111)
1.678
â†‘(+0.099)
1.682
â†‘(+0.099)
-
1.083
â†‘(+0.071)
48.350
â†‘(+3.150)
-
Delta from Initial Guidanceâ†‘(+0.111)
â†‘(+0.099)
â†‘(+0.099)
-
â†‘(+0.071)
â†‘(+3.150)
-
"""

def calculate_rsi(df, window=14):
    """RSIã‚’è¨ˆç®—"""
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=window).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=window).mean()
    rs = gain / loss.replace(0, np.nan)
    df['RSI'] = 100 - (100 / (1 + rs))
    return df

def create_candlestick_chart(df, ticker_symbol, company_name):
    """ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    fig = go.Figure()
    
    try:
        if not df.empty and all(col in df.columns for col in ['Open', 'High', 'Low', 'Close']):
            fig.add_trace(go.Candlestick(
                x=df.index, 
                open=df['Open'], 
                high=df['High'], 
                low=df['Low'], 
                close=df['Close'], 
                name='ãƒ­ãƒ¼ã‚½ã‚¯è¶³',
                increasing_line_color='red',
                decreasing_line_color='blue'
            ))
        else:
            fig.add_trace(go.Scatter(
                x=df.index, 
                y=df['Close'], 
                mode='lines', 
                name='çµ‚å€¤', 
                line=dict(color='black', width=2)
            ))
    except Exception as e:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['Close'], 
            mode='lines', 
            name='çµ‚å€¤', 
            line=dict(color='black', width=2)
        ))
    
    # ç§»å‹•å¹³å‡ç·šã‚’è¿½åŠ 
    if 'MA20' in df.columns:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['MA20'], 
            mode='lines', 
            name='MA20',
            line=dict(color='orange', width=1)
        ))
    
    if 'MA50' in df.columns:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['MA50'], 
            mode='lines', 
            name='MA50',
            line=dict(color='purple', width=1)
        ))
    
    fig.update_layout(
        title=f'{company_name} ({ticker_symbol}) ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆ',
        yaxis_title='ä¾¡æ ¼ (Â¥)',
        xaxis_title='æ—¥ä»˜'
    )
    
    return fig

def create_rsi_chart(df, ticker_symbol):
    """RSIãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    fig = go.Figure()
    
    if 'RSI' in df.columns:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['RSI'], 
            mode='lines', 
            name='RSI',
            line=dict(color='blue', width=2)
        ))
        
        # RSIã®æ°´å¹³ç·šã‚’è¿½åŠ 
        fig.add_hline(y=70, line_dash="dash", line_color="red", annotation_text="å£²ã‚‰ã‚Œã™ã")
        fig.add_hline(y=30, line_dash="dash", line_color="green", annotation_text="è²·ã‚ã‚Œã™ã")
    
    fig.update_layout(
        title=f'{ticker_symbol} RSI (14æ—¥é–“)', 
        yaxis_title='RSI', 
        yaxis=dict(range=[0, 100])
    )
    
    return fig

def get_japanese_company_name(ticker, ticker_info):
    """æ—¥æœ¬èªä¼æ¥­åã‚’å–å¾—ã™ã‚‹é–¢æ•°"""
    if ticker in JAPANESE_COMPANY_NAMES:
        return JAPANESE_COMPANY_NAMES[ticker]
    else:
        return ticker_info.get('longName', ticker)

def analyze_price_movement_factors(stock_data, fundamental_data, ticker):
    """æ ªä¾¡å¤‰å‹•ã®è¦å› ã‚’åˆ†æã™ã‚‹é–¢æ•°"""
    analysis_results = []
    
    if stock_data.empty:
        return analysis_results
    
    # æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬çµ±è¨ˆ
    stock_data = stock_data.copy()
    stock_data['Returns'] = stock_data['Close'].pct_change()
    stock_data['MA20'] = stock_data['Close'].rolling(window=20).mean()
    stock_data['MA50'] = stock_data['Close'].rolling(window=50).mean()
    
    # å¤§ããªä¾¡æ ¼å¤‰å‹•ã‚’ç‰¹å®šï¼ˆ5%ä»¥ä¸Šã®å¤‰å‹•ï¼‰
    significant_moves = stock_data[abs(stock_data['Returns']) > 0.05].copy()
    
    if not significant_moves.empty:
        # æœ€è¿‘ã®å¤§ããªå¤‰å‹•ã‚’åˆ†æ
        recent_moves = significant_moves.tail(10)
        
        for date, row in recent_moves.iterrows():
            move_type = "ä¸Šæ˜‡" if row['Returns'].item() > 0 else "ä¸‹è½"
            move_pct = row['Returns'].item() * 100
            
            # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› ã®åˆ†æ
            technical_factors = []
            
            # ç§»å‹•å¹³å‡ç·šã¨ã®é–¢ä¿‚
            if row['Close'].item() > row['MA20'].item() and row['Close'].item() > row['MA50'].item():
                technical_factors.append("ç§»å‹•å¹³å‡ç·šä¸ŠæŠœã‘")
            elif row['Close'].item() < row['MA20'].item() and row['Close'].item() < row['MA50'].item():
                technical_factors.append("ç§»å‹•å¹³å‡ç·šä¸‹æŠœã‘")
            
            # å‡ºæ¥é«˜ã®åˆ†æ
            avg_volume = stock_data['Volume'].rolling(window=20).mean().loc[date]
            if row['Volume'].item() > avg_volume.item() * 1.5:
                technical_factors.append("é«˜å‡ºæ¥é«˜")
            elif row['Volume'].item() < avg_volume.item() * 0.5:
                technical_factors.append("ä½å‡ºæ¥é«˜")
            
            # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› ã®åˆ†æï¼ˆå¯èƒ½ãªå ´åˆï¼‰
            fundamental_factors = []
            if fundamental_data is not None and not fundamental_data.empty:
                # æ¥­ç¸¾ç™ºè¡¨æ™‚æœŸã®ç‰¹å®šï¼ˆå››åŠæœŸæœ«ä»˜è¿‘ï¼‰
                month = date.month
                if month in [3, 6, 9, 12]:
                    fundamental_factors.append("æ±ºç®—ç™ºè¡¨æ™‚æœŸ")
                
                # å£²ä¸Šãƒ»åˆ©ç›Šã®æˆé•·ç‡åˆ†æ
                if 'å£²ä¸Šé«˜' in fundamental_data.columns:
                    latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
                    prev_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-2] if len(fundamental_data) > 1 else latest_revenue
                    revenue_growth = ((latest_revenue - prev_revenue) / prev_revenue) * 100 if prev_revenue > 0 else 0
                    
                    if revenue_growth > 10:
                        fundamental_factors.append("å£²ä¸Šé«˜å¤§å¹…æˆé•·")
                    elif revenue_growth < -10:
                        fundamental_factors.append("å£²ä¸Šé«˜å¤§å¹…æ¸›å°‘")
            
            # éŠ˜æŸ„åˆ¥ã®ç‰¹å¾´çš„ãªè¦å› 
            sector_factors = get_sector_specific_factors(ticker, date, move_type)
            
            analysis_results.append({
                'Date': date.strftime('%Y-%m-%d'),
                'Move_Type': move_type,
                'Move_Percent': f"{move_pct:+.1f}%",
                'Technical_Factors': technical_factors,
                'Fundamental_Factors': fundamental_factors,
                'Sector_Factors': sector_factors,
                'Price': row['Close'].item(),
                'Volume': row['Volume'].item()
            })
    
    return analysis_results

def get_sector_specific_factors(ticker, date, move_type):
    """éŠ˜æŸ„åˆ¥ã®æ¥­ç•Œç‰¹æœ‰ã®è¦å› ã‚’åˆ†æ"""
    factors = []
    
    # å„éŠ˜æŸ„ã®æ¥­ç•Œç‰¹æ€§ã«åŸºã¥ãè¦å› åˆ†æ
    if ticker == '6357.T':  # ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º
        factors.append("è£½é€ æ¥­ï¼šè¨­å‚™æŠ•è³‡å‹•å‘ãƒ»ææ–™ä¾¡æ ¼å¤‰å‹•")
        if move_type == "ä¸Šæ˜‡":
            factors.append("è‡ªå‹•åŒ–éœ€è¦å¢—åŠ ãƒ»è£½é€ æ¥­æ™¯æ°—å›å¾©")
        else:
            factors.append("è¨­å‚™æŠ•è³‡æŠ‘åˆ¶ãƒ»è£½é€ æ¥­æ™¯æ°—æ‚ªåŒ–")
    
    elif ticker == '4816.T':  # æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        factors.append("ã‚¨ãƒ³ã‚¿ãƒ¡æ¥­ç•Œï¼šã‚³ãƒ³ãƒ†ãƒ³ãƒ„äººæ°—ãƒ»é…ä¿¡å‹•å‘")
        if move_type == "ä¸Šæ˜‡":
            factors.append("ãƒ’ãƒƒãƒˆä½œå“ãƒ»æµ·å¤–å±•é–‹æˆåŠŸ")
        else:
            factors.append("ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä¸æŒ¯ãƒ»ç«¶åˆæ¿€åŒ–")
    
    elif ticker == '2991.T':  # ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆ
        factors.append("ä¸å‹•ç”£æ¥­ç•Œï¼šé‡‘åˆ©å‹•å‘ãƒ»ä¸å‹•ç”£å¸‚æ³")
        if move_type == "ä¸Šæ˜‡":
            factors.append("ä¸å‹•ç”£ä¾¡æ ¼ä¸Šæ˜‡ãƒ»å–å¼•æ´»ç™ºåŒ–")
        else:
            factors.append("é‡‘åˆ©ä¸Šæ˜‡ãƒ»ä¸å‹•ç”£å¸‚æ³æ‚ªåŒ–")
    
    elif ticker == '7564.T':  # ãƒ¯ãƒ¼ã‚¯ãƒãƒ³
        factors.append("å°å£²æ¥­ç•Œï¼šæ¶ˆè²»è€…å‹•å‘ãƒ»å­£ç¯€è¦å› ")
        if move_type == "ä¸Šæ˜‡":
            factors.append("ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢éœ€è¦å¢—ãƒ»æ–°å•†å“å¥½èª¿")
        else:
            factors.append("æ¶ˆè²»ä½è¿·ãƒ»ç«¶åˆæ¿€åŒ–")
    
    elif ticker == '7711.T':  # åŠ©å·é›»æ°—å·¥æ¥­
        factors.append("é›»æ°—æ©Ÿå™¨æ¥­ç•Œï¼šè¨­å‚™æŠ•è³‡ãƒ»æŠ€è¡“é©æ–°")
        if move_type == "ä¸Šæ˜‡":
            factors.append("é›»åŠ›ã‚¤ãƒ³ãƒ•ãƒ©æŠ•è³‡ãƒ»æŠ€è¡“é©æ–°")
        else:
            factors.append("è¨­å‚™æŠ•è³‡æŠ‘åˆ¶ãƒ»ç«¶åˆæ¿€åŒ–")
    
    elif ticker == '6405.T':  # éˆ´èŒ‚å™¨å·¥
        factors.append("é£Ÿå“æ©Ÿæ¢°æ¥­ç•Œï¼šå¤–é£Ÿç”£æ¥­å‹•å‘")
        if move_type == "ä¸Šæ˜‡":
            factors.append("å¤–é£Ÿç”£æ¥­å›å¾©ãƒ»è‡ªå‹•åŒ–éœ€è¦")
        else:
            factors.append("å¤–é£Ÿç”£æ¥­ä½è¿·ãƒ»è¨­å‚™æŠ•è³‡æŠ‘åˆ¶")
    
    elif ticker == '2428.T':  # ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆ
        factors.append("æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹æ¥­ç•Œï¼šãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ãƒ»è¦åˆ¶å‹•å‘")
        if move_type == "ä¸Šæ˜‡":
            factors.append("ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹æ™®åŠãƒ»æ–°ã‚µãƒ¼ãƒ“ã‚¹")
        else:
            factors.append("ç«¶åˆæ¿€åŒ–ãƒ»è¦åˆ¶å¼·åŒ–")
    
    elif ticker == '6231.T':  # æœ¨æ‘å·¥æ©Ÿ
        factors.append("ç”£æ¥­æ©Ÿæ¢°æ¥­ç•Œï¼šè£½é€ æ¥­è¨­å‚™æŠ•è³‡")
        if move_type == "ä¸Šæ˜‡":
            factors.append("è£½é€ æ¥­è¨­å‚™æŠ•è³‡å¢—ãƒ»è‡ªå‹•åŒ–éœ€è¦")
        else:
            factors.append("è¨­å‚™æŠ•è³‡æŠ‘åˆ¶ãƒ»è£½é€ æ¥­ä½è¿·")
    
    elif ticker == '6855.T':  # æ—¥æœ¬é›»å­ææ–™
        factors.append("åŠå°ä½“ææ–™æ¥­ç•Œï¼šåŠå°ä½“ã‚µã‚¤ã‚¯ãƒ«")
        if move_type == "ä¸Šæ˜‡":
            factors.append("åŠå°ä½“éœ€è¦å¢—ãƒ»æŠ€è¡“é©æ–°")
        else:
            factors.append("åŠå°ä½“ã‚µã‚¤ã‚¯ãƒ«æ‚ªåŒ–ãƒ»éœ€è¦æ¸›")
    
    elif ticker == '4832.T':  # JFEã‚·ã‚¹ãƒ†ãƒ ã‚º
        factors.append("ITã‚µãƒ¼ãƒ“ã‚¹æ¥­ç•Œï¼šDXéœ€è¦ãƒ»ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‹•å‘")
        if move_type == "ä¸Šæ˜‡":
            factors.append("DXæ¡ˆä»¶å¢—åŠ ãƒ»å¤§å‹å—æ³¨")
        else:
            factors.append("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé…å»¶ãƒ»ITæŠ•è³‡æŠ‘åˆ¶")
    
    elif ticker == '4767.T':  # ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼
        factors.append("åºƒå‘Šæ¥­ç•Œï¼šæ™¯æ°—å‹•å‘ãƒ»ä¼æ¥­åºƒå‘Šè²»")
        if move_type == "ä¸Šæ˜‡":
            factors.append("æ™¯æ°—å›å¾©ãƒ»åºƒå‘Šè²»å¢—åŠ ")
        else:
            factors.append("æ™¯æ°—æ‚ªåŒ–ãƒ»åºƒå‘Šè²»å‰Šæ¸›")
    
    return factors

def parse_forecast_history(forecast_text):
    """æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¦DataFrameã«å¤‰æ›"""
    try:
        lines = forecast_text.strip().split('\n')
        data = []
        current_fy = None
        current_guidance = {}
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
                
            # å¹´åº¦ã®æ¤œå‡º
            if line.startswith('FY '):
                current_fy = line.split()[1]
                current_guidance = {}
                continue
                
            # ãƒ‡ãƒ¼ã‚¿è¡Œã®å‡¦ç†
            if any(char in line for char in ['æ±º', 'å®Ÿ', 'ä¿®']):
                parts = line.split()
                if len(parts) >= 2:
                    date_part = parts[0]
                    type_part = parts[1] if len(parts) > 1 else ''
                    
                    # æ—¥ä»˜ã¨ã‚¿ã‚¤ãƒ—ã®æŠ½å‡º
                    if '/' in date_part:
                        date = date_part
                        guidance_type = type_part
                    else:
                        date = ''
                        guidance_type = date_part
                    
                    # æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    values = []
                    for i in range(2, len(parts)):
                        try:
                            val = float(parts[i].replace('â†‘', '').replace('â†“', '').replace('â†’', '').replace('(', '').replace(')', '').replace('+', '').replace('-', ''))
                            values.append(val)
                        except:
                            values.append(None)
                    
                    if len(values) >= 6:  # æœ€ä½é™å¿…è¦ãªãƒ‡ãƒ¼ã‚¿
                        data.append({
                            'FY': current_fy,
                            'Date': date,
                            'Type': guidance_type,
                            'Revenue': values[0] if values[0] else None,
                            'Operating_Profit': values[1] if values[1] else None,
                            'Ordinary_Profit': values[2] if values[2] else None,
                            'Net_Profit': values[3] if values[3] else None,
                            'EPS': values[4] if values[4] else None,
                            'Dividend': values[5] if values[5] else None
                        })
        
        return pd.DataFrame(data)
    
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ç©ºã®DataFrameã‚’è¿”ã™
        return pd.DataFrame()

def analyze_forecast_accuracy(df):
    """æ¥­ç¸¾äºˆæƒ³ã®ç²¾åº¦ã‚’åˆ†æ"""
    try:
        accuracy_data = []
        
        # ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã¯ç©ºã®DataFrameã‚’è¿”ã™
        if df.empty:
            return pd.DataFrame()
        
        # å¹´åº¦ã”ã¨ã«åˆ†æ
        for fy in df['FY'].unique():
            fy_data = df[df['FY'] == fy].copy()
            
            # åˆæœŸäºˆæƒ³ã¨å®Ÿç¸¾ã‚’å–å¾—
            initial = fy_data[fy_data['Type'] == 'æ±º'].iloc[0] if len(fy_data[fy_data['Type'] == 'æ±º']) > 0 else None
            actual = fy_data[fy_data['Type'] == 'å®Ÿ'].iloc[0] if len(fy_data[fy_data['Type'] == 'å®Ÿ']) > 0 else None
            
            if initial is not None and actual is not None:
                metrics = ['Revenue', 'Operating_Profit', 'Ordinary_Profit', 'Net_Profit']
                
                for metric in metrics:
                    if initial[metric] is not None and actual[metric] is not None and initial[metric] != 0:
                        forecast_value = initial[metric]
                        actual_value = actual[metric]
                        error_rate = ((actual_value - forecast_value) / forecast_value) * 100
                        
                        accuracy_data.append({
                            'FY': fy,
                            'Metric': metric,
                            'Forecast': forecast_value,
                            'Actual': actual_value,
                            'Error_Rate': error_rate,
                            'Abs_Error_Rate': abs(error_rate)
                        })
        
        return pd.DataFrame(accuracy_data)
    
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ç©ºã®DataFrameã‚’è¿”ã™
        return pd.DataFrame()

def create_forecast_analysis_charts(forecast_df, accuracy_df):
    """æ¥­ç¸¾äºˆæƒ³åˆ†æãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    charts = {}
    
    # 1. å£²ä¸Šãƒ»å–¶æ¥­åˆ©ç›Šã®æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
    fig_trend = go.Figure()
    
    for metric in ['Revenue', 'Operating_Profit']:
        metric_name = 'å£²ä¸Šé«˜' if metric == 'Revenue' else 'å–¶æ¥­åˆ©ç›Š'
        
        # å®Ÿç¸¾å€¤ã®ãƒ—ãƒ­ãƒƒãƒˆ
        actual_data = forecast_df[forecast_df['Type'] == 'å®Ÿ']
        if not actual_data.empty:
            fig_trend.add_trace(go.Scatter(
                x=actual_data['FY'],
                y=actual_data[metric],
                mode='lines+markers',
                name=f'{metric_name}ï¼ˆå®Ÿç¸¾ï¼‰',
                line=dict(width=3),
                marker=dict(size=10)
            ))
        
        # äºˆæƒ³å€¤ã®ãƒ—ãƒ­ãƒƒãƒˆ
        forecast_data = forecast_df[forecast_df['Type'] == 'æ±º']
        if not forecast_data.empty:
            fig_trend.add_trace(go.Scatter(
                x=forecast_data['FY'],
                y=forecast_data[metric],
                mode='lines+markers',
                name=f'{metric_name}ï¼ˆäºˆæƒ³ï¼‰',
                line=dict(dash='dash', width=2),
                marker=dict(size=8)
            ))
    
    fig_trend.update_layout(
        title='å£²ä¸Šé«˜ãƒ»å–¶æ¥­åˆ©ç›Šã®äºˆæƒ³vså®Ÿç¸¾æ¨ç§»',
        yaxis_title='é‡‘é¡ (å„„å††)',
        xaxis_title='å¹´åº¦',
        height=400
    )
    charts['trend'] = fig_trend
    
    # 2. äºˆæƒ³ç²¾åº¦åˆ†æãƒãƒ£ãƒ¼ãƒˆ
    if not accuracy_df.empty:
        fig_accuracy = go.Figure()
        
        for metric in accuracy_df['Metric'].unique():
            metric_data = accuracy_df[accuracy_df['Metric'] == metric]
            metric_name = {
                'Revenue': 'å£²ä¸Šé«˜',
                'Operating_Profit': 'å–¶æ¥­åˆ©ç›Š',
                'Ordinary_Profit': 'çµŒå¸¸åˆ©ç›Š',
                'Net_Profit': 'ç´”åˆ©ç›Š'
            }.get(metric, metric)
            
            fig_accuracy.add_trace(go.Bar(
                x=metric_data['FY'],
                y=metric_data['Error_Rate'],
                name=metric_name,
                text=[f"{x:+.1f}%" for x in metric_data['Error_Rate']],
                textposition='auto'
            ))
        
        fig_accuracy.update_layout(
            title='æ¥­ç¸¾äºˆæƒ³ã®èª¤å·®ç‡åˆ†æï¼ˆå®Ÿç¸¾ vs åˆæœŸäºˆæƒ³ï¼‰',
            yaxis_title='èª¤å·®ç‡ (%)',
            xaxis_title='å¹´åº¦',
            height=400
        )
        fig_accuracy.add_hline(y=0, line_dash="dash", line_color="black")
        charts['accuracy'] = fig_accuracy
    
    return charts

def process_financial_csv(file_path_or_handle):
    """CSVã‚’èª­ã¿è¾¼ã¿æ•´å½¢ã™ã‚‹é–¢æ•°"""
    try:
        if isinstance(file_path_or_handle, str):
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
            df = pd.read_csv(file_path_or_handle, index_col=0, encoding='utf-8')
        else:
            # ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«
            df = pd.read_csv(file_path_or_handle, index_col=0, encoding='utf-8')

        # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ—¥ä»˜å½¢å¼ã®å ´åˆã®å‡¦ç†
        if df.index.dtype == 'object':
            try:
                df.index = pd.to_datetime(df.index)
                df.sort_index(inplace=True)
                
                # ãƒ‡ãƒ¼ã‚¿ã‚’æ•°å€¤ã«å¤‰æ›
                for col in df.columns:
                    df[col] = pd.to_numeric(df[col], errors='coerce')
                
                # å…¨ã¦ãŒNaNã®è¡Œã‚’å‰Šé™¤
                df.dropna(how='all', inplace=True)
                
                return df
            except (ValueError, TypeError):
                pass
        
        # é€šæœŸãƒ‡ãƒ¼ã‚¿æŠ½å‡ºæ–¹å¼
        annual_col_pattern = re.compile(r'^\d{4}/\d{1,2}$')
        annual_columns = [col for col in df.columns if annual_col_pattern.match(col)]
        
        if not annual_columns:
            for col in df.columns:
                df[col] = pd.to_numeric(df[col], errors='coerce')
            df.dropna(how='all', inplace=True)
            return df
        
        df_annual = df[annual_columns].copy()
        df_annual = df_annual.replace({',': ''}, regex=True)
        for col in df_annual.columns:
            df_annual[col] = pd.to_numeric(df_annual[col], errors='coerce')

        df_annual.dropna(how='all', inplace=True)
        df_transposed = df_annual.T
        df_transposed.index = pd.to_datetime(df_transposed.index, format='%Y/%m')
        df_transposed.sort_index(inplace=True)
        
        return df_transposed
        
    except Exception as e:
        st.error(f"CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return None

def calculate_technicals(df):
    """ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‚’è¨ˆç®—"""
    df['MA5'] = df['Close'].rolling(window=5).mean()
    df['MA25'] = df['Close'].rolling(window=25).mean()
    df['MA75'] = df['Close'].rolling(window=75).mean()
    delta = df['Close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss.replace(0, np.nan)
    df['RSI'] = 100 - (100 / (1 + rs))
    return df

def create_candlestick_chart(df, ticker_symbol, company_name):
    """ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    fig = go.Figure()
    
    try:
        if not df.empty and all(col in df.columns for col in ['Open', 'High', 'Low', 'Close']):
            fig.add_trace(go.Candlestick(
                x=df.index, 
                open=df['Open'], 
                high=df['High'], 
                low=df['Low'], 
                close=df['Close'], 
                name='ãƒ­ãƒ¼ã‚½ã‚¯è¶³',
                increasing_line_color='red',
                decreasing_line_color='blue'
            ))
        else:
            fig.add_trace(go.Scatter(
                x=df.index, 
                y=df['Close'], 
                mode='lines', 
                name='çµ‚å€¤', 
                line=dict(color='black', width=2)
            ))
    except Exception as e:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['Close'], 
            mode='lines', 
            name='çµ‚å€¤', 
            line=dict(color='black', width=2)
        ))
    
    # ç§»å‹•å¹³å‡ç·š
    if 'MA25' in df.columns:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['MA25'], 
            mode='lines', 
            name='25æ—¥ç§»å‹•å¹³å‡ç·š', 
            line=dict(color='orange', width=1)
        ))
    
    if 'MA75' in df.columns:
        fig.add_trace(go.Scatter(
            x=df.index, 
            y=df['MA75'], 
            mode='lines', 
            name='75æ—¥ç§»å‹•å¹³å‡ç·š', 
            line=dict(color='skyblue', width=1)
        ))
    
    fig.update_layout(
        title=f'{company_name} ({ticker_symbol}) æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ', 
        yaxis_title='æ ªä¾¡ (JPY)', 
        xaxis_rangeslider_visible=False,
        xaxis_title='æ—¥ä»˜',
        showlegend=True
    )
    return fig

def create_rsi_chart(df, ticker_symbol):
    """RSIãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    fig = go.Figure()
    fig.add_trace(go.Scatter(x=df.index, y=df['RSI'], mode='lines', name='RSI', line=dict(color='purple')))
    fig.add_hline(y=70, line_dash="dot", line_color="red", annotation_text="è²·ã‚ã‚Œã™ã (70%)", annotation_position="bottom right")
    fig.add_hline(y=30, line_dash="dot", line_color="green", annotation_text="å£²ã‚‰ã‚Œã™ã (30%)", annotation_position="bottom right")
    fig.update_layout(title=f'{ticker_symbol} RSI (14æ—¥é–“)', yaxis_title='RSI', yaxis=dict(range=[0, 100]))
    return fig

def create_rolling_volatility_chart(df, ticker_symbol, window=30):
    """ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ"""
    try:
        # æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã®è¨ˆç®—
        if isinstance(df.columns, pd.MultiIndex):
            close_prices = df.iloc[:, df.columns.get_level_values(0) == 'Close'].iloc[:, 0]
        else:
            close_prices = df['Close']
        
        daily_returns = close_prices.pct_change().dropna()
        
        # ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—ï¼ˆå¹´ç‡æ›ç®—ï¼‰
        rolling_vol = daily_returns.rolling(window=window).std() * np.sqrt(252)
        
        fig = go.Figure()
        fig.add_trace(go.Scatter(
            x=rolling_vol.index, 
            y=rolling_vol * 100,  # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
            mode='lines',
            name=f'{window}æ—¥ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£',
            line=dict(color='orange', width=2)
        ))
        
        # å¹³å‡ç·šã‚’è¿½åŠ 
        avg_vol = rolling_vol.mean() * 100
        fig.add_hline(
            y=avg_vol, 
            line_dash="dash", 
            line_color="gray", 
            annotation_text=f"å¹³å‡: {avg_vol:.1f}%"
        )
        
        fig.update_layout(
            title=f'{ticker_symbol} ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ ({window}æ—¥)',
            yaxis_title='å¹´é–“ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ (%)',
            height=400
        )
        return fig
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¿”ã™
        fig = go.Figure()
        fig.add_annotation(text=f"ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: {str(e)}", xref="paper", yref="paper", x=0.5, y=0.5)
        return fig

def create_returns_histogram(daily_returns, ticker_symbol):
    """æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’ä½œæˆ"""
    try:
        fig = go.Figure()
        
        # ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ 
        fig.add_trace(go.Histogram(
            x=daily_returns * 100,  # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
            nbinsx=50,
            name='æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³åˆ†å¸ƒ',
            marker_color='lightblue',
            opacity=0.7
        ))
        
        # çµ±è¨ˆæƒ…å ±
        mean_return = daily_returns.mean() * 100
        std_return = daily_returns.std() * 100
        
        # å¹³å‡ç·š
        fig.add_vline(
            x=mean_return, 
            line_dash="dash", 
            line_color="red", 
            annotation_text=f"å¹³å‡: {mean_return:.2f}%"
        )
        
        # æ¨™æº–åå·®ã®ç¯„å›²ã‚’è¡¨ç¤º
        fig.add_vline(
            x=mean_return + std_return, 
            line_dash="dot", 
            line_color="orange", 
            annotation_text=f"+1Ïƒ: {mean_return + std_return:.2f}%"
        )
        fig.add_vline(
            x=mean_return - std_return, 
            line_dash="dot", 
            line_color="orange", 
            annotation_text=f"-1Ïƒ: {mean_return - std_return:.2f}%"
        )
        
        fig.update_layout(
            title=f'{ticker_symbol} æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³åˆ†å¸ƒ',
            xaxis_title='æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ (%)',
            yaxis_title='é »åº¦',
            height=400,
            bargap=0.1
        )
        return fig
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºã®ãƒãƒ£ãƒ¼ãƒˆã‚’è¿”ã™
        fig = go.Figure()
        fig.add_annotation(text=f"ãƒãƒ£ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: {str(e)}", xref="paper", yref="paper", x=0.5, y=0.5)
        return fig

def find_financial_csv(ticker_code):
    """éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œç´¢"""
    clean_code = ticker_code.replace('.T', '')
    csv_filename = f"cleaned_financials_{clean_code}.csv"
    
    if os.path.exists(csv_filename):
        return csv_filename
    return None

def get_available_financial_tickers():
    """åˆ©ç”¨å¯èƒ½ãªè²¡å‹™ãƒ‡ãƒ¼ã‚¿éŠ˜æŸ„ã‚’å–å¾—"""
    csv_files = [f for f in os.listdir('.') if f.startswith('cleaned_financials_') and f.endswith('.csv')]
    tickers = []
    for csv_file in csv_files:
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º
        code = csv_file.replace('cleaned_financials_', '').replace('.csv', '')
        ticker = f"{code}.T"
        tickers.append(ticker)
    return sorted(tickers)

def get_valuation_metrics(ticker_info, fundamental_data):
    """
    ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚’å–å¾—ãƒ»è¨ˆç®—ã™ã‚‹é–¢æ•°
    
    Args:
        ticker_info (dict): yf.Ticker.info ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        fundamental_data (pd.DataFrame): è²¡å‹™CSVã®DataFrame
    
    Returns:
        dict: ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã®è¾æ›¸
    """
    metrics = {}
    
    try:
        # PER (æ ªä¾¡åç›Šç‡)
        per = ticker_info.get('trailingPE')
        if per is None or per <= 0:
            per = ticker_info.get('forwardPE')
        metrics['PER'] = per if per and per > 0 else None
        
        # PBR (æ ªä¾¡ç´”è³‡ç”£å€ç‡)
        pbr = ticker_info.get('priceToBook')
        metrics['PBR'] = pbr if pbr and pbr > 0 else None
        
        # ROE (è‡ªå·±è³‡æœ¬åˆ©ç›Šç‡)
        roe = ticker_info.get('returnOnEquity')
        
        # ROEã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºã«å¤‰æ›ï¼ˆyfinanceã¯å°æ•°ã§è¿”ã™ã“ã¨ãŒå¤šã„ï¼‰
        if roe is not None and roe > 0:
            if roe < 1:  # å°æ•°ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã«å¤‰æ›
                roe = roe * 100
        
        # ROEãŒå–å¾—ã§ããªã„å ´åˆã¯è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¨ˆç®—
        if (roe is None or roe <= 0) and fundamental_data is not None and not fundamental_data.empty:
            try:
                # å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹æœ€æ–°å¹´åº¦ã‚’å–å¾—ï¼ˆNaNã§ãªã„è¡Œã‚’æ¢ã™ï¼‰
                for i in range(len(fundamental_data) - 1, -1, -1):
                    latest_data = fundamental_data.iloc[i]
                    net_income = latest_data.get('å½“æœŸåˆ©ç›Š')
                    equity = latest_data.get('è‡ªå·±è³‡æœ¬')
                    
                    # NaNã§ãªã„æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
                    if (net_income is not None and not pd.isna(net_income) and 
                        equity is not None and not pd.isna(equity) and equity > 0):
                        roe = (net_income / equity) * 100  # ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
                        break
            except (IndexError, KeyError, TypeError):
                pass
        
        metrics['ROE'] = roe if roe is not None and roe > 0 else None
        
        # é…å½“åˆ©å›ã‚Š
        dividend_yield = ticker_info.get('dividendYield')
        if dividend_yield is not None and dividend_yield > 0:
            # yfinanceã®é…å½“åˆ©å›ã‚Šã¯æ—¢ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå½¢å¼ã®å ´åˆãŒå¤šã„ã®ã§ã€èª¿æ•´
            if dividend_yield > 1:  # 1ã‚ˆã‚Šå¤§ãã„å ´åˆã¯æ—¢ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ
                dividend_yield = dividend_yield
            else:  # 1ä»¥ä¸‹ã®å ´åˆã¯å°æ•°ãªã®ã§ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã«å¤‰æ›
                dividend_yield = dividend_yield * 100
        metrics['é…å½“åˆ©å›ã‚Š'] = dividend_yield if dividend_yield is not None and dividend_yield > 0 else None
        
    except Exception as e:
        print(f"ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã®è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã™ã¹ã¦Noneã§åˆæœŸåŒ–
        metrics = {
            'PER': None,
            'PBR': None,
            'ROE': None,
            'é…å½“åˆ©å›ã‚Š': None
        }
    
    return metrics

def create_integrated_analysis(ticker, stock_data, ticker_info, fundamental_data=None):
    """çµ±åˆåˆ†æãƒšãƒ¼ã‚¸"""
    company_name = get_japanese_company_name(ticker, ticker_info)
    
    # åŸºæœ¬æƒ…å ±è¡¨ç¤º
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        latest_price = stock_data['Close'].iloc[-1].item()
        st.metric("ğŸ’° æœ€æ–°æ ªä¾¡", f"Â¥{latest_price:,.2f}")
    
    with col2:
        prev_price = stock_data['Close'].iloc[-2].item()
        change = latest_price - prev_price
        change_pct = (change / prev_price) * 100
        st.metric("ğŸ“ˆ å‰æ—¥æ¯”", f"{change_pct:.2f}%", f"Â¥{change:+.2f}")
    
    with col3:
        rsi_value = stock_data['RSI'].iloc[-1].item()
        rsi_signal = "ğŸ”¥éç†±" if rsi_value > 70 else "â„ï¸å£²ã‚‰ã‚Œã™ã" if rsi_value < 30 else "ğŸ˜ä¸­ç«‹"
        st.metric("ğŸ“Š RSI", f"{rsi_value:.1f}", rsi_signal)
    
    with col4:
        if fundamental_data is not None and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
            latest_profit = fundamental_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1] / 1e2
            # å–¶æ¥­åˆ©ç›ŠãŒ0ã¾ãŸã¯éå¸¸ã«å°ã•ã„å ´åˆã®å‡¦ç†
            if latest_profit <= 0.1:  # 0.1å„„å††ä»¥ä¸‹ã®å ´åˆ
                st.metric("ğŸ’¼ å–¶æ¥­åˆ©ç›Š", "äºˆæƒ³å€¤è¨­å®šå¯èƒ½", help="å®Ÿç¸¾å€¤ãŒå°ã•ã„ãŸã‚äºˆæƒ³å€¤ã‚’è¨­å®šã§ãã¾ã™")
            else:
                st.metric("ğŸ’¼ å–¶æ¥­åˆ©ç›Š", f"{latest_profit:.1f}å„„å††")
        else:
            market_cap = ticker_info.get('marketCap', 0) / 1e8 if ticker_info.get('marketCap') else 0
            st.metric("ğŸ¢ æ™‚ä¾¡ç·é¡", f"{market_cap:,.0f}å„„å††")
    
    # ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢
    col_chart1, col_chart2 = st.columns(2)
    
    with col_chart1:
        st.write("**ğŸ“ˆ æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ (ç›´è¿‘6ãƒ¶æœˆ)**")
        recent_data = stock_data.tail(120)  # ç´„6ãƒ¶æœˆ
        fig_stock = create_candlestick_chart(recent_data, ticker, company_name)
        fig_stock.update_layout(height=400)
        st.plotly_chart(fig_stock, use_container_width=True)
    
    with col_chart2:
        if fundamental_data is not None and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
            st.write("**ğŸ¢ å–¶æ¥­åˆ©ç›Šæ¨ç§»**")
            fig_profit = go.Figure()
            
            # å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿
            fig_profit.add_trace(go.Scatter(
                x=fundamental_data.index,
                y=fundamental_data['å–¶æ¥­åˆ©ç›Š'] / 1e2,  # å„„å††
                mode='lines+markers',
                name='å–¶æ¥­åˆ©ç›Šï¼ˆå®Ÿç¸¾ï¼‰',
                line=dict(color='green', width=3),
                marker=dict(size=8)
            ))
            
            # äºˆæƒ³å€¤ãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            forecast_key_profit = f"forecast_profit_{ticker}"
            if forecast_key_profit in st.session_state and st.session_state[forecast_key_profit] > 0:
                forecast_profit = st.session_state[forecast_key_profit]
                
                # äºˆæƒ³å€¤ç”¨ã®å°†æ¥æ—¥ä»˜ã‚’ä½œæˆï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®1å¹´å¾Œï¼‰
                last_date = fundamental_data.index[-1]
                if hasattr(last_date, 'to_pydatetime'):
                    forecast_date = last_date.to_pydatetime().replace(year=last_date.year + 1)
                else:
                    forecast_date = pd.to_datetime(str(int(last_date.split('-')[0]) + 1) + '-03-01')
                
                # äºˆæƒ³å€¤ã‚’ãƒ—ãƒ­ãƒƒãƒˆ
                fig_profit.add_trace(go.Scatter(
                    x=[last_date, forecast_date],
                    y=[fundamental_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1] / 1e2, forecast_profit],
                    mode='lines+markers',
                    name='å–¶æ¥­åˆ©ç›Šï¼ˆäºˆæƒ³ï¼‰',
                    line=dict(color='orange', width=3, dash='dash'),
                    marker=dict(size=10, symbol='star')
                ))
            
            fig_profit.update_layout(
                title='å–¶æ¥­åˆ©ç›Šæ¨ç§»ï¼ˆå®Ÿç¸¾ + äºˆæƒ³ï¼‰',
                yaxis_title='å–¶æ¥­åˆ©ç›Š (å„„å††)',
                height=400
            )
            st.plotly_chart(fig_profit, use_container_width=True)
        else:
            st.write("**ğŸ“Š RSIæ¨ç§»**")
            fig_rsi = create_rsi_chart(stock_data, ticker)
            fig_rsi.update_layout(height=400)
            st.plotly_chart(fig_rsi, use_container_width=True)
    
    # æ ªä¾¡å¤‰å‹•è¦å› åˆ†æ
    st.subheader('ğŸ” æ ªä¾¡å¤‰å‹•è¦å› åˆ†æ')
    
    # æ ªä¾¡å¤‰å‹•è¦å› ã®åˆ†æã‚’å®Ÿè¡Œ
    price_factors = analyze_price_movement_factors(stock_data, fundamental_data, ticker)
    
    if price_factors:
        st.write("**æœ€è¿‘ã®ä¸»è¦ãªæ ªä¾¡å¤‰å‹•ã¨ãã®è¦å› **")
        
        # ä¸Šæ˜‡ã¨ä¸‹è½ã‚’åˆ†ã‘ã¦è¡¨ç¤º
        upward_moves = [move for move in price_factors if move['Move_Type'] == 'ä¸Šæ˜‡']
        downward_moves = [move for move in price_factors if move['Move_Type'] == 'ä¸‹è½']
        
        col_up, col_down = st.columns(2)
        
        with col_up:
            st.write("**ğŸŸ¢ ä¸Šæ˜‡è¦å› åˆ†æ**")
            if upward_moves:
                for i, move in enumerate(upward_moves[:3]):  # æœ€æ–°3ä»¶
                    with st.expander(f"ğŸ“ˆ {move['Date']} ({move['Move_Percent']})"):
                        st.write(f"**ä¾¡æ ¼**: Â¥{move['Price']:,.2f}")
                        st.write(f"**å‡ºæ¥é«˜**: {move['Volume']:,}")
                        
                        if move['Technical_Factors']:
                            st.write("**ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **:")
                            for factor in move['Technical_Factors']:
                                st.write(f"â€¢ {factor}")
                        
                        if move['Fundamental_Factors']:
                            st.write("**ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **:")
                            for factor in move['Fundamental_Factors']:
                                st.write(f"â€¢ {factor}")
                        
                        if move['Sector_Factors']:
                            st.write("**æ¥­ç•Œç‰¹æœ‰è¦å› **:")
                            for factor in move['Sector_Factors']:
                                st.write(f"â€¢ {factor}")
            else:
                st.info("å¤§ããªä¸Šæ˜‡ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        with col_down:
            st.write("**ğŸ”´ ä¸‹è½è¦å› åˆ†æ**")
            if downward_moves:
                for i, move in enumerate(downward_moves[:3]):  # æœ€æ–°3ä»¶
                    with st.expander(f"ğŸ“‰ {move['Date']} ({move['Move_Percent']})"):
                        st.write(f"**ä¾¡æ ¼**: Â¥{move['Price']:,.2f}")
                        st.write(f"**å‡ºæ¥é«˜**: {move['Volume']:,}")
                        
                        if move['Technical_Factors']:
                            st.write("**ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **:")
                            for factor in move['Technical_Factors']:
                                st.write(f"â€¢ {factor}")
                        
                        if move['Fundamental_Factors']:
                            st.write("**ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **:")
                            for factor in move['Fundamental_Factors']:
                                st.write(f"â€¢ {factor}")
                        
                        if move['Sector_Factors']:
                            st.write("**æ¥­ç•Œç‰¹æœ‰è¦å› **:")
                            for factor in move['Sector_Factors']:
                                st.write(f"â€¢ {factor}")
            else:
                st.info("å¤§ããªä¸‹è½ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“")
        
        # è¦å› ã‚µãƒãƒªãƒ¼
        st.write("**ğŸ“Š è¦å› ã‚µãƒãƒªãƒ¼**")
        all_technical = []
        all_fundamental = []
        all_sector = []
        
        for move in price_factors:
            all_technical.extend(move['Technical_Factors'])
            all_fundamental.extend(move['Fundamental_Factors'])
            all_sector.extend(move['Sector_Factors'])
        
        col_summary1, col_summary2, col_summary3 = st.columns(3)
        
        with col_summary1:
            st.write("**ä¸»è¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **")
            technical_counts = pd.Series(all_technical).value_counts()
            if not technical_counts.empty:
                for factor, count in technical_counts.head(3).items():
                    st.write(f"â€¢ {factor} ({count}å›)")
            else:
                st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")
        
        with col_summary2:
            st.write("**ä¸»è¦ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **")
            fundamental_counts = pd.Series(all_fundamental).value_counts()
            if not fundamental_counts.empty:
                for factor, count in fundamental_counts.head(3).items():
                    st.write(f"â€¢ {factor} ({count}å›)")
            else:
                st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")
        
        with col_summary3:
            st.write("**ä¸»è¦æ¥­ç•Œè¦å› **")
            sector_counts = pd.Series(all_sector).value_counts()
            if not sector_counts.empty:
                for factor, count in sector_counts.head(3).items():
                    st.write(f"â€¢ {factor} ({count}å›)")
            else:
                st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")
    else:
        st.info("å¤§ããªæ ªä¾¡å¤‰å‹•ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ5%ä»¥ä¸Šã®å¤‰å‹•ã‚’å¯¾è±¡ï¼‰")
    
    # çµ±åˆæŠ•è³‡åˆ¤æ–­
    st.subheader('ğŸ¯ çµ±åˆæŠ•è³‡åˆ¤æ–­')
    
    col_tech, col_fund = st.columns(2)
    
    with col_tech:
        st.write("**ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚·ã‚°ãƒŠãƒ«**")
        
        # RSIåˆ¤æ–­
        rsi = stock_data['RSI'].iloc[-1].item()
        if rsi > 70:
            rsi_signal = "ğŸ”´ å£²ã‚Šã‚·ã‚°ãƒŠãƒ«ï¼ˆéç†±çŠ¶æ…‹ï¼‰"
            rsi_color = "error"
        elif rsi < 30:
            rsi_signal = "ğŸŸ¢ è²·ã„ã‚·ã‚°ãƒŠãƒ«ï¼ˆå£²ã‚‰ã‚Œã™ãï¼‰"
            rsi_color = "success"
        else:
            rsi_signal = "ğŸŸ¡ ä¸­ç«‹ï¼ˆæ§˜å­è¦‹ï¼‰"
            rsi_color = "warning"
        
        st.write(f"RSI ({rsi:.1f}): {rsi_signal}")
        
        # ç§»å‹•å¹³å‡åˆ¤æ–­
        ma25 = stock_data['MA25'].iloc[-1].item()
        ma75 = stock_data['MA75'].iloc[-1].item()
        current_price = stock_data['Close'].iloc[-1].item()
        
        if current_price > ma25 > ma75:
            ma_signal = "ğŸŸ¢ ä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰ç¶™ç¶š"
            ma_color = "success"
        elif current_price < ma25 < ma75:
            ma_signal = "ğŸ”´ ä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰ç¶™ç¶š"
            ma_color = "error"
        else:
            ma_signal = "ğŸŸ¡ ãƒ¬ãƒ³ã‚¸ç›¸å ´"
            ma_color = "warning"
        
        st.write(f"ç§»å‹•å¹³å‡: {ma_signal}")
        
        # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ç·åˆåˆ¤æ–­
        tech_score = 0
        if rsi_color == "success":
            tech_score += 1
        elif rsi_color == "error":
            tech_score -= 1
        
        if ma_color == "success":
            tech_score += 1
        elif ma_color == "error":
            tech_score -= 1
        
        if tech_score >= 1:
            st.success("ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«: å¼·æ°—ã‚·ã‚°ãƒŠãƒ«")
        elif tech_score <= -1:
            st.error("ğŸ“‰ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«: å¼±æ°—ã‚·ã‚°ãƒŠãƒ«")
        else:
            st.warning("ğŸ˜ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«: ä¸­ç«‹")
    
    with col_fund:
        if fundamental_data is not None and len(fundamental_data) > 1:
            st.write("**ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã‚·ã‚°ãƒŠãƒ«**")
            
            # äºˆæƒ³å€¤ã®å–å¾—
            forecast_key_revenue = f"forecast_revenue_{ticker}"
            forecast_key_profit = f"forecast_profit_{ticker}"
            use_forecast = (forecast_key_revenue in st.session_state and 
                          forecast_key_profit in st.session_state and 
                          st.session_state[forecast_key_profit] > 0)
            
            # å£²ä¸Šæˆé•·ç‡åˆ¤æ–­ï¼ˆäºˆæƒ³å€¤ã‚‚è€ƒæ…®ï¼‰
            if 'å£²ä¸Šé«˜' in fundamental_data.columns:
                if use_forecast:
                    # äºˆæƒ³å€¤ã‚’ä½¿ç”¨
                    latest_revenue = st.session_state[forecast_key_revenue] * 1e8
                    prev_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
                    revenue_growth = ((latest_revenue - prev_revenue) / prev_revenue) * 100 if prev_revenue != 0 else 0
                    growth_type = "ï¼ˆäºˆæƒ³ï¼‰"
                else:
                    # å®Ÿç¸¾å€¤ã‚’ä½¿ç”¨
                    latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
                    prev_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-2]
                    revenue_growth = ((latest_revenue - prev_revenue) / prev_revenue) * 100 if prev_revenue != 0 else 0
                    growth_type = "ï¼ˆå®Ÿç¸¾ï¼‰"
                
                if revenue_growth > 10:
                    revenue_signal = "ğŸŸ¢ é«˜æˆé•·"
                    revenue_color = "success"
                elif revenue_growth > 0:
                    revenue_signal = "ğŸŸ¡ æˆé•·"
                    revenue_color = "warning"
                else:
                    revenue_signal = "ğŸ”´ æ¸›å"
                    revenue_color = "error"
                
                st.write(f"å£²ä¸Šæˆé•·ç‡{growth_type} ({revenue_growth:.1f}%): {revenue_signal}")
            
            # å–¶æ¥­åˆ©ç›Šç‡åˆ¤æ–­ï¼ˆäºˆæƒ³å€¤ã‚‚è€ƒæ…®ï¼‰
            if 'å£²ä¸Šé«˜' in fundamental_data.columns and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
                if use_forecast:
                    # äºˆæƒ³å€¤ã‚’ä½¿ç”¨
                    latest_revenue = st.session_state[forecast_key_revenue] * 1e8
                    latest_profit = st.session_state[forecast_key_profit] * 1e8
                    margin_type = "ï¼ˆäºˆæƒ³ï¼‰"
                else:
                    # å®Ÿç¸¾å€¤ã‚’ä½¿ç”¨
                    latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
                    latest_profit = fundamental_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1]
                    margin_type = "ï¼ˆå®Ÿç¸¾ï¼‰"
                
                operating_margin = (latest_profit / latest_revenue) * 100 if latest_revenue != 0 else 0
                
                if operating_margin > 15:
                    margin_signal = "ğŸŸ¢ é«˜åç›Šæ€§"
                    margin_color = "success"
                elif operating_margin > 5:
                    margin_signal = "ğŸŸ¡ æ¨™æº–çš„"
                    margin_color = "warning"
                else:
                    margin_signal = "ğŸ”´ ä½åç›Šæ€§"
                    margin_color = "error"
                
                st.write(f"å–¶æ¥­åˆ©ç›Šç‡{margin_type} ({operating_margin:.1f}%): {margin_signal}")
                
                # äºˆæƒ³å€¤ä½¿ç”¨æ™‚ã®è¿½åŠ æƒ…å ±
                if use_forecast:
                    st.info("ğŸ”® äºˆæƒ³å€¤ã‚’ä½¿ç”¨ã—ãŸåˆ†æçµæœã§ã™")
            
            # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ç·åˆåˆ¤æ–­
            fund_score = 0
            if 'revenue_color' in locals() and revenue_color == "success":
                fund_score += 1
            elif 'revenue_color' in locals() and revenue_color == "error":
                fund_score -= 1
            
            if 'margin_color' in locals() and margin_color == "success":
                fund_score += 1
            elif 'margin_color' in locals() and margin_color == "error":
                fund_score -= 1
            
            if fund_score >= 1:
                st.success("ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«: è‰¯å¥½")
            elif fund_score <= -1:
                st.error("ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«: æ‡¸å¿µ")
            else:
                st.warning("ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«: ä¸­ç«‹")
        else:
            st.info("ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚\nãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã®ã¿ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚")
    
    # æŠ•è³‡åˆ¤æ–­ãƒœã‚¿ãƒ³
    st.write("---")
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button(f"ğŸŸ¢ {ticker} è²·ã„æ¨å¥¨", key=f"summary_buy_{ticker}", use_container_width=True):
            st.success(f"{company_name} ã‚’è²·ã„æ¨å¥¨ã¨ã—ã¦è¨˜éŒ²")
    
    with col2:
        if st.button(f"ğŸŸ¡ {ticker} æ§˜å­è¦‹", key=f"summary_hold_{ticker}", use_container_width=True):
            st.warning(f"{company_name} ã‚’æ§˜å­è¦‹ã¨ã—ã¦è¨˜éŒ²")
    
    with col3:
        if st.button(f"ğŸ”´ {ticker} å£²ã‚Šæ¨å¥¨", key=f"summary_sell_{ticker}", use_container_width=True):
            st.error(f"{company_name} ã‚’å£²ã‚Šæ¨å¥¨ã¨ã—ã¦è¨˜éŒ²")
    
    # è²¡å‹™æŒ‡æ¨™äºˆæƒ³å€¤å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.subheader("ğŸ”® è²¡å‹™æŒ‡æ¨™äºˆæƒ³å€¤è¨­å®š")
    
    # æ¥­ç¸¾äºˆæƒ³å±¥æ­´åˆ†æï¼ˆå¯¾å¿œéŠ˜æŸ„ã®ã¿ï¼‰
    forecast_data = None
    if ticker == '6357.T':
        forecast_data = FORECAST_TEXT_6357
        company_display = "ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º"
    elif ticker == '4816.T':
        forecast_data = FORECAST_TEXT_4816
        company_display = "æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"
    elif ticker == '2991.T':
        forecast_data = FORECAST_TEXT_2991
        company_display = "ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆ"
    elif ticker == '7564.T':
        forecast_data = FORECAST_TEXT_7564
        company_display = "ãƒ¯ãƒ¼ã‚¯ãƒãƒ³"
    elif ticker == '7711.T':
        forecast_data = FORECAST_TEXT_7711
        company_display = "åŠ©å·é›»æ°—å·¥æ¥­"
    elif ticker == '6405.T':
        forecast_data = FORECAST_TEXT_6405
        company_display = "éˆ´èŒ‚å™¨å·¥"
    elif ticker == '2428.T':
        forecast_data = FORECAST_TEXT_2428
        company_display = "ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆ"
    elif ticker == '6231.T':
        forecast_data = FORECAST_TEXT_6231
        company_display = "æœ¨æ‘å·¥æ©Ÿ"
    elif ticker == '6855.T':
        forecast_data = FORECAST_TEXT_6855
        company_display = "æ—¥æœ¬é›»å­ææ–™"
    elif ticker == '4832.T':
        forecast_data = FORECAST_TEXT_4832
        company_display = "JFEã‚·ã‚¹ãƒ†ãƒ ã‚º"
    elif ticker == '4767.T':
        forecast_data = FORECAST_TEXT_4767
        company_display = "ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼"
    
    if forecast_data:
        st.subheader(f"ğŸ“Š æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´åˆ†æï¼ˆ{company_display}ï¼‰")
        
        # æ¥­ç¸¾äºˆæƒ³å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®è§£æ
        forecast_df = parse_forecast_history(forecast_data)
        
        if not forecast_df.empty:
            # ã‚¿ãƒ–ã§åˆ†æçµæœã‚’è¡¨ç¤º
            tab1, tab2, tab3 = st.tabs(["ğŸ“ˆ äºˆæƒ³vså®Ÿç¸¾æ¨ç§»", "ğŸ¯ äºˆæƒ³ç²¾åº¦åˆ†æ", "ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿"])
            
            with tab1:
                st.write("**æ¥­ç¸¾äºˆæƒ³ã¨å®Ÿç¸¾ã®æ¨ç§»**")
                accuracy_df = analyze_forecast_accuracy(forecast_df)
                charts = create_forecast_analysis_charts(forecast_df, accuracy_df)
                
                if 'trend' in charts:
                    st.plotly_chart(charts['trend'], use_container_width=True)
                
                # æœ€æ–°ã®äºˆæƒ³ç²¾åº¦ã‚µãƒãƒªãƒ¼
                if not accuracy_df.empty:
                    latest_fy = accuracy_df['FY'].max()
                    latest_accuracy = accuracy_df[accuracy_df['FY'] == latest_fy]
                    
                    st.write(f"**{latest_fy}å¹´åº¦ã®äºˆæƒ³ç²¾åº¦**")
                    col1, col2, col3, col4 = st.columns(4)
                    
                    metrics_display = {
                        'Revenue': ('å£²ä¸Šé«˜', col1),
                        'Operating_Profit': ('å–¶æ¥­åˆ©ç›Š', col2),
                        'Ordinary_Profit': ('çµŒå¸¸åˆ©ç›Š', col3),
                        'Net_Profit': ('ç´”åˆ©ç›Š', col4)
                    }
                    
                    for metric, (name, col) in metrics_display.items():
                        metric_data = latest_accuracy[latest_accuracy['Metric'] == metric]
                        if not metric_data.empty:
                            error_rate = metric_data['Error_Rate'].iloc[0]
                            with col:
                                st.metric(
                                    name,
                                    f"{error_rate:+.1f}%",
                                    "ä¸ŠæŒ¯ã‚Œ" if error_rate > 0 else "ä¸‹æŒ¯ã‚Œ" if error_rate < 0 else "ä¸€è‡´"
                                )
            
            with tab2:
                st.write("**äºˆæƒ³ç²¾åº¦ã®åˆ†æ**")
                if 'accuracy' in charts:
                    st.plotly_chart(charts['accuracy'], use_container_width=True)
                
                # äºˆæƒ³ç²¾åº¦ã®çµ±è¨ˆ
                if not accuracy_df.empty:
                    st.write("**äºˆæƒ³ç²¾åº¦çµ±è¨ˆ**")
                    accuracy_stats = accuracy_df.groupby('Metric').agg({
                        'Abs_Error_Rate': ['mean', 'std', 'min', 'max'],
                        'Error_Rate': ['mean']
                    }).round(2)
                    
                    stats_display = pd.DataFrame({
                        'æŒ‡æ¨™': ['å£²ä¸Šé«˜', 'å–¶æ¥­åˆ©ç›Š', 'çµŒå¸¸åˆ©ç›Š', 'ç´”åˆ©ç›Š'],
                        'å¹³å‡èª¤å·®ç‡(%)': [
                            accuracy_stats.loc['Revenue', ('Error_Rate', 'mean')] if 'Revenue' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Operating_Profit', ('Error_Rate', 'mean')] if 'Operating_Profit' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Ordinary_Profit', ('Error_Rate', 'mean')] if 'Ordinary_Profit' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Net_Profit', ('Error_Rate', 'mean')] if 'Net_Profit' in accuracy_stats.index else 0
                        ],
                        'å¹³å‡çµ¶å¯¾èª¤å·®ç‡(%)': [
                            accuracy_stats.loc['Revenue', ('Abs_Error_Rate', 'mean')] if 'Revenue' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Operating_Profit', ('Abs_Error_Rate', 'mean')] if 'Operating_Profit' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Ordinary_Profit', ('Abs_Error_Rate', 'mean')] if 'Ordinary_Profit' in accuracy_stats.index else 0,
                            accuracy_stats.loc['Net_Profit', ('Abs_Error_Rate', 'mean')] if 'Net_Profit' in accuracy_stats.index else 0
                        ]
                    })
                    
                    st.dataframe(stats_display, use_container_width=True)
                    
                    # äºˆæƒ³ç²¾åº¦ã®å‚¾å‘åˆ†æ
                    st.write("**äºˆæƒ³ç²¾åº¦ã®å‚¾å‘**")
                    
                    # å–¶æ¥­åˆ©ç›Šã®äºˆæƒ³ç²¾åº¦ã«æ³¨ç›®
                    op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                    if not op_accuracy.empty:
                        avg_error = op_accuracy['Error_Rate'].mean()
                        avg_abs_error = op_accuracy['Abs_Error_Rate'].mean()
                        
                        if avg_abs_error < 5:
                            precision_level = "ğŸ¯ é«˜ç²¾åº¦"
                            precision_color = "success"
                        elif avg_abs_error < 15:
                            precision_level = "ğŸ‘ æ¨™æº–çš„"
                            precision_color = "warning"
                        else:
                            precision_level = "âš ï¸ ä½ç²¾åº¦"
                            precision_color = "error"
                        
                        if avg_error > 5:
                            bias_analysis = "ğŸ“ˆ ä¿å®ˆçš„äºˆæƒ³ï¼ˆå®Ÿç¸¾ãŒä¸ŠæŒ¯ã‚Œå‚¾å‘ï¼‰"
                        elif avg_error < -5:
                            bias_analysis = "ğŸ“‰ æ¥½è¦³çš„äºˆæƒ³ï¼ˆå®Ÿç¸¾ãŒä¸‹æŒ¯ã‚Œå‚¾å‘ï¼‰"
                        else:
                            bias_analysis = "âš–ï¸ ãƒãƒ©ãƒ³ã‚¹è‰¯ã„äºˆæƒ³"
                        
                        if precision_color == "success":
                            st.success(f"**å–¶æ¥­åˆ©ç›Šäºˆæƒ³ç²¾åº¦**: {precision_level} (å¹³å‡çµ¶å¯¾èª¤å·®: {avg_abs_error:.1f}%)")
                        elif precision_color == "warning":
                            st.warning(f"**å–¶æ¥­åˆ©ç›Šäºˆæƒ³ç²¾åº¦**: {precision_level} (å¹³å‡çµ¶å¯¾èª¤å·®: {avg_abs_error:.1f}%)")
                        else:
                            st.error(f"**å–¶æ¥­åˆ©ç›Šäºˆæƒ³ç²¾åº¦**: {precision_level} (å¹³å‡çµ¶å¯¾èª¤å·®: {avg_abs_error:.1f}%)")
                        
                        st.info(f"**äºˆæƒ³å‚¾å‘**: {bias_analysis}")
                        
                        # ä¼æ¥­åˆ¥ã®ç‰¹å¾´çš„ãªåˆ†æ
                        if ticker == '4816.T':
                            # æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error > 10:
                                    st.info("ğŸ¬ **æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹å¾´**: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ“ã‚¸ãƒã‚¹ã®ç‰¹æ€§ä¸Šã€ãƒ’ãƒƒãƒˆä½œå“ã«ã‚ˆã‚Šå£²ä¸ŠãŒå¤§å¹…ã«ä¸ŠæŒ¯ã‚Œã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
                        
                        elif ticker == '6357.T':
                            # ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºã®ç‰¹å¾´
                            if avg_abs_error < 10:
                                st.info("âš™ï¸ **ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºã®ç‰¹å¾´**: è£½é€ æ¥­ã¨ã—ã¦æ¯”è¼ƒçš„å®‰å®šã—ãŸæ¥­ç¸¾äºˆæƒ³ç²¾åº¦ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚")
                        
                        elif ticker == '2991.T':
                            # ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error > 0:
                                    st.info("ğŸ¢ **ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆã®ç‰¹å¾´**: ä¸å‹•ç”£ã‚µãƒ¼ãƒ“ã‚¹æ¥­ã¨ã—ã¦ã€å¸‚å ´ç’°å¢ƒã®å¤‰åŒ–ã«ã‚ˆã‚Šå£²ä¸ŠãŒä¸ŠæŒ¯ã‚Œã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
                                    
                            # é…å½“ä¿®æ­£ã®ç‰¹å¾´
                            if len(forecast_df[forecast_df['Type'] == 'ä¿®']) > 0:
                                st.warning("ğŸ’° **é…å½“æ”¿ç­–**: æœŸä¸­ã«é…å½“äºˆæƒ³ã‚’ä¿®æ­£ã™ã‚‹ã‚±ãƒ¼ã‚¹ãŒè¦‹ã‚‰ã‚Œã€æ¥­ç¸¾é€£å‹•å‹ã®é…å½“æ”¿ç­–ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
                        
                        elif ticker == '7564.T':
                            # ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                recent_performance = accuracy_df[accuracy_df['FY'].isin(['2024.03', '2025.03'])]
                                if not recent_performance.empty:
                                    recent_revenue_error = recent_performance[recent_performance['Metric'] == 'Revenue']['Error_Rate'].mean()
                                    if recent_revenue_error < 0:
                                        st.warning("ğŸ‘” **ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ã®ç‰¹å¾´**: è¿‘å¹´ã€å¸‚å ´ç’°å¢ƒã®å¤‰åŒ–ã«ã‚ˆã‚Šå£²ä¸Šäºˆæƒ³ã‚’ä¸‹å›ã‚‹å‚¾å‘ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚æˆé•·éˆåŒ–ã¸ã®å¯¾å¿œãŒé‡è¦ã§ã™ã€‚")
                                    else:
                                        st.info("ğŸ‘” **ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ã®ç‰¹å¾´**: ä½œæ¥­æœå°‚é–€åº—ã¨ã—ã¦ã€åŠ´åƒå¸‚å ´ã®å‹•å‘ã«æ•æ„Ÿãªæ¥­ç¸¾å¤‰å‹•ã‚’ç¤ºã—ã¾ã™ã€‚")
                            
                            # é…å½“å®‰å®šæ€§
                            if avg_abs_error < 10:  # æ¯”è¼ƒçš„ç²¾åº¦ãŒé«˜ã„å ´åˆ
                                st.success("ğŸ’° **é…å½“å®‰å®šæ€§**: å®‰å®šã—ãŸé…å½“æ”¿ç­–ã‚’ç¶­æŒã—ã¦ãŠã‚Šã€æ ªä¸»é‚„å…ƒã«ç©æ¥µçš„ã§ã™ã€‚")
                        
                        elif ticker == '7711.T':
                            # åŠ©å·é›»æ°—å·¥æ¥­ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error > 0:
                                    st.info("âš¡ **åŠ©å·é›»æ°—å·¥æ¥­ã®ç‰¹å¾´**: é›»æ°—æ©Ÿå™¨è£½é€ æ¥­ã¨ã—ã¦ã€å—æ³¨çŠ¶æ³ã«ã‚ˆã‚Šæ¥­ç¸¾ãŒä¸ŠæŒ¯ã‚Œã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
                            
                            # å°å‹æ ªã®æˆé•·æ€§
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_avg_error = op_accuracy['Error_Rate'].mean()
                                if op_avg_error > 15:  # å¤§å¹…ãªä¸ŠæŒ¯ã‚Œ
                                    st.success("ğŸ“ˆ **æˆé•·æ€§**: å°å‹æˆé•·æ ªã¨ã—ã¦ã€å–¶æ¥­åˆ©ç›ŠãŒå¤§å¹…ã«äºˆæƒ³ã‚’ä¸Šå›ã‚‹æˆé•·ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚")
                                    
                            # ä¿®æ­£é »åº¦ã®ç‰¹å¾´
                            modification_count = len(forecast_df[forecast_df['Type'] == 'ä¿®'])
                            total_guidance_count = len(forecast_df[forecast_df['Type'].isin(['æ±º', 'ä¿®'])])
                            if modification_count > 0 and total_guidance_count > 0:
                                modification_rate = (modification_count / total_guidance_count) * 100
                                if modification_rate > 20:
                                    st.warning("ğŸ”„ **äºˆæƒ³ä¿®æ­£é »åº¦**: æœŸä¸­ã§ã®æ¥­ç¸¾äºˆæƒ³ä¿®æ­£ãŒæ¯”è¼ƒçš„å¤šãã€äº‹æ¥­ç’°å¢ƒã®å¤‰åŒ–ã«æ•æ„Ÿã§ã™ã€‚")
                        
                        elif ticker == '6405.T':
                            # éˆ´èŒ‚å™¨å·¥ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error < 0:
                                    st.info("ğŸ™ **éˆ´èŒ‚å™¨å·¥ã®ç‰¹å¾´**: å¯¿å¸ãƒ­ãƒœãƒƒãƒˆè£½é€ æ¥­ã¨ã—ã¦ã€å¤–é£Ÿç”£æ¥­ã®å‹•å‘ã«å½±éŸ¿ã‚’å—ã‘ã‚‹ç‰¹æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
                            
                            # åˆ©ç›Šç‡æ”¹å–„ã®å‚¾å‘
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_avg_error = op_accuracy['Error_Rate'].mean()
                                if op_avg_error > 0:
                                    st.success("ğŸ’¼ **åç›Šæ€§**: å–¶æ¥­åˆ©ç›ŠãŒäºˆæƒ³ã‚’ä¸Šå›ã‚‹å‚¾å‘ãŒã‚ã‚Šã€åŠ¹ç‡çš„ãªäº‹æ¥­é‹å–¶ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # é…å½“æ”¿ç­–ã®ç‰¹å¾´
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                dividend_changes = dividend_data['Dividend'].diff().dropna()
                                if dividend_changes.sum() > 0:
                                    st.success("ğŸ’° **é…å½“æˆé•·**: ç¶™ç¶šçš„ãªå¢—é…å‚¾å‘ã‚’ç¤ºã—ã¦ãŠã‚Šã€æ ªä¸»é‚„å…ƒã«ç©æ¥µçš„ã§ã™ã€‚")
                            
                            # å°‚é–€æ€§ã®å¼·ã¿
                            if avg_abs_error < 15:  # æ¯”è¼ƒçš„ç²¾åº¦ãŒé«˜ã„å ´åˆ
                                st.info("ğŸ”§ **äº‹æ¥­ç‰¹æ€§**: ãƒ‹ãƒƒãƒãªå¸‚å ´ã§ã®ã‚·ã‚§ã‚¢ãŒé«˜ãã€æ¯”è¼ƒçš„å®‰å®šã—ãŸæ¥­ç¸¾äºˆæƒ³ç²¾åº¦ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚")
                        
                        elif ticker == '2428.T':
                            # ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error < 0:
                                    st.info("ğŸ’³ **ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆã®ç‰¹å¾´**: æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹æ¥­ã¨ã—ã¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¹åŒ–ã®é€²å±•ã«ã‚ˆã‚Šå¸‚å ´ç’°å¢ƒã«æ•æ„Ÿã§ã™ã€‚")
                            
                            # åˆ©ç›Šç‡æ”¹å–„ã®å‚¾å‘
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_avg_error = op_accuracy['Error_Rate'].mean()
                                if op_avg_error > 0:
                                    st.success("ğŸ“ˆ **åç›Šæ€§å‘ä¸Š**: å–¶æ¥­åˆ©ç›ŠãŒäºˆæƒ³ã‚’ä¸Šå›ã‚‹å‚¾å‘ãŒã‚ã‚Šã€äº‹æ¥­åŠ¹ç‡åŒ–ãŒé€²ã‚“ã§ã„ã¾ã™ã€‚")
                            
                            # æœŸä¸­ä¿®æ­£ã®ç‰¹å¾´
                            recent_modifications = forecast_df[
                                (forecast_df['Type'] == 'ä¿®') & 
                                (forecast_df['FY'].isin(['2025.06', '2024.06']))
                            ]
                            if not recent_modifications.empty:
                                st.warning("ğŸ”„ **æœŸä¸­ä¿®æ­£å‚¾å‘**: äº‹æ¥­ç’°å¢ƒã®å¤‰åŒ–ã«ã‚ˆã‚ŠæœŸä¸­ã§ã®æ¥­ç¸¾ä¿®æ­£ã‚’å®Ÿæ–½ã™ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
                            
                            # é…å½“æˆé•·ã®å®‰å®šæ€§
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                dividend_trend = dividend_data['Dividend'].pct_change().dropna()
                                if dividend_trend.mean() > 0:
                                    st.success("ğŸ’° **é…å½“æˆé•·**: ç¶™ç¶šçš„ãªå¢—é…ã«ã‚ˆã‚Šæ ªä¸»é‚„å…ƒã‚’å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # ãƒ‡ã‚¸ã‚¿ãƒ«æ±ºæ¸ˆå¸‚å ´ã®æˆé•·
                            if avg_abs_error < 20:  # ä¸­ç¨‹åº¦ã®ç²¾åº¦
                                st.info("ğŸ’ **å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³**: ãƒ‡ã‚¸ã‚¿ãƒ«æ±ºæ¸ˆå¸‚å ´ã®æˆé•·ã‚’å–ã‚Šè¾¼ã¿ã€å®‰å®šã—ãŸãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚")
                        
                        elif ticker == '6231.T':
                            # æœ¨æ‘å·¥æ©Ÿã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error > 5:
                                    st.success("ğŸ­ **æœ¨æ‘å·¥æ©Ÿã®ç‰¹å¾´**: ç”£æ¥­æ©Ÿæ¢°è£½é€ æ¥­ã¨ã—ã¦ã€è¨­å‚™æŠ•è³‡éœ€è¦ã®å›å¾©ã«ã‚ˆã‚Šæ¥­ç¸¾ãŒå¤§å¹…ã«ä¸ŠæŒ¯ã‚Œã—ã¦ã„ã¾ã™ã€‚")
                            
                            # é«˜ã„åˆ©ç›Šç‡ã®å®Ÿç¾
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_avg_error = op_accuracy['Error_Rate'].mean()
                                if op_avg_error > 20:  # å¤§å¹…ãªä¸ŠæŒ¯ã‚Œ
                                    st.success("ğŸ’¼ **åç›Šæ€§**: å–¶æ¥­åˆ©ç›ŠãŒå¤§å¹…ã«äºˆæƒ³ã‚’ä¸Šå›ã‚Šã€é«˜ã„åç›Šæ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # æœŸä¸­ä¸Šæ–¹ä¿®æ­£ã®ç‰¹å¾´
                            modification_data = forecast_df[forecast_df['Type'] == 'ä¿®']
                            if not modification_data.empty:
                                upward_modifications = modification_data[
                                    (modification_data['Revenue'].notna()) & 
                                    (modification_data['Revenue'] > 0)
                                ]
                                if not upward_modifications.empty:
                                    st.info("ğŸ“ˆ **ä¸Šæ–¹ä¿®æ­£å‚¾å‘**: æœŸä¸­ã§ã®æ¥­ç¸¾ä¸Šæ–¹ä¿®æ­£ãŒå¤šãã€å—æ³¨ç’°å¢ƒã®æ”¹å–„ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚")
                            
                            # é…å½“æ”¿ç­–ã®ç©æ¥µæ€§
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                recent_dividends = dividend_data.tail(3)['Dividend']
                                if recent_dividends.max() > recent_dividends.min() * 2:
                                    st.success("ğŸ’° **é…å½“æˆé•·**: å¤§å¹…ãªå¢—é…ã«ã‚ˆã‚Šæ ªä¸»é‚„å…ƒã‚’å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # ç”£æ¥­æ©Ÿæ¢°æ¥­ç•Œã®å›å¾©
                            if avg_abs_error > 15:  # äºˆæƒ³ã‚’å¤§ããä¸Šå›ã‚‹å‚¾å‘
                                st.info("ğŸ”§ **æ¥­ç•Œç’°å¢ƒ**: ç”£æ¥­æ©Ÿæ¢°éœ€è¦ã®å›å¾©ã«ã‚ˆã‚Šã€äºˆæƒ³ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹æ¥­ç¸¾ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚")
                        
                        elif ticker == '6855.T':
                            # æ—¥æœ¬é›»å­ææ–™ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error > 5:
                                    st.success("ğŸ’ **æ—¥æœ¬é›»å­ææ–™ã®ç‰¹å¾´**: åŠå°ä½“ææ–™æ¥­ç•Œã¨ã—ã¦ã€å¸‚å ´å›å¾©ã«ã‚ˆã‚Šæ¥­ç¸¾ãŒå¤§å¹…ã«ä¸ŠæŒ¯ã‚Œã—ã¦ã„ã¾ã™ã€‚")
                            
                            # åˆ©ç›Šå¤‰å‹•ã®æ¿€ã—ã•
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_std = op_accuracy['Error_Rate'].std()
                                if op_std > 50:  # å¤§ããªå¤‰å‹•
                                    st.warning("ğŸ“Š **æ¥­ç¸¾å¤‰å‹•**: å–¶æ¥­åˆ©ç›Šã®å¤‰å‹•ãŒå¤§ããã€åŠå°ä½“ã‚µã‚¤ã‚¯ãƒ«ã®å½±éŸ¿ã‚’å¼·ãå—ã‘ã¦ã„ã¾ã™ã€‚")
                            
                            # æœŸä¸­å¤§å¹…ä¿®æ­£ã®ç‰¹å¾´
                            modification_data = forecast_df[forecast_df['Type'] == 'ä¿®']
                            if not modification_data.empty:
                                large_modifications = modification_data[
                                    (modification_data['Operating_Profit'].notna()) & 
                                    (modification_data['Operating_Profit'].abs() > 1.0)
                                ]
                                if not large_modifications.empty:
                                    st.info("ğŸ”„ **å¤§å¹…ä¿®æ­£**: æœŸä¸­ã§ã®å¤§å¹…ãªæ¥­ç¸¾ä¿®æ­£ãŒå¤šãã€å¸‚å ´ç’°å¢ƒã®å¤‰åŒ–ã«æ•æ„Ÿã§ã™ã€‚")
                            
                            # é…å½“æ”¿ç­–ã®ç‰¹å¾´
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                recent_dividends = dividend_data.tail(3)['Dividend']
                                if recent_dividends.max() > recent_dividends.min() * 1.5:
                                    st.success("ğŸ’° **é…å½“å¤‰å‹•**: æ¥­ç¸¾é€£å‹•å‹ã®é…å½“æ”¿ç­–ã«ã‚ˆã‚Šã€å¥½èª¿æ™‚ã«ã¯å¤§å¹…ãªå¢—é…ã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # åŠå°ä½“ã‚µã‚¤ã‚¯ãƒ«ç‰¹æ€§
                            if avg_abs_error > 20:  # å¤§ããªäºˆæƒ³èª¤å·®
                                st.info("ğŸ”¬ **ã‚µã‚¤ã‚¯ãƒ«æ€§**: åŠå°ä½“ææ–™æ¥­ç•Œã®ç‰¹æ€§ä¸Šã€éœ€çµ¦ã‚µã‚¤ã‚¯ãƒ«ã«ã‚ˆã‚Šæ¥­ç¸¾ãŒå¤§ããå¤‰å‹•ã—ã¾ã™ã€‚")
                        
                        elif ticker == '4832.T':
                            # JFEã‚·ã‚¹ãƒ†ãƒ ã‚ºã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_avg_error = revenue_accuracy['Error_Rate'].mean()
                                if revenue_avg_error < 0:
                                    st.info("ğŸ¢ **JFEã‚·ã‚¹ãƒ†ãƒ ã‚ºã®ç‰¹å¾´**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¥­ã¨ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé€²æ—ã«ã‚ˆã‚Šå£²ä¸ŠãŒè¨ˆç”»ã‚’ä¸‹å›ã‚‹å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚")
                            
                            # åˆ©ç›Šç‡ã®å®‰å®šæ€§
                            op_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not op_accuracy.empty:
                                op_avg_error = op_accuracy['Error_Rate'].mean()
                                if abs(op_avg_error) < 10:
                                    st.success("ğŸ’¼ **åç›Šå®‰å®šæ€§**: å–¶æ¥­åˆ©ç›Šã¯æ¯”è¼ƒçš„äºˆæƒ³ã«è¿‘ãã€å®‰å®šã—ãŸåç›Šæ€§ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚")
                            
                            # æœŸä¸­ä¸Šæ–¹ä¿®æ­£ã®ç‰¹å¾´
                            modification_data = forecast_df[forecast_df['Type'] == 'ä¿®']
                            if not modification_data.empty:
                                upward_modifications = modification_data[
                                    (modification_data['Revenue'].notna()) & 
                                    (modification_data['Revenue'] > 0)
                                ]
                                if not upward_modifications.empty:
                                    st.info("ğŸ“ˆ **æœŸä¸­ä¿®æ­£**: æœŸä¸­ã§ã®ä¸Šæ–¹ä¿®æ­£ã«ã‚ˆã‚Šã€å—æ³¨ç’°å¢ƒã®æ”¹å–„ãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚")
                            
                            # é…å½“ã®å®‰å®šæ€§
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                dividend_growth = dividend_data['Dividend'].pct_change().dropna()
                                if dividend_growth.mean() > 0:
                                    st.success("ğŸ’° **é…å½“æˆé•·**: ç¶™ç¶šçš„ãªå¢—é…ã«ã‚ˆã‚Šæ ªä¸»é‚„å…ƒã‚’å¼·åŒ–ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # ITã‚µãƒ¼ãƒ“ã‚¹æ¥­ç•Œã®ç‰¹æ€§
                            if avg_abs_error < 15:  # æ¯”è¼ƒçš„ç²¾åº¦ãŒé«˜ã„
                                st.info("ğŸ’» **äº‹æ¥­ç‰¹æ€§**: ITã‚µãƒ¼ãƒ“ã‚¹æ¥­ã¨ã—ã¦ã€é•·æœŸå¥‘ç´„ã«ã‚ˆã‚Šæ¯”è¼ƒçš„å®‰å®šã—ãŸæ¥­ç¸¾äºˆæƒ³ç²¾åº¦ã‚’ä¿ã£ã¦ã„ã¾ã™ã€‚")
                        
                        elif ticker == '4767.T':
                            # ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼ã®ç‰¹å¾´
                            revenue_accuracy = accuracy_df[accuracy_df['Metric'] == 'Revenue']
                            if not revenue_accuracy.empty:
                                revenue_errors = revenue_accuracy['Error_Rate']
                                revenue_volatility = revenue_errors.std()
                                if revenue_volatility > 10:
                                    st.warning("ğŸ“¢ **åºƒå‘Šæ¥­ç•Œã®ç‰¹æ€§**: æ™¯æ°—å¤‰å‹•ã‚„é¡§å®¢äºˆç®—ã®å½±éŸ¿ã«ã‚ˆã‚Šã€å£²ä¸Šäºˆæƒ³ã®ç²¾åº¦ã«ã°ã‚‰ã¤ããŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚")
                            
                            # åˆ©ç›Šæ”¹å–„å‚¾å‘
                            profit_accuracy = accuracy_df[accuracy_df['Metric'] == 'Operating_Profit']
                            if not profit_accuracy.empty:
                                recent_profit_errors = profit_accuracy.tail(3)['Error_Rate']
                                if recent_profit_errors.mean() > 0:
                                    st.success("ğŸ“ˆ **åˆ©ç›Šæ”¹å–„**: è¿‘å¹´ã®å–¶æ¥­åˆ©ç›Šã¯äºˆæƒ³ã‚’ä¸Šå›ã‚‹å‚¾å‘ã«ã‚ã‚Šã€äº‹æ¥­åŠ¹ç‡åŒ–ãŒé€²ã‚“ã§ã„ã¾ã™ã€‚")
                            
                            # é…å½“æ”¿ç­–
                            dividend_data = forecast_df[forecast_df['Dividend'].notna() & (forecast_df['Dividend'] > 0)]
                            if not dividend_data.empty:
                                dividend_stability = dividend_data['Dividend'].std()
                                if dividend_stability < 5:
                                    st.info("ğŸ’° **å®‰å®šé…å½“**: æ¥­ç¸¾å¤‰å‹•ã«ã‹ã‹ã‚ã‚‰ãšã€ä¸€å®šæ°´æº–ã®é…å½“ç¶­æŒã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚")
                            
                            # åºƒå‘Šãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ¥­ç•Œã®ç‰¹æ€§
                            if avg_abs_error > 15:  # äºˆæƒ³ç²¾åº¦ã®ã°ã‚‰ã¤ã
                                st.info("ğŸ“Š **äº‹æ¥­ç‰¹æ€§**: åºƒå‘Šãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æ¥­ç•Œã¨ã—ã¦ã€çµŒæ¸ˆç’°å¢ƒã‚„é¡§å®¢äºˆç®—ã®å¤‰å‹•ã«ã‚ˆã‚Šæ¥­ç¸¾äºˆæƒ³ã®é›£æ˜“åº¦ãŒé«˜ã„æ¥­ç•Œã§ã™ã€‚")
            
            with tab3:
                st.write("**æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´è©³ç´°ãƒ‡ãƒ¼ã‚¿**")
                st.dataframe(forecast_df, use_container_width=True)
                
                if not accuracy_df.empty:
                    st.write("**äºˆæƒ³ç²¾åº¦è©³ç´°ãƒ‡ãƒ¼ã‚¿**")
                    st.dataframe(accuracy_df, use_container_width=True)
        
        st.write("---")
    
    if fundamental_data is not None:
        # ç¾åœ¨ã®å®Ÿç¸¾å€¤ã‚’å–å¾—
        latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1] / 1e2 if 'å£²ä¸Šé«˜' in fundamental_data.columns else 0
        latest_profit = fundamental_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1] / 1e2 if 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns else 0
        
        col_forecast1, col_forecast2 = st.columns(2)
        
        with col_forecast1:
            st.write("**ğŸ“Š å®Ÿç¸¾å€¤ï¼ˆæœ€æ–°æœŸï¼‰**")
            st.write(f"â€¢ å£²ä¸Šé«˜: {latest_revenue:.1f}å„„å††")
            st.write(f"â€¢ å–¶æ¥­åˆ©ç›Š: {latest_profit:.1f}å„„å††")
            if latest_revenue > 0:
                current_margin = (latest_profit / latest_revenue) * 100
                st.write(f"â€¢ å–¶æ¥­åˆ©ç›Šç‡: {current_margin:.1f}%")
        
        with col_forecast2:
            st.write("**ğŸ”® äºˆæƒ³å€¤å…¥åŠ›**")
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§äºˆæƒ³å€¤ã‚’ç®¡ç†
            forecast_key_revenue = f"forecast_revenue_{ticker}"
            forecast_key_profit = f"forecast_profit_{ticker}"
            
            # åˆæœŸå€¤ã‚’è¨­å®šï¼ˆä¸€åº¦ã ã‘ï¼‰
            if forecast_key_revenue not in st.session_state:
                st.session_state[forecast_key_revenue] = latest_revenue
            if forecast_key_profit not in st.session_state:
                st.session_state[forecast_key_profit] = max(latest_profit, 1.0)  # æœ€ä½1å„„å††
            
            # number_inputã®ã‚­ãƒ¼ã¯åˆ¥ã®åå‰ã«ã™ã‚‹
            forecast_revenue = st.number_input(
                "äºˆæƒ³å£²ä¸Šé«˜ (å„„å††)",
                min_value=0.0,
                value=float(st.session_state[forecast_key_revenue]),
                step=1.0,
                key=f"summary_input_revenue_{ticker}"
            )
            
            forecast_profit = st.number_input(
                "äºˆæƒ³å–¶æ¥­åˆ©ç›Š (å„„å††)",
                min_value=0.0,
                value=float(st.session_state[forecast_key_profit]),
                step=0.1,
                key=f"summary_input_profit_{ticker}"
            )
            
            # å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
            if forecast_revenue != st.session_state[forecast_key_revenue]:
                st.session_state[forecast_key_revenue] = forecast_revenue
            if forecast_profit != st.session_state[forecast_key_profit]:
                st.session_state[forecast_key_profit] = forecast_profit
            
            # äºˆæƒ³åˆ©ç›Šç‡ã®è¨ˆç®—ã¨è¡¨ç¤º
            if forecast_revenue > 0:
                forecast_margin = (forecast_profit / forecast_revenue) * 100
                
                if forecast_margin > 15:
                    margin_status = "ğŸŸ¢ é«˜åç›Šæ€§"
                elif forecast_margin > 5:
                    margin_status = "ğŸŸ¡ æ¨™æº–çš„"
                else:
                    margin_status = "ğŸ”´ ä½åç›Šæ€§"
                
                st.metric(
                    "äºˆæƒ³å–¶æ¥­åˆ©ç›Šç‡",
                    f"{forecast_margin:.1f}%",
                    f"{margin_status}"
                )
                
                # æˆé•·ç‡ã®è¨ˆç®—
                if latest_revenue > 0 and latest_profit > 0:
                    revenue_growth = ((forecast_revenue - latest_revenue) / latest_revenue) * 100
                    profit_growth = ((forecast_profit - latest_profit) / latest_profit) * 100
                    
                    st.write("**ğŸ“ˆ äºˆæƒ³æˆé•·ç‡**")
                    st.write(f"â€¢ å£²ä¸Šé«˜æˆé•·ç‡: {revenue_growth:+.1f}%")
                    st.write(f"â€¢ å–¶æ¥­åˆ©ç›Šæˆé•·ç‡: {profit_growth:+.1f}%")
            
            # ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ
            if st.button(f"ğŸ“Š {ticker} ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æ", key=f"summary_valuation_{ticker}"):
                if forecast_profit > 0:
                    # ç°¡æ˜“çš„ãªPERè¨ˆç®—ï¼ˆæ¥­ç•Œå¹³å‡PER 15å€ã¨ä»®å®šï¼‰
                    estimated_per = 15
                    estimated_market_cap = forecast_profit * estimated_per
                    current_market_cap = ticker_info.get('marketCap', 0) / 1e8 if ticker_info.get('marketCap') else 0
                    
                    st.success(f"""
                    **ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æçµæœ**
                    â€¢ äºˆæƒ³å–¶æ¥­åˆ©ç›Š: {forecast_profit:.1f}å„„å††
                    â€¢ æƒ³å®šPER: {estimated_per}å€
                    â€¢ ç†è«–æ™‚ä¾¡ç·é¡: {estimated_market_cap:.0f}å„„å††
                    â€¢ ç¾åœ¨æ™‚ä¾¡ç·é¡: {current_market_cap:.0f}å„„å††
                    â€¢ ç†è«–æ ªä¾¡å€ç‡: {(estimated_market_cap / max(current_market_cap, 1)):.1f}å€
                    """)
    else:
        st.info("è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€äºˆæƒ³å€¤è¨­å®šã¯ã§ãã¾ã›ã‚“ã€‚")
    
    # æŠ•è³‡ãƒ¡ãƒ¢
    st.subheader("ğŸ“ çµ±åˆåˆ†æãƒ¡ãƒ¢")
    investment_memo = st.text_area(
        "çµ±åˆåˆ†æã«åŸºã¥ãæŠ•è³‡åˆ¤æ–­ã®æ ¹æ‹ ",
        placeholder="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã¨ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã®çµæœã‚’ç·åˆã—ãŸæŠ•è³‡åˆ¤æ–­ã¨æ ¹æ‹ ã‚’è¨˜éŒ²...",
        height=100,
        key=f"summary_memo_{ticker}"
    )
    
    # è©³ç´°ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ
    if fundamental_data is not None:
        st.subheader('ğŸ¢ è©³ç´°ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ')
        key_metrics = ['å£²ä¸Šé«˜', 'å–¶æ¥­åˆ©ç›Š', 'å½“æœŸåˆ©ç›Š', 'ç·è³‡ç”£', 'è‡ªå·±è³‡æœ¬']
        available_metrics = [m for m in key_metrics if m in fundamental_data.columns]
        
        if available_metrics:
            selected_metrics = st.multiselect(
                'ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹æŒ‡æ¨™ã‚’é¸æŠ',
                options=fundamental_data.columns.tolist(),
                default=available_metrics[:3],
                key=f"summary_metrics_{ticker}"
            )
            
            if selected_metrics:
                fig = go.Figure()
                for metric in selected_metrics:
                    fig.add_trace(go.Scatter(
                        x=fundamental_data.index,
                        y=fundamental_data[metric] / 1e2,  # å„„å††
                        mode='lines+markers',
                        name=metric,
                        line=dict(width=2),
                        marker=dict(size=6)
                    ))
                
                fig.update_layout(
                    title='è²¡å‹™æŒ‡æ¨™ã®æ¨ç§»',
                    yaxis_title='é‡‘é¡ (å„„å††)',
                    height=400
                )
                st.plotly_chart(fig, use_container_width=True)

# --- Streamlit ã‚¢ãƒ—ãƒªæœ¬ä½“ ---
st.title('ğŸ“ˆ çµ±åˆæ ªå¼åˆ†æã‚¢ãƒ—ãƒª')
st.caption('ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã¨ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã‚’çµ±åˆã—ã€å¤šè§’çš„ãªè¦–ç‚¹ã‹ã‚‰æŠ•è³‡åˆ¤æ–­ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚')

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
st.sidebar.header('åˆ†ææ¡ä»¶ã®è¨­å®š')

# åˆ©ç”¨å¯èƒ½ãªè²¡å‹™ãƒ‡ãƒ¼ã‚¿éŠ˜æŸ„ã‚’è¡¨ç¤º
available_tickers = get_available_financial_tickers()
if available_tickers:
    st.sidebar.success(f'ğŸ“Š è²¡å‹™ãƒ‡ãƒ¼ã‚¿å¯¾å¿œéŠ˜æŸ„: {len(available_tickers)}ç¤¾')
    with st.sidebar.expander("å¯¾å¿œéŠ˜æŸ„ä¸€è¦§ã‚’è¡¨ç¤º"):
        for ticker in available_tickers:
            company_name = JAPANESE_COMPANY_NAMES.get(ticker, ticker)
            st.write(f"â€¢ {ticker} - {company_name}")

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
if 'ticker_selection' not in st.session_state:
    st.session_state.ticker_selection = ', '.join(available_tickers[:5]) if available_tickers else '4816.T, 6357.T, 2428.T'

# éŠ˜æŸ„é¸æŠã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
col1, col2 = st.sidebar.columns(2)
with col1:
    if st.button('ğŸ“‹ å…¨é¸æŠ', help='å…¨å¯¾å¿œéŠ˜æŸ„ã‚’é¸æŠ'):
        st.session_state.ticker_selection = ', '.join(available_tickers)
with col2:
    if st.button('ğŸ”„ ãƒªã‚»ãƒƒãƒˆ', help='ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™'):
        st.session_state.ticker_selection = ', '.join(available_tickers[:5]) if available_tickers else '4816.T, 6357.T, 2428.T'

ticker_list_input = st.sidebar.text_area(
    'ğŸ“Š åˆ†æã—ãŸã„éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š or æ”¹è¡Œï¼‰',
    value=st.session_state.ticker_selection,
    height=150,
    help='è²¡å‹™ãƒ‡ãƒ¼ã‚¿å¯¾å¿œéŠ˜æŸ„ï¼š4816.Tï¼ˆæ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã€6357.Tï¼ˆä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºï¼‰ã€2428.Tï¼ˆã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆï¼‰ç­‰\nå¯¾å¿œã™ã‚‹è²¡å‹™ãƒ‡ãƒ¼ã‚¿CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œç´¢ã—ã¾ã™'
)

# éŠ˜æŸ„ãƒªã‚¹ãƒˆã®å‡¦ç†
tickers = []
for line in ticker_list_input.split('\n'):
    line_tickers = [ticker.strip().upper() for ticker in line.split(',') if ticker.strip()]
    tickers.extend(line_tickers)

# æœŸé–“è¨­å®š
col1, col2 = st.sidebar.columns(2)
with col1:
    start_date = st.date_input('ğŸ“… é–‹å§‹æ—¥', value=datetime.now() - timedelta(days=365))
with col2:
    end_date = st.date_input('ğŸ“… çµ‚äº†æ—¥', value=datetime.now())

# çµ±åˆåˆ†æå®Ÿè¡Œ
if st.sidebar.button('ğŸš€ çµ±åˆåˆ†æå®Ÿè¡Œ', type="primary"):
    if not tickers:
        st.error('éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚')
    else:
        # --- ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨å‡¦ç† ---
        all_data = {}
        ticker_info_dict = {}
        fundamental_data_dict = {}
        summary_list = []
        
        with st.spinner('å„éŠ˜æŸ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...'):
            for ticker in tickers:
                try:
                    # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—
                    stock_data = yf.download(ticker, start=start_date, end=end_date, progress=False, auto_adjust=False)
                    if stock_data.empty:
                        st.warning(f'{ticker}: æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚')
                        continue
                    
                    stock_data = calculate_technicals(stock_data)
                    all_data[ticker] = stock_data
                    
                    # ä¼æ¥­æƒ…å ±ã‚’å–å¾—
                    ticker_info = yf.Ticker(ticker).info
                    ticker_info_dict[ticker] = ticker_info
                    
                    # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ¤œç´¢
                    csv_file = find_financial_csv(ticker)
                    if csv_file:
                        try:
                            fundamental_data = process_financial_csv(csv_file)
                            if fundamental_data is not None:
                                fundamental_data_dict[ticker] = fundamental_data
                                st.sidebar.success(f'{ticker}: è²¡å‹™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ ({csv_file})')
                            else:
                                st.sidebar.warning(f'{ticker}: è²¡å‹™ãƒ‡ãƒ¼ã‚¿å‡¦ç†å¤±æ•—')
                        except Exception as e:
                            st.sidebar.warning(f'{ticker}: è²¡å‹™ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ - {e}')
                    else:
                        st.sidebar.info(f'{ticker}: å¯¾å¿œã™ã‚‹è²¡å‹™ãƒ‡ãƒ¼ã‚¿CSVãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
                    
                    # ã‚µãƒãƒªãƒ¼æƒ…å ±ã®ä½œæˆ
                    latest_price = stock_data['Close'].iloc[-1].item()
                    prev_day_price = stock_data['Close'].iloc[-2].item()
                    change = latest_price - prev_day_price
                    change_percent = (change / prev_day_price) * 100 if prev_day_price != 0 else 0
                    
                    # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«æƒ…å ±ã®è¿½åŠ 
                    fundamental_info = ""
                    if ticker in fundamental_data_dict:
                        fund_data = fundamental_data_dict[ticker]
                        if 'å–¶æ¥­åˆ©ç›Š' in fund_data.columns and len(fund_data) > 1:
                            latest_profit = fund_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1] / 1e2  # å„„å††
                            prev_profit = fund_data['å–¶æ¥­åˆ©ç›Š'].iloc[-2] / 1e2
                            profit_growth = ((latest_profit - prev_profit) / prev_profit) * 100 if prev_profit != 0 else 0
                            fundamental_info = f"å–¶æ¥­åˆ©ç›Š: {latest_profit:.0f}å„„å†† ({profit_growth:+.1f}%)"
                        else:
                            fundamental_info = "è²¡å‹™ãƒ‡ãƒ¼ã‚¿åˆ©ç”¨å¯èƒ½"
                    else:
                        fundamental_info = "è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãªã—"
                    
                    summary_list.append({
                        'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰': ticker,
                        'ä¼æ¥­å': get_japanese_company_name(ticker, ticker_info),
                        'æœ€æ–°æ ªä¾¡ (å††)': f"{latest_price:,.2f}",
                        'å‰æ—¥æ¯” (%)': f"{change_percent:.2f}%",
                        'RSI': f"{stock_data['RSI'].iloc[-1].item():.2f}",
                        'æ™‚ä¾¡ç·é¡ (å„„å††)': f"{ticker_info.get('marketCap', 0) / 1e8:,.0f}" if ticker_info.get('marketCap') else 'N/A',
                        'ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«': fundamental_info
                    })
                    
                except Exception as e:
                    st.error(f'{ticker}ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: {e}')
        
        if not all_data:
            st.error('å–å¾—ã§ããŸéŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')
            st.stop()
        
        # --- çµ±åˆåˆ†æçµæœã®è¡¨ç¤º ---
        st.success(f'{len(all_data)}éŠ˜æŸ„ã®çµ±åˆåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸï¼')
# --- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨é–¢æ•° ---
def render_main_dashboard(all_data, ticker_info_dict, fundamental_data_dict, market_indices=None):
    """ãƒ¡ã‚¤ãƒ³ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®è¡¨ç¤º"""
    st.subheader('ğŸ“ˆ çµ±åˆæ ªå¼åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰')

    # å¸‚å ´æŒ‡æ¨™è¡¨ç¤º
    if market_indices and len(market_indices) > 0:
        with st.container(border=True):
            st.subheader('ğŸ›ï¸ å¸‚å ´æŒ‡æ¨™')
            col_market1, col_market2 = st.columns(2)
            
            with col_market1:
                if 'æ—¥çµŒå¹³å‡' in market_indices:
                    nikkei_data = market_indices['æ—¥çµŒå¹³å‡']
                    latest_nikkei = nikkei_data['Close'].iloc[-1]
                    prev_nikkei = nikkei_data['Close'].iloc[-2] if len(nikkei_data) > 1 else latest_nikkei
                    nikkei_change = ((latest_nikkei - prev_nikkei) / prev_nikkei) * 100 if prev_nikkei > 0 else 0
                    
                    st.metric(
                        "ğŸ“Š æ—¥çµŒå¹³å‡", 
                        f"{latest_nikkei:,.0f}å††",
                        f"{nikkei_change:+.2f}%"
                    )
            
            with col_market2:
                if 'TOPIX' in market_indices:
                    topix_data = market_indices['TOPIX']
                    latest_topix = topix_data['Close'].iloc[-1]
                    prev_topix = topix_data['Close'].iloc[-2] if len(topix_data) > 1 else latest_topix
                    topix_change = ((latest_topix - prev_topix) / prev_topix) * 100 if prev_topix > 0 else 0
                    
                    st.metric(
                        "ğŸ“ˆ TOPIX", 
                        f"{latest_topix:,.2f}pt",
                        f"{topix_change:+.2f}%"
                    )

    # ã‚µãƒãƒªãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    with st.container(border=True):
        st.subheader('ğŸ¯ ã‚µãƒãƒªãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹')
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ğŸ“Š åˆ†æå¯¾è±¡éŠ˜æŸ„æ•°", len(all_data))
        with col2:
            # å¹³å‡RSIè¨ˆç®—
            avg_rsi = np.mean([df['RSI'].iloc[-1] for df in all_data.values() if 'RSI' in df.columns])
            st.metric("ğŸ“ˆ å¹³å‡RSI", f"{avg_rsi:.1f}")
        with col3:
            # ä¸Šæ˜‡éŠ˜æŸ„æ•°
            up_count = sum(1 for df in all_data.values() if len(df) > 1 and df['Close'].iloc[-1] > df['Close'].iloc[-2])
            st.metric("ğŸŸ¢ å‰æ—¥æ¯”ä¸Šæ˜‡", f"{up_count}éŠ˜æŸ„")
        with col4:
            # ä¸‹è½éŠ˜æŸ„æ•°
            down_count = len(all_data) - up_count
            st.metric("ğŸ”´ å‰æ—¥æ¯”ä¸‹è½", f"{down_count}éŠ˜æŸ„")
    
    # éŠ˜æŸ„ã‚µãƒãƒªãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«
    with st.container(border=True):
        st.subheader('ğŸ’¼ éŠ˜æŸ„ã‚µãƒãƒªãƒ¼')
        
        summary_data = []
        for ticker, stock_data in all_data.items():
            company_name = get_japanese_company_name(ticker, ticker_info_dict.get(ticker, {}))
            latest_price = stock_data['Close'].iloc[-1]
            prev_price = stock_data['Close'].iloc[-2] if len(stock_data) > 1 else latest_price
            change_pct = ((latest_price - prev_price) / prev_price) * 100 if prev_price > 0 else 0
            rsi = stock_data['RSI'].iloc[-1] if 'RSI' in stock_data.columns else 0
            
            # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«æƒ…å ±
            fund_data = fundamental_data_dict.get(ticker)
            revenue = 0
            profit = 0
            
            if fund_data is not None:
                # 2025å¹´ä»¥å‰ã®å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨
                actual_data = fund_data[fund_data.index.year <= 2025]
                if not actual_data.empty:
                    if 'å£²ä¸Šé«˜' in actual_data.columns:
                        latest_revenue = actual_data['å£²ä¸Šé«˜'].dropna().iloc[-1] if not actual_data['å£²ä¸Šé«˜'].dropna().empty else 0
                        revenue = latest_revenue / 1e2 if latest_revenue > 0 else 0
                    
                    if 'å–¶æ¥­åˆ©ç›Š' in actual_data.columns:
                        latest_profit = actual_data['å–¶æ¥­åˆ©ç›Š'].dropna().iloc[-1] if not actual_data['å–¶æ¥­åˆ©ç›Š'].dropna().empty else 0
                        profit = latest_profit / 1e2 if latest_profit > 0 else 0
            
            # ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ï¼ˆPER, PBRï¼‰
            ticker_info = ticker_info_dict.get(ticker, {})
            per_value = ticker_info.get('trailingPE')
            if per_value is None or per_value <= 0:
                per_value = ticker_info.get('forwardPE')
            per_display = f"{per_value:.2f}" if per_value and per_value > 0 else "N/A"
            
            pbr_value = ticker_info.get('priceToBook')
            pbr_display = f"{pbr_value:.2f}" if pbr_value and pbr_value > 0 else "N/A"
            
            summary_data.append({
                'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰': ticker,
                'ä¼æ¥­å': company_name,
                'æœ€æ–°æ ªä¾¡(Â¥)': f"{latest_price:,.0f}",
                'å‰æ—¥æ¯”(%)': f"{change_pct:+.2f}",
                'RSI': f"{rsi:.1f}",
                'PER': per_display,
                'PBR': pbr_display,
                'å£²ä¸Šé«˜(å„„å††)': f"{revenue:.1f}" if revenue > 0 else "N/A",
                'å–¶æ¥­åˆ©ç›Š(å„„å††)': f"{profit:.1f}" if profit > 0 else "N/A",
                'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³': 'è©³ç´°åˆ†æ'
            })
        
        summary_df = pd.DataFrame(summary_data)
        
        # å‰æ—¥æ¯”ã®è‰²ä»˜ã‘ç”¨ã®é–¢æ•°
        def color_change_pct(val):
            """å‰æ—¥æ¯”ã®å€¤ã«åŸºã¥ã„ã¦è‰²ä»˜ã‘ã™ã‚‹"""
            try:
                # æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’å–å¾—ï¼ˆ+1.23 ã‚„ -2.45 ã®å½¢å¼ï¼‰
                if pd.isna(val) or val == '' or val is None:
                    return ''
                
                # æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›
                if isinstance(val, str):
                    num_val = float(val.replace('+', '').replace('%', ''))
                else:
                    num_val = float(val)
                    
                if num_val > 0:
                    return 'background-color: #ffebee; color: #d32f2f'  # è–„ã„èµ¤èƒŒæ™¯ã€æ¿ƒã„èµ¤æ–‡å­—
                elif num_val < 0:
                    return 'background-color: #e3f2fd; color: #1976d2'  # è–„ã„é’èƒŒæ™¯ã€æ¿ƒã„é’æ–‡å­—
                else:
                    return 'background-color: #f5f5f5; color: #666666'  # ã‚°ãƒ¬ãƒ¼
            except Exception as e:
                return ''
        
        # ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã®è¡¨ç¤ºï¼ˆã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ï¼‰
        try:
            styled_df = summary_df.style.apply(
                lambda x: [color_change_pct(val) if x.name == 'å‰æ—¥æ¯”(%)' else '' for val in x], 
                axis=0
            )
        except Exception as e:
            styled_df = summary_df
        
        # ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        try:
            selected_row = st.dataframe(
                styled_df,
                use_container_width=True,
                on_select="rerun",
                selection_mode="single-row"
            )
        except Exception as e:
            st.warning(f"ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {str(e)}")
            # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            st.dataframe(summary_df, use_container_width=True)
            selected_row = None
        
        # éŠ˜æŸ„é¸æŠå‡¦ç†
        if selected_row and hasattr(selected_row, 'selection') and selected_row.selection.rows:
            try:
                selected_idx = selected_row.selection.rows[0]
                selected_ticker = summary_df.iloc[selected_idx]['éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰']
                
                col_btn1, col_btn2 = st.columns([1, 4])
                with col_btn1:
                    if st.button(f"ğŸ“Š {selected_ticker} è©³ç´°åˆ†æ", use_container_width=True):
                        st.session_state.page = 'detail'
                        st.session_state.selected_ticker = selected_ticker
                        st.rerun()
            except Exception as e:
                st.warning(f"éŠ˜æŸ„é¸æŠã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ
    with st.container(border=True):
        st.subheader('ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ')
        
        col_chart1, col_chart2 = st.columns(2)
        
        with col_chart1:
            st.write("**æ­£è¦åŒ–æ ªä¾¡æ¨ç§»ï¼ˆåˆæ—¥=100ï¼‰**")
            if all_data:
                normalized_prices = pd.DataFrame()
                for ticker, df in all_data.items():
                    if not df.empty:
                        normalized_prices[ticker] = (df['Close'] / df['Close'].iloc[0]) * 100

                fig_perf = go.Figure()
                
                # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå¹³å‡
                if not normalized_prices.empty:
                    portfolio_avg = normalized_prices.mean(axis=1)
                    fig_perf.add_trace(go.Scatter(
                        x=portfolio_avg.index, 
                        y=portfolio_avg, 
                        mode='lines', 
                        name='ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå¹³å‡',
                        line=dict(color='blue', width=3)
                    ))
                    
                    # å€‹åˆ¥éŠ˜æŸ„ï¼ˆè–„ãè¡¨ç¤ºï¼‰
                    for ticker in list(normalized_prices.columns)[:5]:  # æœ€åˆã®5éŠ˜æŸ„ã®ã¿
                        fig_perf.add_trace(go.Scatter(
                            x=normalized_prices.index, 
                            y=normalized_prices[ticker], 
                            mode='lines', 
                            name=ticker,
                            line=dict(width=1),
                            opacity=0.4
                        ))
                
                fig_perf.update_layout(height=400, showlegend=True)
                st.plotly_chart(fig_perf, use_container_width=True)
        
        with col_chart2:
            st.write("**RSIåˆ†å¸ƒ**")
            rsi_values = [df['RSI'].iloc[-1] for df in all_data.values() if 'RSI' in df.columns]
            if rsi_values:
                fig_rsi = go.Figure(data=[go.Histogram(x=rsi_values, nbinsx=20)])
                fig_rsi.update_layout(
                    xaxis_title='RSIå€¤',
                    yaxis_title='éŠ˜æŸ„æ•°',
                    height=400
                )
                # RSIã®é–¾å€¤ç·š
                fig_rsi.add_vline(x=30, line_dash="dash", line_color="green", annotation_text="è²·ã‚ã‚Œã™ã")
                fig_rsi.add_vline(x=70, line_dash="dash", line_color="red", annotation_text="å£²ã‚‰ã‚Œã™ã")
                st.plotly_chart(fig_rsi, use_container_width=True)

def render_detail_page(ticker, stock_data, ticker_info, fundamental_data):
    """å€‹åˆ¥éŠ˜æŸ„è©³ç´°ãƒšãƒ¼ã‚¸ã®è¡¨ç¤º"""
    company_name = get_japanese_company_name(ticker, ticker_info)
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼
    col_header1, col_header2 = st.columns([3, 1])
    with col_header1:
        st.title(f'ğŸ“Š {company_name} ({ticker})')
    with col_header2:
        if st.button('â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹', use_container_width=True):
            st.session_state.page = 'dashboard'
            st.rerun()
    
    # ã‚¿ãƒ–æ§‹é€ 
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "ğŸ“ˆ æ¦‚è¦ï¼†ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«",
        "ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ", 
        "ğŸ“Š æ¥­ç¸¾äºˆæƒ³ç²¾åº¦åˆ†æ",
        "ğŸ” æ ªä¾¡å¤‰å‹•è¦å› åˆ†æ",
        "ğŸ¯ æŠ•è³‡åˆ¤æ–­"
    ])
    
    with tab1:
        render_summary_tab(ticker, stock_data, ticker_info, fundamental_data)
    
    with tab2:
        render_fundamental_tab(ticker, stock_data, fundamental_data)
    
    with tab3:
        render_forecast_tab(ticker)
    
    with tab4:
        render_price_analysis_tab(ticker, stock_data, fundamental_data)
    
    with tab5:
        render_investment_tab(ticker, stock_data, ticker_info, fundamental_data)

def render_summary_tab(ticker, stock_data, ticker_info, fundamental_data):
    """æ¦‚è¦ï¼†ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚¿ãƒ–ã®è¡¨ç¤º"""
    # ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    with st.container(border=True):
        st.subheader('ğŸ¯ ä¸»è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹')
        col1, col2, col3, col4, col5 = st.columns(5)
        
        with col1:
            latest_price = stock_data['Close'].iloc[-1]
            st.metric("ğŸ’° æœ€æ–°æ ªä¾¡", f"Â¥{latest_price:,.2f}")
        
        with col2:
            prev_price = stock_data['Close'].iloc[-2] if len(stock_data) > 1 else latest_price
            change = latest_price - prev_price
            change_pct = (change / prev_price) * 100 if prev_price > 0 else 0
            st.metric("ğŸ“ˆ å‰æ—¥æ¯”", f"{change_pct:.2f}%", f"Â¥{change:+.2f}")
        
        with col3:
            rsi_value = stock_data['RSI'].iloc[-1] if 'RSI' in stock_data.columns else 0
            rsi_signal = "ğŸ”¥éç†±" if rsi_value > 70 else "â„ï¸å£²ã‚‰ã‚Œã™ã" if rsi_value < 30 else "ğŸ˜ä¸­ç«‹"
            st.metric("ğŸ“Š RSI", f"{rsi_value:.1f}", rsi_signal)
        
        with col4:
            if fundamental_data is not None and not fundamental_data.empty and 'å£²ä¸Šé«˜' in fundamental_data.columns:
                # 2025å¹´ä»¥å‰ã®å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                revenue_series = fundamental_data['å£²ä¸Šé«˜'].dropna()
                try:
                    revenue_series.index = pd.to_datetime(revenue_series.index)
                    revenue_series = revenue_series[revenue_series.index.year <= 2025]
                except:
                    pass
                if not revenue_series.empty:
                    # ç™¾ä¸‡å††ã‚’å„„å††ã«å¤‰æ›ï¼ˆ1e2ã§å‰²ã‚‹ï¼‰
                    latest_revenue = revenue_series.iloc[-1] / 1e2
                    st.metric("ğŸ“Š å£²ä¸Šé«˜", f"{latest_revenue:.1f}å„„å††")
                else:
                    st.metric("ğŸ“Š å£²ä¸Šé«˜", "ãƒ‡ãƒ¼ã‚¿ãªã—")
            else:
                st.metric("ğŸ“Š å£²ä¸Šé«˜", "ãƒ‡ãƒ¼ã‚¿ãªã—")
        
        with col5:
            if fundamental_data is not None and not fundamental_data.empty and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
                # 2025å¹´ä»¥å‰ã®å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                profit_series = fundamental_data['å–¶æ¥­åˆ©ç›Š'].dropna()
                try:
                    profit_series.index = pd.to_datetime(profit_series.index)
                    profit_series = profit_series[profit_series.index.year <= 2025]
                except:
                    pass
                if not profit_series.empty:
                    # ç™¾ä¸‡å††ã‚’å„„å††ã«å¤‰æ›ï¼ˆ1e2ã§å‰²ã‚‹ï¼‰
                    latest_profit = profit_series.iloc[-1] / 1e2
                    st.metric("ğŸ’¼ å–¶æ¥­åˆ©ç›Š", f"{latest_profit:.1f}å„„å††")
                else:
                    st.metric("ğŸ’¼ å–¶æ¥­åˆ©ç›Š", "ãƒ‡ãƒ¼ã‚¿ãªã—")
            else:
                st.metric("ğŸ’¼ å–¶æ¥­åˆ©ç›Š", "ãƒ‡ãƒ¼ã‚¿ãªã—")
    
    # ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    with st.container(border=True):
        st.subheader('ğŸ“Š ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™')
        
        # ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã‚’å–å¾—
        valuation_metrics = get_valuation_metrics(ticker_info, fundamental_data)
        
        col_val1, col_val2, col_val3, col_val4 = st.columns(4)
        
        with col_val1:
            per_value = valuation_metrics.get('PER')
            if per_value is not None:
                # PERè©•ä¾¡ï¼ˆä¸€èˆ¬çš„ãªç›®å®‰ï¼š15å€ãŒæ¨™æº–ï¼‰
                if per_value < 10:
                    per_delta = "å‰²å®‰"
                    per_delta_color = "normal"
                elif per_value < 20:
                    per_delta = "æ¨™æº–"
                    per_delta_color = "off"
                else:
                    per_delta = "å‰²é«˜"
                    per_delta_color = "inverse"
                st.metric("ğŸ“ˆ PER", f"{per_value:.1f}å€", per_delta, delta_color=per_delta_color)
            else:
                st.metric("ğŸ“ˆ PER", "ãƒ‡ãƒ¼ã‚¿ãªã—")
        
        with col_val2:
            pbr_value = valuation_metrics.get('PBR')
            if pbr_value is not None:
                # PBRè©•ä¾¡ï¼ˆä¸€èˆ¬çš„ãªç›®å®‰ï¼š1å€ãŒç†è«–å€¤ï¼‰
                if pbr_value < 0.8:
                    pbr_delta = "å‰²å®‰"
                    pbr_delta_color = "normal"
                elif pbr_value < 1.5:
                    pbr_delta = "æ¨™æº–"
                    pbr_delta_color = "off"
                else:
                    pbr_delta = "å‰²é«˜"
                    pbr_delta_color = "inverse"
                st.metric("ğŸ“Š PBR", f"{pbr_value:.2f}å€", pbr_delta, delta_color=pbr_delta_color)
            else:
                st.metric("ğŸ“Š PBR", "ãƒ‡ãƒ¼ã‚¿ãªã—")
        
        with col_val3:
            roe_value = valuation_metrics.get('ROE')
            if roe_value is not None:
                # ROEè©•ä¾¡ï¼ˆä¸€èˆ¬çš„ãªç›®å®‰ï¼š8%ä»¥ä¸ŠãŒè‰¯å¥½ï¼‰
                if roe_value >= 15:
                    roe_delta = "å„ªç§€"
                    roe_delta_color = "normal"
                elif roe_value >= 8:
                    roe_delta = "è‰¯å¥½"
                    roe_delta_color = "normal"
                elif roe_value >= 5:
                    roe_delta = "æ¨™æº–"
                    roe_delta_color = "off"
                else:
                    roe_delta = "ä½æ°´æº–"
                    roe_delta_color = "inverse"
                st.metric("ğŸ’¼ ROE", f"{roe_value:.1f}%", roe_delta, delta_color=roe_delta_color)
            else:
                st.metric("ğŸ’¼ ROE", "ãƒ‡ãƒ¼ã‚¿ãªã—")
        
        with col_val4:
            dividend_yield = valuation_metrics.get('é…å½“åˆ©å›ã‚Š')
            if dividend_yield is not None:
                # é…å½“åˆ©å›ã‚Šè©•ä¾¡ï¼ˆä¸€èˆ¬çš„ãªç›®å®‰ï¼š3%ä»¥ä¸ŠãŒé«˜é…å½“ï¼‰
                if dividend_yield >= 4:
                    div_delta = "é«˜é…å½“"
                    div_delta_color = "normal"
                elif dividend_yield >= 2:
                    div_delta = "æ¨™æº–"
                    div_delta_color = "off"
                elif dividend_yield > 0:
                    div_delta = "ä½é…å½“"
                    div_delta_color = "inverse"
                else:
                    div_delta = "ç„¡é…"
                    div_delta_color = "inverse"
                st.metric("ğŸ’° é…å½“åˆ©å›ã‚Š", f"{dividend_yield:.2f}%", div_delta, delta_color=div_delta_color)
            else:
                st.metric("ğŸ’° é…å½“åˆ©å›ã‚Š", "ãƒ‡ãƒ¼ã‚¿ãªã—")
    
    # ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
    col_chart1, col_chart2 = st.columns(2)
    
    with col_chart1:
        with st.container(border=True):
            st.subheader('ğŸ“ˆ ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆ')
            fig_candle = create_candlestick_chart(stock_data, ticker, get_japanese_company_name(ticker, ticker_info))
            fig_candle.update_layout(height=500)
            st.plotly_chart(fig_candle, use_container_width=True)
    
    with col_chart2:
        with st.container(border=True):
            st.subheader('ğŸ“Š RSIæ¨ç§»')
            fig_rsi = create_rsi_chart(stock_data, ticker)
            fig_rsi.update_layout(height=500)
            st.plotly_chart(fig_rsi, use_container_width=True)
    
    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.markdown("---")
    with st.container(border=True):
        st.subheader('ğŸ“ˆ ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æï¼ˆéå»1å¹´é–“ï¼‰')
        
        # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨ˆç®—
        vol_metrics = calculate_volatility_metrics(stock_data)
        
        if vol_metrics:
            # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æŒ‡æ¨™è¡¨ç¤º
            col_vol1, col_vol2, col_vol3, col_vol4 = st.columns(4)
            
            with col_vol1:
                st.metric(
                    "å¹´é–“ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£", 
                    f"{vol_metrics['annual_volatility']:.1%}",
                    help="æ ªä¾¡ã®å¹´é–“å¤‰å‹•ç‡ã®æ¨™æº–åå·®"
                )
            
            with col_vol2:
                st.metric(
                    "æœˆé–“ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£", 
                    f"{vol_metrics['monthly_volatility']:.1%}",
                    help="æ ªä¾¡ã®æœˆé–“å¤‰å‹•ç‡ã®æ¨™æº–åå·®"
                )
            
            with col_vol3:
                st.metric(
                    "VaR (95%ä¿¡é ¼åŒºé–“)",
                    f"{vol_metrics['var_95']:.1%}",
                    help="5%ã®ç¢ºç‡ã§è¶…ãˆã‚‹1æ—¥ã®æå¤±ç‡"
                )
            
            with col_vol4:
                st.metric(
                    "VaR (99%ä¿¡é ¼åŒºé–“)",
                    f"{vol_metrics['var_99']:.1%}",
                    help="1%ã®ç¢ºç‡ã§è¶…ãˆã‚‹1æ—¥ã®æå¤±ç‡"
                )
            
            # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
            col_vol_chart1, col_vol_chart2 = st.columns(2)
            
            with col_vol_chart1:
                st.write("**ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¨ç§»ï¼ˆ30æ—¥ï¼‰**")
                fig_vol = create_rolling_volatility_chart(stock_data, ticker, window=30)
                st.plotly_chart(fig_vol, use_container_width=True)
            
            with col_vol_chart2:
                st.write("**ãƒªã‚¿ãƒ¼ãƒ³åˆ†å¸ƒãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ **")
                fig_hist = create_returns_histogram(vol_metrics['daily_returns'], ticker)
                st.plotly_chart(fig_hist, use_container_width=True)
            
            # æ¬¡å–¶æ¥­æ—¥ä¾¡æ ¼äºˆæ¸¬
            st.markdown("---")
            st.write("**ğŸ“Š æ¬¡å–¶æ¥­æ—¥ä¾¡æ ¼äºˆæ¸¬ï¼ˆãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ï¼‰**")
            
            # ä¿¡é ¼åŒºé–“ã”ã¨ã®äºˆæ¸¬ã‚’è¨ˆç®—
            prediction_68 = predict_next_day_price(vol_metrics, confidence_level=0.68)
            prediction_95 = predict_next_day_price(vol_metrics, confidence_level=0.95)
            prediction_997 = predict_next_day_price(vol_metrics, confidence_level=0.997)
            
            col_pred1, col_pred2, col_pred3, col_pred4 = st.columns(4)
            
            with col_pred1:
                current_price = vol_metrics['close_prices'].iloc[-1]
                st.metric("ç¾åœ¨ä¾¡æ ¼", f"Â¥{current_price:,.0f}")
            
            with col_pred2:
                if prediction_68:
                    expected_price = prediction_68['expected_price']
                    change_pct = (expected_price - current_price) / current_price
                    st.metric(
                        "æœŸå¾…ä¾¡æ ¼", 
                        f"Â¥{expected_price:,.0f}",
                        f"{change_pct:+.2%}"
                    )
            
            with col_pred3:
                if prediction_95:
                    st.metric(
                        "ä¾¡æ ¼ç¯„å›² (95%)", 
                        f"Â¥{prediction_95['lower_bound']:,.0f} - Â¥{prediction_95['upper_bound']:,.0f}",
                        help="95%ã®ç¢ºç‡ã§ã“ã®ç¯„å›²å†…"
                    )
            
            with col_pred4:
                if prediction_997:
                    st.metric(
                        "ä¾¡æ ¼ç¯„å›² (99.7%)", 
                        f"Â¥{prediction_997['lower_bound']:,.0f} - Â¥{prediction_997['upper_bound']:,.0f}",
                        help="99.7%ã®ç¢ºç‡ã§ã“ã®ç¯„å›²å†…"
                    )

def generate_financial_analysis_comments(fundamental_data, ticker):
    """è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è‡ªå‹•çš„ã«åˆ†æã‚³ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆ"""
    try:
        comments = []
        comments.append("**ğŸ“Š è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ä¼æ¥­ç‰¹å¾´:**\n")
        
        # å£²ä¸Šé«˜åˆ†æ
        if 'å£²ä¸Šé«˜' in fundamental_data.columns:
            revenue_data = fundamental_data['å£²ä¸Šé«˜'].dropna()
            if len(revenue_data) > 1:
                # æˆé•·ç‡è¨ˆç®—
                latest_revenue = revenue_data.iloc[-1] / 1e2  # å„„å††æ›ç®—
                prev_revenue = revenue_data.iloc[-2] / 1e2 if len(revenue_data) > 1 else latest_revenue
                growth_rate = ((latest_revenue - prev_revenue) / prev_revenue * 100) if prev_revenue > 0 else 0
                
                comments.append(f"â€¢ **å£²ä¸Šé«˜**: {latest_revenue:.1f}å„„å††")
                if growth_rate > 10:
                    comments.append(f"  - å‰å¹´æ¯” {growth_rate:+.1f}% ã®é«˜æˆé•· ğŸš€")
                elif growth_rate > 3:
                    comments.append(f"  - å‰å¹´æ¯” {growth_rate:+.1f}% ã®å …èª¿ãªæˆé•· ğŸ“ˆ")
                elif growth_rate > 0:
                    comments.append(f"  - å‰å¹´æ¯” {growth_rate:+.1f}% ã®å¾®å¢—æˆé•· ğŸ”„")
                elif growth_rate > -5:
                    comments.append(f"  - å‰å¹´æ¯” {growth_rate:+.1f}% ã®è»½å¾®ãªæ¸›å°‘ ğŸ“‰")
                else:
                    comments.append(f"  - å‰å¹´æ¯” {growth_rate:+.1f}% ã®å¤§å¹…æ¸›å°‘ âš ï¸")
                
                # å£²ä¸Šè¦æ¨¡åˆ†æ
                if latest_revenue > 1000:
                    comments.append("  - å¤§ä¼æ¥­è¦æ¨¡ï¼ˆå£²ä¸Š1000å„„å††è¶…ï¼‰")
                elif latest_revenue > 100:
                    comments.append("  - ä¸­å …ä¼æ¥­è¦æ¨¡ï¼ˆå£²ä¸Š100å„„å††å°ï¼‰")
                else:
                    comments.append("  - ä¸­å°ä¼æ¥­è¦æ¨¡ï¼ˆå£²ä¸Š100å„„å††æœªæº€ï¼‰")
        
        # å–¶æ¥­åˆ©ç›Šåˆ†æ
        if 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns and 'å£²ä¸Šé«˜' in fundamental_data.columns:
            profit_data = fundamental_data['å–¶æ¥­åˆ©ç›Š'].dropna()
            revenue_data = fundamental_data['å£²ä¸Šé«˜'].dropna()
            
            if len(profit_data) > 0 and len(revenue_data) > 0:
                latest_profit = profit_data.iloc[-1] / 1e2  # å„„å††æ›ç®—
                latest_revenue = revenue_data.iloc[-1] / 1e2
                margin = (latest_profit / latest_revenue * 100) if latest_revenue > 0 else 0
                
                comments.append(f"\nâ€¢ **å–¶æ¥­åˆ©ç›Š**: {latest_profit:.1f}å„„å††")
                comments.append(f"â€¢ **å–¶æ¥­åˆ©ç›Šç‡**: {margin:.1f}%")
                
                if margin > 15:
                    comments.append("  - éå¸¸ã«é«˜ã„åç›Šæ€§ â­â­â­")
                elif margin > 10:
                    comments.append("  - é«˜ã„åç›Šæ€§ â­â­")
                elif margin > 5:
                    comments.append("  - æ¨™æº–çš„ãªåç›Šæ€§ â­")
                elif margin > 0:
                    comments.append("  - ä½ã„åç›Šæ€§ âš ï¸")
                else:
                    comments.append("  - å–¶æ¥­èµ¤å­— ğŸ”´")
                
                # åˆ©ç›Šæˆé•·ç‡
                if len(profit_data) > 1:
                    prev_profit = profit_data.iloc[-2] / 1e2
                    profit_growth = ((latest_profit - prev_profit) / prev_profit * 100) if prev_profit != 0 else 0
                    
                    if profit_growth > 20:
                        comments.append(f"  - åˆ©ç›Šæˆé•·ç‡ {profit_growth:+.1f}% ã®æ€¥æˆé•· ğŸš€")
                    elif profit_growth > 10:
                        comments.append(f"  - åˆ©ç›Šæˆé•·ç‡ {profit_growth:+.1f}% ã®å¥½èª¿ãªæˆé•· ğŸ“ˆ")
                    elif profit_growth > 0:
                        comments.append(f"  - åˆ©ç›Šæˆé•·ç‡ {profit_growth:+.1f}% ã®å …èª¿ãªæˆé•· ğŸ”„")
                    else:
                        comments.append(f"  - åˆ©ç›Šæˆé•·ç‡ {profit_growth:+.1f}% ã®æ¸›ç›Š ğŸ“‰")
        
        # æ™‚ç³»åˆ—ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
        comments.append(f"\nâ€¢ **ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ**:")
        data_years = len(fundamental_data)
        if data_years >= 3:
            comments.append("  - 3å¹´ä»¥ä¸Šã®è²¡å‹™å±¥æ­´ãŒã‚ã‚Šã€ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æãŒå¯èƒ½")
        else:
            comments.append("  - è²¡å‹™å±¥æ­´ãŒçŸ­ãã€é•·æœŸãƒˆãƒ¬ãƒ³ãƒ‰ã®è©•ä¾¡ã¯å›°é›£")
        
        # æŠ•è³‡è¦³ç‚¹ã‚³ãƒ¡ãƒ³ãƒˆ
        comments.append(f"\nâ€¢ **æŠ•è³‡åˆ¤æ–­ã®è¦³ç‚¹**:")
        if 'å£²ä¸Šé«˜' in fundamental_data.columns and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
            revenue_data = fundamental_data['å£²ä¸Šé«˜'].dropna()
            profit_data = fundamental_data['å–¶æ¥­åˆ©ç›Š'].dropna()
            
            if len(revenue_data) > 1 and len(profit_data) > 1:
                latest_revenue = revenue_data.iloc[-1] / 1e2
                latest_profit = profit_data.iloc[-1] / 1e2
                margin = (latest_profit / latest_revenue * 100) if latest_revenue > 0 else 0
                
                if margin > 10 and latest_revenue > 100:
                    comments.append("  - è¦æ¨¡ã¨åç›Šæ€§ã‚’å…¼ã­å‚™ãˆãŸæŠ•è³‡å€™è£œ âœ…")
                elif margin > 5:
                    comments.append("  - å®‰å®šã—ãŸåç›ŠåŸºç›¤ã‚’æŒã¤ä¼æ¥­ ğŸ”")
                else:
                    comments.append("  - åç›Šæ”¹å–„ä½™åœ°ã®ã‚ã‚‹ä¼æ¥­ âš ï¸")
        
        return "\n".join(comments)
        
    except Exception as e:
        return f"**åˆ†æã‚¨ãƒ©ãƒ¼**: è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã®åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"

def render_fundamental_tab(ticker, stock_data, fundamental_data):
    """ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã‚¿ãƒ–ã®è¡¨ç¤º"""
    if fundamental_data is not None and not fundamental_data.empty:
        # è²¡å‹™æ¨ç§»ãƒãƒ£ãƒ¼ãƒˆ
        with st.container(border=True):
            st.subheader('ğŸ’¹ è²¡å‹™æŒ‡æ¨™æ¨ç§»')
            
            col_fund1, col_fund2 = st.columns(2)
            
            with col_fund1:
                st.write("**å£²ä¸Šé«˜æ¨ç§»**")
                if 'å£²ä¸Šé«˜' in fundamental_data.columns:
                    fig_revenue = go.Figure()
                    fig_revenue.add_trace(go.Scatter(
                        x=fundamental_data.index, 
                        y=fundamental_data['å£²ä¸Šé«˜'] / 1e2, 
                        mode='lines+markers',
                        name='å£²ä¸Šé«˜',
                        line=dict(color='blue', width=3)
                    ))
                    fig_revenue.update_layout(
                        yaxis_title='å£²ä¸Šé«˜ (å„„å††)',
                        height=300
                    )
                    st.plotly_chart(fig_revenue, use_container_width=True)
            
            with col_fund2:
                st.write("**å–¶æ¥­åˆ©ç›Šæ¨ç§»**")
                if 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
                    fig_profit = go.Figure()
                    fig_profit.add_trace(go.Scatter(
                        x=fundamental_data.index, 
                        y=fundamental_data['å–¶æ¥­åˆ©ç›Š'] / 1e2, 
                        mode='lines+markers',
                        name='å–¶æ¥­åˆ©ç›Š',
                        line=dict(color='green', width=3)
                    ))
                    fig_profit.update_layout(
                        yaxis_title='å–¶æ¥­åˆ©ç›Š (å„„å††)',
                        height=300
                    )
                    st.plotly_chart(fig_profit, use_container_width=True)
        
        # äºˆæƒ³å€¤å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³
        with st.container(border=True):
            st.subheader('ğŸ”® æ¥­ç¸¾äºˆæƒ³å…¥åŠ›')
            render_forecast_input(ticker, fundamental_data)
        
        # è²¡å‹™ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
        with st.container(border=True):
            st.subheader('ğŸ“‹ è²¡å‹™ãƒ‡ãƒ¼ã‚¿è©³ç´°')
            st.dataframe(fundamental_data, use_container_width=True)
            
            # è²¡å‹™ãƒ‡ãƒ¼ã‚¿è‡ªå‹•åˆ†æã‚³ãƒ¡ãƒ³ãƒˆ
            st.markdown("---")
            st.subheader('ğŸ¤– AIåˆ†æã‚³ãƒ¡ãƒ³ãƒˆ')
            auto_analysis = generate_financial_analysis_comments(fundamental_data, ticker)
            st.markdown(auto_analysis)
            
            # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†å¯èƒ½ãªåˆ†æãƒ¡ãƒ¢
            st.markdown("---")
            st.subheader('ğŸ“ ã‚ãªãŸã®åˆ†æãƒ¡ãƒ¢ (ç·¨é›†å¯èƒ½)')
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§ãƒ¡ãƒ¢ã‚’ç®¡ç†
            memo_key = f"financial_memo_{ticker}"
            if memo_key not in st.session_state:
                st.session_state[memo_key] = ""
            
            # ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã§ç·¨é›†å¯èƒ½ãªãƒ¡ãƒ¢
            user_memo = st.text_area(
                "è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰èª­ã¿å–ã‚Œã‚‹ä¼æ¥­ã®ç‰¹å¾´ã‚„æŠ•è³‡åˆ¤æ–­ã‚’ãƒ¡ãƒ¢ã—ã¦ãã ã•ã„ï¼š",
                value=st.session_state[memo_key],
                height=200,
                placeholder="""ä¾‹ï¼š
â€¢ å£²ä¸Šæˆé•·ç‡ãŒå®‰å®šã—ã¦ã„ã‚‹
â€¢ å–¶æ¥­åˆ©ç›Šç‡ãŒæ”¹å–„å‚¾å‘
â€¢ 2024å¹´ã®å¤§å¹…å¢—åã¯ä¸€éæ€§ã®è¦å› ã‹ç¶™ç¶šæ€§ãŒã‚ã‚‹ã‹è¦æ³¨æ„
â€¢ ç«¶åˆä»–ç¤¾ã¨æ¯”è¼ƒã—ã¦åˆ©ç›Šç‡ãŒé«˜ã„
â€¢ è¨­å‚™æŠ•è³‡ã®å¢—åŠ ãŒå°†æ¥ã®æˆé•·ã«ã¤ãªãŒã‚‹å¯èƒ½æ€§
""",
                key=f"fundamental_memo_input_{ticker}"
            )
            
            # ãƒ¡ãƒ¢ã‚’ä¿å­˜
            if st.button("ğŸ’¾ åˆ†æãƒ¡ãƒ¢ã‚’ä¿å­˜", key=f"save_fundamental_memo_{ticker}"):
                st.session_state[memo_key] = user_memo
                st.success("âœ… åˆ†æãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼")
            
            # ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢
            col_clear1, col_clear2 = st.columns([1, 4])
            with col_clear1:
                if st.button("ğŸ—‘ï¸ ãƒ¡ãƒ¢ã‚’ã‚¯ãƒªã‚¢", key=f"clear_fundamental_memo_{ticker}"):
                    st.session_state[memo_key] = ""
                    st.rerun()
    else:
        st.info("ğŸ’¡ ã“ã®ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚")
    
    # ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã®è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    with st.expander("ä¸»è¦ãªãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æŒ‡æ¨™ã®è§£èª¬ ğŸ’¡"):
        st.markdown("""
        ### ğŸ“ˆ PERï¼ˆæ ªä¾¡åç›Šç‡ / Price Earnings Ratioï¼‰
        
        **å®šç¾©**: æ ªä¾¡ãŒ1æ ªå½“ãŸã‚Šç´”åˆ©ç›Šã®ä½•å€ã‹ã‚’ç¤ºã™æŒ‡æ¨™
        
        $$\\text{PER} = \\frac{\\text{æ ªä¾¡}}{\\text{1æ ªå½“ãŸã‚Šç´”åˆ©ç›Šï¼ˆEPSï¼‰}}$$
        
        **ç›®å®‰**:
        - **10å€æœªæº€**: å‰²å®‰ã¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„
        - **10-20å€**: ä¸€èˆ¬çš„ãªæ°´æº–
        - **20å€è¶…**: å‰²é«˜ã¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„
        
        **æ³¨æ„ç‚¹**: æ¥­ç•Œã«ã‚ˆã£ã¦é©æ­£æ°´æº–ãŒç•°ãªã‚Šã¾ã™ã€‚æˆé•·ä¼æ¥­ã¯é«˜PERã§ã‚‚æ­£å½“åŒ–ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        
        ---
        
        ### ğŸ“Š PBRï¼ˆæ ªä¾¡ç´”è³‡ç”£å€ç‡ / Price Book-value Ratioï¼‰
        
        **å®šç¾©**: æ ªä¾¡ãŒ1æ ªå½“ãŸã‚Šç´”è³‡ç”£ã®ä½•å€ã‹ã‚’ç¤ºã™æŒ‡æ¨™
        
        $$\\text{PBR} = \\frac{\\text{æ ªä¾¡}}{\\text{1æ ªå½“ãŸã‚Šç´”è³‡ç”£ï¼ˆBPSï¼‰}}$$
        
        **ç›®å®‰**:
        - **1å€æœªæº€**: ç†è«–çš„ã«å‰²å®‰ï¼ˆè§£æ•£ä¾¡å€¤ã‚’ä¸‹å›ã‚‹ï¼‰
        - **1-1.5å€**: é©æ­£æ°´æº–
        - **1.5å€è¶…**: å‰²é«˜ã®å¯èƒ½æ€§
        
        **æ³¨æ„ç‚¹**: è³‡ç”£ã®è³ªã‚„åç›Šæ€§ã‚‚è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        
        ---
        
        ### ğŸ’¼ ROEï¼ˆè‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ / Return On Equityï¼‰
        
        **å®šç¾©**: è‡ªå·±è³‡æœ¬ã«å¯¾ã—ã¦ã©ã‚Œã ã‘ã®åˆ©ç›Šã‚’ä¸Šã’ãŸã‹ã‚’ç¤ºã™æŒ‡æ¨™
        
        $$\\text{ROE} = \\frac{\\text{å½“æœŸç´”åˆ©ç›Š}}{\\text{è‡ªå·±è³‡æœ¬}} \\times 100$$
        
        **ç›®å®‰**:
        - **15%ä»¥ä¸Š**: å„ªç§€
        - **8-15%**: è‰¯å¥½
        - **5-8%**: æ¨™æº–
        - **5%æœªæº€**: ä½æ°´æº–
        
        **æ³¨æ„ç‚¹**: é«˜ROEãŒå€Ÿå…¥ã«ã‚ˆã‚‹å ´åˆã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚æŒç¶šå¯èƒ½æ€§ã‚‚é‡è¦ã§ã™ã€‚
        
        ---
        
        ### ğŸ’° é…å½“åˆ©å›ã‚Šï¼ˆDividend Yieldï¼‰
        
        **å®šç¾©**: æ ªä¾¡ã«å¯¾ã™ã‚‹å¹´é–“é…å½“é‡‘ã®å‰²åˆ
        
        $$\\text{é…å½“åˆ©å›ã‚Š} = \\frac{\\text{å¹´é–“é…å½“é‡‘}}{\\text{æ ªä¾¡}} \\times 100$$
        
        **ç›®å®‰**:
        - **4%ä»¥ä¸Š**: é«˜é…å½“
        - **2-4%**: æ¨™æº–çš„é…å½“
        - **2%æœªæº€**: ä½é…å½“
        - **0%**: ç„¡é…å½“ï¼ˆæˆé•·æŠ•è³‡é‡è¦–ï¼‰
        
        **æ³¨æ„ç‚¹**: é«˜é…å½“ãŒæ¥­ç¸¾æ‚ªåŒ–ã«ã‚ˆã‚‹æ ªä¾¡ä¸‹è½ã®çµæœã§ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚é…å½“ã®æŒç¶šå¯èƒ½æ€§ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚
        
        ---
        
        ### ğŸ” ç·åˆçš„ãªåˆ¤æ–­ã®ãƒã‚¤ãƒ³ãƒˆ
        
        1. **å˜ä¸€æŒ‡æ¨™ã«ä¾å­˜ã—ãªã„**: è¤‡æ•°ã®æŒ‡æ¨™ã‚’çµ„ã¿åˆã‚ã›ã¦åˆ¤æ–­
        2. **æ¥­ç•Œæ¯”è¼ƒ**: åŒæ¥­ä»–ç¤¾ã¨ã®æ¯”è¼ƒãŒé‡è¦
        3. **æ™‚ç³»åˆ—åˆ†æ**: éå»ã®æ¨ç§»ã‚‚ç¢ºèª
        4. **å®šæ€§è¦å› **: çµŒå–¶æ–¹é‡ã€å¸‚å ´ç’°å¢ƒã€ç«¶åˆçŠ¶æ³ãªã©ã‚‚è€ƒæ…®
        5. **å°†æ¥æ€§**: éå»ã®å®Ÿç¸¾ã ã‘ã§ãªãå°†æ¥ã®æˆé•·æ€§ã‚‚è©•ä¾¡
        """)

def render_forecast_input(ticker, fundamental_data):
    """äºˆæƒ³å€¤å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³"""
    if fundamental_data is not None and not fundamental_data.empty:
        # æœ€æ–°ã®æœ‰åŠ¹ãªå®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆäºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã‚’é™¤ãï¼‰
        if 'å£²ä¸Šé«˜' in fundamental_data.columns:
            revenue_series = fundamental_data['å£²ä¸Šé«˜'].dropna()
            # 2025å¹´ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿç¸¾ã¨ã¿ãªã™ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ—¥ä»˜ã«å¤‰æ›ï¼‰
            try:
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ—¥ä»˜æ–‡å­—åˆ—ã®å ´åˆ
                revenue_series.index = pd.to_datetime(revenue_series.index)
                revenue_series = revenue_series[revenue_series.index.year <= 2025]
            except:
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ—¢ã«æ—¥ä»˜ã®å ´åˆã¾ãŸã¯ãã®ä»–ã®å½¢å¼
                pass
            # ç™¾ä¸‡å††ã‚’å„„å††ã«å¤‰æ›ï¼ˆ1e2ã§å‰²ã‚‹ï¼‰
            latest_revenue = revenue_series.iloc[-1] / 1e2 if not revenue_series.empty else 0
        else:
            latest_revenue = 0
            
        if 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
            profit_series = fundamental_data['å–¶æ¥­åˆ©ç›Š'].dropna()
            # 2025å¹´ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Ÿç¸¾ã¨ã¿ãªã™ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ—¥ä»˜ã«å¤‰æ›ï¼‰
            try:
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ—¥ä»˜æ–‡å­—åˆ—ã®å ´åˆ
                profit_series.index = pd.to_datetime(profit_series.index)
                profit_series = profit_series[profit_series.index.year <= 2025]
            except:
                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ—¢ã«æ—¥ä»˜ã®å ´åˆã¾ãŸã¯ãã®ä»–ã®å½¢å¼
                pass
            # ç™¾ä¸‡å††ã‚’å„„å††ã«å¤‰æ›ï¼ˆ1e2ã§å‰²ã‚‹ï¼‰
            latest_profit = profit_series.iloc[-1] / 1e2 if not profit_series.empty else 0
        else:
            latest_profit = 0
        
        col_current, col_forecast = st.columns(2)
        
        with col_current:
            st.write("**ğŸ“Š ç¾åœ¨ã®å®Ÿç¸¾å€¤**")
            st.write(f"â€¢ å£²ä¸Šé«˜: {latest_revenue:.1f}å„„å††")
            st.write(f"â€¢ å–¶æ¥­åˆ©ç›Š: {latest_profit:.1f}å„„å††")
            if latest_revenue > 0:
                current_margin = (latest_profit / latest_revenue) * 100
                st.write(f"â€¢ å–¶æ¥­åˆ©ç›Šç‡: {current_margin:.1f}%")
        
        with col_forecast:
            st.write("**ğŸ”® äºˆæƒ³å€¤å…¥åŠ›**")
            
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã§äºˆæƒ³å€¤ã‚’ç®¡ç†
            forecast_key_revenue = f"forecast_revenue_{ticker}"
            forecast_key_profit = f"forecast_profit_{ticker}"
            
            # åˆæœŸå€¤ã‚’è¨­å®šï¼ˆä¸€åº¦ã ã‘ï¼‰
            if forecast_key_revenue not in st.session_state:
                # å£²ä¸Šé«˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼šæœ€æ–°å®Ÿç¸¾å€¤ã€ã¾ãŸã¯nanã®å ´åˆã¯100å„„å††
                default_revenue = latest_revenue if not pd.isna(latest_revenue) and latest_revenue > 0 else 100.0
                st.session_state[forecast_key_revenue] = default_revenue
            if forecast_key_profit not in st.session_state:
                # å–¶æ¥­åˆ©ç›Šã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼šæœ€æ–°å®Ÿç¸¾å€¤ã€ã¾ãŸã¯nanã®å ´åˆã¯5å„„å††
                default_profit = latest_profit if not pd.isna(latest_profit) and latest_profit > 0 else 5.0
                st.session_state[forecast_key_profit] = default_profit
            
            forecast_revenue = st.number_input(
                "äºˆæƒ³å£²ä¸Šé«˜ (å„„å††)",
                min_value=0.0,
                value=float(st.session_state[forecast_key_revenue]),
                step=1.0,
                key=f"forecast_revenue_{ticker}"
            )
            
            forecast_profit = st.number_input(
                "äºˆæƒ³å–¶æ¥­åˆ©ç›Š (å„„å††)", 
                min_value=0.0,
                value=float(st.session_state[forecast_key_profit]),
                step=0.1,
                key=f"forecast_profit_{ticker}"
            )
            
            # å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°
            if forecast_revenue != st.session_state[forecast_key_revenue]:
                st.session_state[forecast_key_revenue] = forecast_revenue
            if forecast_profit != st.session_state[forecast_key_profit]:
                st.session_state[forecast_key_profit] = forecast_profit
            
            # äºˆæƒ³åˆ©ç›Šç‡ã®è¨ˆç®—
            if forecast_revenue > 0:
                forecast_margin = (forecast_profit / forecast_revenue) * 100
                
                # ç•°å¸¸å€¤ã®ãƒã‚§ãƒƒã‚¯ï¼ˆ1000%ã‚’è¶…ãˆã‚‹å ´åˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
                if forecast_margin > 1000:
                    st.warning("âš ï¸ äºˆæƒ³å–¶æ¥­åˆ©ç›Šç‡ãŒç•°å¸¸ã«é«˜ããªã£ã¦ã„ã¾ã™ã€‚å£²ä¸Šé«˜ã¨å–¶æ¥­åˆ©ç›Šã®å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
                    st.metric("äºˆæƒ³å–¶æ¥­åˆ©ç›Šç‡", "è¨ˆç®—ä¸å¯", "ğŸ“Š è¦ç¢ºèª")
                else:
                    if forecast_margin > 15:
                        margin_status = "ğŸŸ¢ é«˜åç›Šæ€§"
                    elif forecast_margin > 5:
                        margin_status = "ğŸŸ¡ æ¨™æº–çš„" 
                    else:
                        margin_status = "ğŸ”´ ä½åç›Šæ€§"
                    
                    st.metric("äºˆæƒ³å–¶æ¥­åˆ©ç›Šç‡", f"{forecast_margin:.1f}%", margin_status)
            else:
                st.metric("äºˆæƒ³å–¶æ¥­åˆ©ç›Šç‡", "è¨ˆç®—ä¸å¯", "ğŸ“Š å£²ä¸Šé«˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

def render_forecast_tab(ticker):
    """æ¥­ç¸¾äºˆæƒ³ç²¾åº¦åˆ†æã‚¿ãƒ–ã®è¡¨ç¤º"""
    # å¯¾å¿œéŠ˜æŸ„ã®æ¥­ç¸¾äºˆæƒ³å±¥æ­´åˆ†æ
    forecast_data = None
    company_display = ""
    
    if ticker == '6357.T':
        forecast_data = FORECAST_TEXT_6357
        company_display = "ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º"
    elif ticker == '4816.T':
        forecast_data = FORECAST_TEXT_4816
        company_display = "æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"
    elif ticker == '2991.T':
        forecast_data = FORECAST_TEXT_2991
        company_display = "ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆ"
    elif ticker == '7564.T':
        forecast_data = FORECAST_TEXT_7564
        company_display = "ãƒ¯ãƒ¼ã‚¯ãƒãƒ³"
    elif ticker == '7711.T':
        forecast_data = FORECAST_TEXT_7711
        company_display = "åŠ©å·é›»æ°—å·¥æ¥­"
    elif ticker == '6405.T':
        forecast_data = FORECAST_TEXT_6405
        company_display = "éˆ´èŒ‚å™¨å·¥"
    elif ticker == '2428.T':
        forecast_data = FORECAST_TEXT_2428
        company_display = "ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆ"
    elif ticker == '6231.T':
        forecast_data = FORECAST_TEXT_6231
        company_display = "æœ¨æ‘å·¥æ©Ÿ"
    elif ticker == '6855.T':
        forecast_data = FORECAST_TEXT_6855
        company_display = "æ—¥æœ¬é›»å­ææ–™"
    elif ticker == '4832.T':
        forecast_data = FORECAST_TEXT_4832
        company_display = "JFEã‚·ã‚¹ãƒ†ãƒ ã‚º"
    elif ticker == '4767.T':
        forecast_data = FORECAST_TEXT_4767
        company_display = "ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼"
    
    if forecast_data:
        with st.container(border=True):
            st.subheader(f"ğŸ“Š {company_display} æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´åˆ†æ")
            
            # æ¥­ç¸¾äºˆæƒ³å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®è§£æ
            forecast_df = parse_forecast_history(forecast_data)
            
            if not forecast_df.empty:
                # ã‚µãƒ–ã‚¿ãƒ–ã§åˆ†æçµæœã‚’è¡¨ç¤º
                subtab1, subtab2, subtab3 = st.tabs(["ğŸ“ˆ äºˆæƒ³vså®Ÿç¸¾æ¨ç§»", "ğŸ¯ äºˆæƒ³ç²¾åº¦åˆ†æ", "ğŸ“‹ è©³ç´°ãƒ‡ãƒ¼ã‚¿"])
                
                with subtab1:
                    st.write("**æ¥­ç¸¾äºˆæƒ³ã¨å®Ÿç¸¾ã®æ¨ç§»**")
                    accuracy_df = analyze_forecast_accuracy(forecast_df)
                    charts = create_forecast_analysis_charts(forecast_df, accuracy_df)
                    
                    if 'trend' in charts:
                        st.plotly_chart(charts['trend'], use_container_width=True)
                
                with subtab2:
                    accuracy_df = analyze_forecast_accuracy(forecast_df)
                    if not accuracy_df.empty:
                        st.write("**äºˆæƒ³ç²¾åº¦ã‚µãƒãƒªãƒ¼**")
                        # ç²¾åº¦åˆ†æã®è©³ç´°è¡¨ç¤º
                        render_forecast_accuracy_analysis(accuracy_df, forecast_df, ticker)
                    else:
                        st.info("äºˆæƒ³ç²¾åº¦ã®åˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™ã€‚")
                
                with subtab3:
                    st.write("**æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´è©³ç´°ãƒ‡ãƒ¼ã‚¿**")
                    st.dataframe(forecast_df, use_container_width=True)
            else:
                st.warning("âš ï¸ æ¥­ç¸¾äºˆæƒ³ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    else:
        st.info("ğŸ’¡ ã“ã®ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã®æ¥­ç¸¾äºˆæƒ³ä¿®æ­£å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã¯ã¾ã å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚")

def render_price_analysis_tab(ticker, stock_data, fundamental_data):
    """æ ªä¾¡å¤‰å‹•è¦å› åˆ†æã‚¿ãƒ–ã®è¡¨ç¤º"""
    with st.container(border=True):
        st.subheader('ğŸ” æ ªä¾¡å¤‰å‹•è¦å› åˆ†æ')
        
        # æ ªä¾¡å¤‰å‹•è¦å› ã®åˆ†æã‚’å®Ÿè¡Œ
        price_factors = analyze_price_movement_factors(stock_data, fundamental_data, ticker)
        
        if price_factors:
            st.write("**æœ€è¿‘ã®ä¸»è¦ãªæ ªä¾¡å¤‰å‹•ã¨ãã®è¦å› **")
            
            # ä¸Šæ˜‡ã¨ä¸‹è½ã‚’åˆ†ã‘ã¦è¡¨ç¤º
            upward_moves = [move for move in price_factors if move['Move_Type'] == 'ä¸Šæ˜‡']
            downward_moves = [move for move in price_factors if move['Move_Type'] == 'ä¸‹è½']
            
            col_up, col_down = st.columns(2)
            
            with col_up:
                with st.container(border=True):
                    st.write("**ğŸŸ¢ ä¸Šæ˜‡è¦å› åˆ†æ**")
                    if upward_moves:
                        for i, move in enumerate(upward_moves[:3]):
                            with st.expander(f"ğŸ“ˆ {move['Date']} ({move['Move_Percent']})"):
                                st.write(f"**ä¾¡æ ¼**: Â¥{move['Price']:,.2f}")
                                st.write(f"**å‡ºæ¥é«˜**: {move['Volume']:,}")
                                
                                if move['Technical_Factors']:
                                    st.write("**ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **:")
                                    for factor in move['Technical_Factors']:
                                        st.write(f"â€¢ {factor}")
                                
                                if move['Fundamental_Factors']:
                                    st.write("**ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **:")
                                    for factor in move['Fundamental_Factors']:
                                        st.write(f"â€¢ {factor}")
                                
                                if move['Sector_Factors']:
                                    st.write("**æ¥­ç•Œç‰¹æœ‰è¦å› **:")
                                    for factor in move['Sector_Factors']:
                                        st.write(f"â€¢ {factor}")
                    else:
                        st.info("å¤§ããªä¸Šæ˜‡ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“")
            
            with col_down:
                with st.container(border=True):
                    st.write("**ğŸ”´ ä¸‹è½è¦å› åˆ†æ**")
                    if downward_moves:
                        for i, move in enumerate(downward_moves[:3]):
                            with st.expander(f"ğŸ“‰ {move['Date']} ({move['Move_Percent']})"):
                                st.write(f"**ä¾¡æ ¼**: Â¥{move['Price']:,.2f}")
                                st.write(f"**å‡ºæ¥é«˜**: {move['Volume']:,}")
                                
                                if move['Technical_Factors']:
                                    st.write("**ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **:")
                                    for factor in move['Technical_Factors']:
                                        st.write(f"â€¢ {factor}")
                                
                                if move['Fundamental_Factors']:
                                    st.write("**ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **:")
                                    for factor in move['Fundamental_Factors']:
                                        st.write(f"â€¢ {factor}")
                                
                                if move['Sector_Factors']:
                                    st.write("**æ¥­ç•Œç‰¹æœ‰è¦å› **:")
                                    for factor in move['Sector_Factors']:
                                        st.write(f"â€¢ {factor}")
                    else:
                        st.info("å¤§ããªä¸‹è½ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“")
            
            # è¦å› ã‚µãƒãƒªãƒ¼
            with st.container(border=True):
                st.write("**ğŸ“Š è¦å› ã‚µãƒãƒªãƒ¼**")
                render_factor_summary(price_factors)
        else:
            st.info("å¤§ããªæ ªä¾¡å¤‰å‹•ã¯ç¢ºèªã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ5%ä»¥ä¸Šã®å¤‰å‹•ã‚’å¯¾è±¡ï¼‰")

def render_factor_summary(price_factors):
    """è¦å› ã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º"""
    all_technical = []
    all_fundamental = []
    all_sector = []
    
    for move in price_factors:
        all_technical.extend(move['Technical_Factors'])
        all_fundamental.extend(move['Fundamental_Factors'])
        all_sector.extend(move['Sector_Factors'])
    
    col_summary1, col_summary2, col_summary3 = st.columns(3)
    
    with col_summary1:
        st.write("**ä¸»è¦ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«è¦å› **")
        technical_counts = pd.Series(all_technical).value_counts()
        if not technical_counts.empty:
            for factor, count in technical_counts.head(3).items():
                st.write(f"â€¢ {factor} ({count}å›)")
        else:
            st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")
    
    with col_summary2:
        st.write("**ä¸»è¦ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«è¦å› **")
        fundamental_counts = pd.Series(all_fundamental).value_counts()
        if not fundamental_counts.empty:
            for factor, count in fundamental_counts.head(3).items():
                st.write(f"â€¢ {factor} ({count}å›)")
        else:
            st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")
    
    with col_summary3:
        st.write("**ä¸»è¦æ¥­ç•Œè¦å› **")
        sector_counts = pd.Series(all_sector).value_counts()
        if not sector_counts.empty:
            for factor, count in sector_counts.head(3).items():
                st.write(f"â€¢ {factor} ({count}å›)")
        else:
            st.write("â€¢ ç‰¹å¾´çš„ãªè¦å› ãªã—")

def render_investment_tab(ticker, stock_data, ticker_info, fundamental_data):
    """æŠ•è³‡åˆ¤æ–­ã‚¿ãƒ–ã®è¡¨ç¤º"""
    # çµ±åˆæŠ•è³‡åˆ¤æ–­
    with st.container(border=True):
        st.subheader('ğŸ¯ çµ±åˆæŠ•è³‡åˆ¤æ–­')
        
        col_tech, col_fund = st.columns(2)
        
        with col_tech:
            st.write("**ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã‚·ã‚°ãƒŠãƒ«**")
            render_technical_signals(stock_data)
        
        with col_fund:
            st.write("**ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã‚·ã‚°ãƒŠãƒ«**")
            render_fundamental_signals(fundamental_data)
    
    # æŠ•è³‡åˆ¤æ–­ãƒœã‚¿ãƒ³
    with st.container(border=True):
        st.subheader('ğŸ¯ æŠ•è³‡åˆ¤æ–­')
        col1, col2, col3 = st.columns(3)
        
        company_name = get_japanese_company_name(ticker, ticker_info)
        
        with col1:
            if st.button(f"ğŸŸ¢ {ticker} è²·ã„æ¨å¥¨", key=f"investment_buy_{ticker}", use_container_width=True):
                st.success(f"{company_name} ã‚’è²·ã„æ¨å¥¨ã¨ã—ã¦è¨˜éŒ²")
        
        with col2:
            if st.button(f"ğŸŸ¡ {ticker} æ§˜å­è¦‹", key=f"investment_hold_{ticker}", use_container_width=True):
                st.warning(f"{company_name} ã‚’æ§˜å­è¦‹ã¨ã—ã¦è¨˜éŒ²")
        
        with col3:
            if st.button(f"ğŸ”´ {ticker} å£²ã‚Šæ¨å¥¨", key=f"investment_sell_{ticker}", use_container_width=True):
                st.error(f"{company_name} ã‚’å£²ã‚Šæ¨å¥¨ã¨ã—ã¦è¨˜éŒ²")
    
    # æŠ•è³‡ãƒ¡ãƒ¢
    with st.container(border=True):
        st.subheader("ğŸ“ æŠ•è³‡åˆ†æãƒ¡ãƒ¢")
        memo_key = f"investment_memo_{ticker}"
        
        investment_memo = st.text_area(
            "æŠ•è³‡åˆ¤æ–­ã®æ ¹æ‹ ã‚„ãƒ¡ãƒ¢ã‚’è¨˜éŒ²:",
            height=150,
            key=memo_key,
            placeholder="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã¨ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æã®çµæœã‚’ç·åˆã—ãŸæŠ•è³‡åˆ¤æ–­ã¨æ ¹æ‹ ã‚’è¨˜éŒ²..."
        )
        
        if st.button("ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜", key=f"save_investment_memo_{ticker}"):
            st.success("æŠ•è³‡ãƒ¡ãƒ¢ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼")

def render_technical_signals(stock_data):
    """ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ã‚·ã‚°ãƒŠãƒ«ã®è¡¨ç¤º"""
    rsi = stock_data['RSI'].iloc[-1] if 'RSI' in stock_data.columns else 50
    
    if rsi > 70:
        st.error("ğŸ”´ RSIå£²ã‚Šã‚·ã‚°ãƒŠãƒ«ï¼ˆéç†±çŠ¶æ…‹ï¼‰")
    elif rsi < 30:
        st.success("ğŸŸ¢ RSIè²·ã„ã‚·ã‚°ãƒŠãƒ«ï¼ˆå£²ã‚‰ã‚Œã™ãï¼‰")
    else:
        st.info("ğŸŸ¡ RSIä¸­ç«‹ï¼ˆæ§˜å­è¦‹ï¼‰")
    
    # ç§»å‹•å¹³å‡ç·šã‚·ã‚°ãƒŠãƒ«
    if 'MA20' in stock_data.columns and 'MA50' in stock_data.columns:
        current_price = stock_data['Close'].iloc[-1]
        ma20 = stock_data['MA20'].iloc[-1]
        ma50 = stock_data['MA50'].iloc[-1]
        
        if current_price > ma20 > ma50:
            st.success("ğŸŸ¢ ç§»å‹•å¹³å‡ç·šä¸Šæ˜‡ãƒˆãƒ¬ãƒ³ãƒ‰")
        elif current_price < ma20 < ma50:
            st.error("ğŸ”´ ç§»å‹•å¹³å‡ç·šä¸‹é™ãƒˆãƒ¬ãƒ³ãƒ‰")
        else:
            st.warning("ğŸŸ¡ ç§»å‹•å¹³å‡ç·šãƒ¬ãƒ³ã‚¸ç›¸å ´")

def render_fundamental_signals(fundamental_data):
    """ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚·ã‚°ãƒŠãƒ«ã®è¡¨ç¤º"""
    if fundamental_data is not None and not fundamental_data.empty:
        # å£²ä¸Šæˆé•·ç‡
        if 'å£²ä¸Šé«˜' in fundamental_data.columns and len(fundamental_data) > 1:
            latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
            prev_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-2]
            revenue_growth = ((latest_revenue - prev_revenue) / prev_revenue) * 100 if prev_revenue > 0 else 0
            
            if revenue_growth > 10:
                st.success(f"ğŸŸ¢ å£²ä¸Šé«˜æˆé•·: +{revenue_growth:.1f}%")
            elif revenue_growth > 0:
                st.info(f"ğŸŸ¡ å£²ä¸Šé«˜å¾®å¢—: +{revenue_growth:.1f}%")
            else:
                st.error(f"ğŸ”´ å£²ä¸Šé«˜æ¸›å°‘: {revenue_growth:.1f}%")
        
        # å–¶æ¥­åˆ©ç›Šç‡
        if 'å£²ä¸Šé«˜' in fundamental_data.columns and 'å–¶æ¥­åˆ©ç›Š' in fundamental_data.columns:
            latest_revenue = fundamental_data['å£²ä¸Šé«˜'].iloc[-1]
            latest_profit = fundamental_data['å–¶æ¥­åˆ©ç›Š'].iloc[-1]
            
            if latest_revenue > 0:
                margin = (latest_profit / latest_revenue) * 100
                
                if margin > 15:
                    st.success(f"ğŸŸ¢ é«˜åç›Šæ€§: {margin:.1f}%")
                elif margin > 5:
                    st.info(f"ğŸŸ¡ æ¨™æº–çš„: {margin:.1f}%")
                else:
                    st.error(f"ğŸ”´ ä½åç›Šæ€§: {margin:.1f}%")
    else:
        st.info("ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“")

def render_forecast_accuracy_analysis(accuracy_df, forecast_df, ticker):
    """æ¥­ç¸¾äºˆæƒ³ç²¾åº¦åˆ†æã®è©³ç´°è¡¨ç¤º"""
    if not accuracy_df.empty:
        # ç²¾åº¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹
        avg_abs_error = accuracy_df['Error_Rate'].abs().mean()
        
        col_acc1, col_acc2, col_acc3 = st.columns(3)
        
        with col_acc1:
            if avg_abs_error < 5:
                precision_grade = "ğŸ¯ é«˜ç²¾åº¦"
                precision_color = "success"
            elif avg_abs_error < 15:
                precision_grade = "ğŸ‘ æ¨™æº–çš„"
                precision_color = "info"
            else:
                precision_grade = "âš ï¸ ä½ç²¾åº¦"
                precision_color = "warning"
            
            st.metric("äºˆæƒ³ç²¾åº¦", precision_grade, f"å¹³å‡èª¤å·®ç‡: {avg_abs_error:.1f}%")
        
        with col_acc2:
            positive_errors = (accuracy_df['Error_Rate'] > 0).sum()
            total_forecasts = len(accuracy_df)
            upward_bias = (positive_errors / total_forecasts) * 100 if total_forecasts > 0 else 0
            
            if upward_bias > 60:
                bias_type = "æ¥½è¦³çš„"
            elif upward_bias < 40:
                bias_type = "ä¿å®ˆçš„"
            else:
                bias_type = "ãƒãƒ©ãƒ³ã‚¹å‹"
            
            st.metric("äºˆæƒ³å‚¾å‘", bias_type, f"ä¸ŠæŒ¯ã‚Œç‡: {upward_bias:.0f}%")
        
        with col_acc3:
            # æœ€æ–°å¹´åº¦ã®ç²¾åº¦
            latest_fy = accuracy_df['FY'].max()
            latest_accuracy = accuracy_df[accuracy_df['FY'] == latest_fy]['Error_Rate'].abs().mean()
            st.metric("æœ€æ–°å¹´åº¦ç²¾åº¦", f"{latest_accuracy:.1f}%", f"FY{latest_fy}")

# --- ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ãƒªã‚¹ã‚¯åˆ†ææ©Ÿèƒ½ ---
def calculate_volatility_metrics(data):
    """ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ãƒªã‚¹ã‚¯æŒ‡æ¨™ã‚’è¨ˆç®—"""
    try:
        # æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³ã®è¨ˆç®—
        if isinstance(data.columns, pd.MultiIndex):
            close_prices = data.iloc[:, data.columns.get_level_values(0) == 'Close'].iloc[:, 0]
        else:
            close_prices = data['Close']
        
        daily_returns = close_prices.pct_change().dropna()
        
        # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—ï¼ˆå¹´ç‡æ›ç®—ï¼‰
        daily_volatility = daily_returns.std()
        annual_volatility = daily_volatility * np.sqrt(252)  # å¹´é–“å–¶æ¥­æ—¥252æ—¥
        
        # æœˆæ¬¡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£
        monthly_volatility = daily_volatility * np.sqrt(22)  # æœˆé–“å–¶æ¥­æ—¥22æ—¥
        
        # å››åŠæœŸãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£
        quarterly_volatility = daily_volatility * np.sqrt(66)  # å››åŠæœŸå–¶æ¥­æ—¥66æ—¥
        
        # VaRè¨ˆç®—ï¼ˆValue at Riskï¼‰
        var_95 = np.percentile(daily_returns, 5)  # 5%VaRï¼ˆæ—¥æ¬¡ï¼‰
        var_99 = np.percentile(daily_returns, 1)  # 1%VaRï¼ˆæ—¥æ¬¡ï¼‰
        
        # å–å¼•é«˜ãƒ‡ãƒ¼ã‚¿ï¼ˆæµå‹•æ€§ãƒªã‚¹ã‚¯ï¼‰
        if isinstance(data.columns, pd.MultiIndex):
            volume_data = data.iloc[:, data.columns.get_level_values(0) == 'Volume'].iloc[:, 0]
        else:
            volume_data = data['Volume']
        
        avg_volume = volume_data.mean()
        volume_volatility = volume_data.std() / avg_volume  # å‡ºæ¥é«˜ã®å¤‰å‹•ä¿‚æ•°
        
        return {
            'daily_volatility': daily_volatility,
            'annual_volatility': annual_volatility,
            'monthly_volatility': monthly_volatility,
            'quarterly_volatility': quarterly_volatility,
            'var_95': var_95,
            'var_99': var_99,
            'avg_volume': avg_volume,
            'volume_volatility': volume_volatility,
            'daily_returns': daily_returns,
            'close_prices': close_prices
        }
    except Exception as e:
        st.error(f"ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return None

def predict_next_day_price(volatility_metrics, confidence_level=0.68):
    """æ¬¡å–¶æ¥­æ—¥ã®çµ‚å€¤äºˆæ¸¬ï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰"""
    try:
        current_price = volatility_metrics['close_prices'].iloc[-1]
        daily_vol = volatility_metrics['daily_volatility']
        avg_return = volatility_metrics['daily_returns'].mean()
        
        # äºˆæ¸¬ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰
        expected_return = avg_return
        
        if confidence_level == 0.68:  # 1æ¨™æº–åå·®
            upper_bound = current_price * (1 + expected_return + daily_vol)
            lower_bound = current_price * (1 + expected_return - daily_vol)
        elif confidence_level == 0.95:  # 2æ¨™æº–åå·®
            upper_bound = current_price * (1 + expected_return + 2 * daily_vol)
            lower_bound = current_price * (1 + expected_return - 2 * daily_vol)
        else:  # 3æ¨™æº–åå·®
            upper_bound = current_price * (1 + expected_return + 3 * daily_vol)
            lower_bound = current_price * (1 + expected_return - 3 * daily_vol)
        
        expected_price = current_price * (1 + expected_return)
        
        return {
            'current_price': current_price,
            'expected_price': expected_price,
            'upper_bound': upper_bound,
            'lower_bound': lower_bound,
            'confidence_level': confidence_level,
            'daily_volatility': daily_vol,
            'expected_return': expected_return
        }
    except Exception as e:
        st.error(f"ä¾¡æ ¼äºˆæ¸¬ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return None

def calculate_portfolio_risk_metrics(ticker1_data, ticker2_data, weight1=0.5, weight2=0.5):
    """ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒªã‚¹ã‚¯æŒ‡æ¨™è¨ˆç®—"""
    try:
        # å„éŠ˜æŸ„ã®ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—
        vol1_metrics = calculate_volatility_metrics(ticker1_data)
        vol2_metrics = calculate_volatility_metrics(ticker2_data)
        
        if not vol1_metrics or not vol2_metrics:
            return None
        
        # ç›¸é–¢ä¿‚æ•°è¨ˆç®—
        returns1 = vol1_metrics['daily_returns']
        returns2 = vol2_metrics['daily_returns']
        
        # å…±é€šæœŸé–“ã§ã®ç›¸é–¢è¨ˆç®—
        common_dates = returns1.index.intersection(returns2.index)
        correlation = returns1.loc[common_dates].corr(returns2.loc[common_dates])
        
        # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£
        vol1 = vol1_metrics['annual_volatility']
        vol2 = vol2_metrics['annual_volatility']
        
        portfolio_volatility = np.sqrt(
            (weight1 ** 2) * (vol1 ** 2) + 
            (weight2 ** 2) * (vol2 ** 2) + 
            2 * weight1 * weight2 * correlation * vol1 * vol2
        )
        
        # åˆ†æ•£åŠ¹æœã®æ¸¬å®š
        weighted_avg_vol = weight1 * vol1 + weight2 * vol2
        diversification_benefit = weighted_avg_vol - portfolio_volatility
        
        return {
            'portfolio_volatility': portfolio_volatility,
            'vol1': vol1,
            'vol2': vol2,
            'correlation': correlation,
            'diversification_benefit': diversification_benefit,
            'weighted_avg_vol': weighted_avg_vol
        }
    except Exception as e:
        st.error(f"ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒªã‚¹ã‚¯è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return None

def render_volatility_analysis(ticker, data):
    """ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æã®è¡¨ç¤º"""
    vol_metrics = calculate_volatility_metrics(data)
    if not vol_metrics:
        return
    
    st.markdown("### ğŸ“Š ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ»ãƒªã‚¹ã‚¯åˆ†æ")
    
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "å¹´ç‡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£",
            f"{vol_metrics['annual_volatility']:.1%}",
            help="æ ªä¾¡ã®å¹´é–“å¤‰å‹•ç‡ã®æ¨™æº–åå·®"
        )
    
    with col2:
        st.metric(
            "æœˆæ¬¡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£",
            f"{vol_metrics['monthly_volatility']:.1%}",
            help="æ ªä¾¡ã®æœˆé–“å¤‰å‹•ç‡ã®æ¨™æº–åå·®"
        )
    
    with col3:
        st.metric(
            "5%VaRï¼ˆæ—¥æ¬¡ï¼‰",
            f"{vol_metrics['var_95']:.1%}",
            help="5%ã®ç¢ºç‡ã§ç™ºç”Ÿã™ã‚‹æœ€å¤§æå¤±"
        )
    
    with col4:
        st.metric(
            "å¹³å‡å‡ºæ¥é«˜",
            f"{vol_metrics['avg_volume']:,.0f}æ ª",
            help="æµå‹•æ€§ãƒªã‚¹ã‚¯ã®æŒ‡æ¨™"
        )
    
    # äºˆæ¸¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    st.markdown("### ğŸ”® æ¬¡å–¶æ¥­æ—¥ä¾¡æ ¼äºˆæ¸¬")
    
    confidence_level = st.selectbox(
        "ä¿¡é ¼åŒºé–“ã‚’é¸æŠ:",
        [("68%ï¼ˆ1æ¨™æº–åå·®ï¼‰", 0.68), ("95%ï¼ˆ2æ¨™æº–åå·®ï¼‰", 0.95), ("99.7%ï¼ˆ3æ¨™æº–åå·®ï¼‰", 0.997)]
    )
    
    prediction = predict_next_day_price(vol_metrics, confidence_level[1])
    
    if prediction:
        col_pred1, col_pred2, col_pred3 = st.columns(3)
        
        with col_pred1:
            st.metric(
                "ç¾åœ¨ä¾¡æ ¼",
                f"Â¥{prediction['current_price']:,.0f}"
            )
        
        with col_pred2:
            change_pct = (prediction['expected_price'] - prediction['current_price']) / prediction['current_price']
            st.metric(
                "äºˆæƒ³ä¾¡æ ¼",
                f"Â¥{prediction['expected_price']:,.0f}",
                f"{change_pct:+.2%}"
            )
        
        with col_pred3:
            range_pct = (prediction['upper_bound'] - prediction['lower_bound']) / prediction['current_price']
            st.metric(
                f"äºˆæƒ³ãƒ¬ãƒ³ã‚¸ï¼ˆ{confidence_level[0]}ï¼‰",
                f"Â¥{prediction['lower_bound']:,.0f} - Â¥{prediction['upper_bound']:,.0f}",
                f"Â±{range_pct/2:.1%}"
            )
        
        # ãƒªã‚¹ã‚¯åˆ†æ
        st.markdown("### âš ï¸ ãƒªã‚¹ã‚¯åˆ†æ")
        
        col_risk1, col_risk2 = st.columns(2)
        
        with col_risk1:
            st.markdown("**æŠ•è³‡é¡åˆ¥ãƒªã‚¹ã‚¯è©¦ç®—**")
            
            investment_amounts = [500000, 1000000, 1500000]  # 50ä¸‡ã€100ä¸‡ã€150ä¸‡å††
            
            for amount in investment_amounts:
                shares = amount / prediction['current_price']
                daily_var = shares * prediction['current_price'] * abs(vol_metrics['var_95'])
                monthly_var = daily_var * np.sqrt(22)
                
                st.write(f"**{amount/10000:.0f}ä¸‡å††æŠ•è³‡æ™‚:**")
                st.write(f"- æ—¥æ¬¡5%VaR: Â¥{daily_var:,.0f}")
                st.write(f"- æœˆæ¬¡5%VaR: Â¥{monthly_var:,.0f}")
                st.write("---")
        
        with col_risk2:
            st.markdown("**ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è§£é‡ˆ**")
            
            annual_vol = vol_metrics['annual_volatility']
            
            if annual_vol < 0.20:
                risk_level = "ğŸŸ¢ ä½ãƒªã‚¹ã‚¯"
                risk_desc = "æ¯”è¼ƒçš„å®‰å®šã—ãŸå€¤å‹•ã"
            elif annual_vol < 0.35:
                risk_level = "ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯"
                risk_desc = "æ¨™æº–çš„ãªå€¤å‹•ã"
            else:
                risk_level = "ğŸ”´ é«˜ãƒªã‚¹ã‚¯"
                risk_desc = "å¤§ããªå€¤å‹•ããŒäºˆæƒ³ã•ã‚Œã‚‹"
            
            st.info(f"""
            **{risk_level}**
            
            å¹´ç‡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£: {annual_vol:.1%}
            
            {risk_desc}
            
            **1æ¨™æº–åå·®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ68%ç¢ºç‡ï¼‰:**
            å¹´é–“ã§ {annual_vol:.1%} ã®å¤‰å‹•å¹…
            
            **2æ¨™æº–åå·®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ95%ç¢ºç‡ï¼‰:**
            å¹´é–“ã§ {annual_vol*2:.1%} ã®å¤‰å‹•å¹…
            """)

# --- å¸‚å ´ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ ---
def get_market_indices_data():
    """ä¸»è¦å¸‚å ´æŒ‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"""
    try:
        indices = {
            '^N225': 'æ—¥çµŒå¹³å‡',
            '1305.T': 'TOPIX',
            '6758.T': 'ã‚½ãƒ‹ãƒ¼G',
            '7203.T': 'ãƒˆãƒ¨ã‚¿',
            '6861.T': 'ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹',
            '8306.T': 'ä¸‰è±UFJ',
            '9983.T': 'ãƒ•ã‚¡ã‚¹ãƒˆãƒª'
        }
        
        market_data = {}
        for ticker, name in indices.items():
            try:
                data = yf.download(ticker, period='5d', progress=False, auto_adjust=True)
                if not data.empty:
                    # MultiIndexã®å ´åˆã®å‡¦ç†
                    if isinstance(data.columns, pd.MultiIndex):
                        close_data = data.iloc[:, data.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                    else:
                        close_data = data['Close']
                    
                    latest_price = float(close_data.iloc[-1])
                    prev_price = float(close_data.iloc[-2]) if len(close_data) > 1 else latest_price
                    
                    market_data[ticker] = {
                        'name': name,
                        'data': data,
                        'latest_price': latest_price,
                        'prev_price': prev_price,
                    }
            except:
                continue
        
        return market_data
    except Exception as e:
        st.error(f"å¸‚å ´ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")
        return {}

def calculate_market_risk_level(market_data):
    """å¸‚å ´ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã®è¨ˆç®—"""
    try:
        risk_signals = []
        total_weight = 0
        weighted_decline = 0
        
        # å„æŒ‡æ•°ã®é‡ã¿ä»˜ã‘
        weights = {
            '^N225': 0.3,    # æ—¥çµŒå¹³å‡ 30%
            '1305.T': 0.25,  # TOPIX 25%
            '6758.T': 0.1,   # ã‚½ãƒ‹ãƒ¼ 10%
            '7203.T': 0.1,   # ãƒˆãƒ¨ã‚¿ 10%
            '6861.T': 0.1,   # ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹ 10%
            '8306.T': 0.075, # ä¸‰è±UFJ 7.5%
            '9983.T': 0.075  # ãƒ•ã‚¡ã‚¹ãƒˆãƒª 7.5%
        }
        
        for ticker, info in market_data.items():
            if ticker in weights:
                change_pct = ((info['latest_price'] - info['prev_price']) / info['prev_price']) * 100
                weight = weights[ticker]
                
                total_weight += weight
                weighted_decline += change_pct * weight
                
                # å€‹åˆ¥éŠ˜æŸ„ã®ä¸‹è½ç‡ãƒã‚§ãƒƒã‚¯
                if change_pct < -3:
                    risk_signals.append(f"{info['name']}: {change_pct:.1f}% ä¸‹è½")
                elif change_pct < -5:
                    risk_signals.append(f"âš ï¸ {info['name']}: {change_pct:.1f}% å¤§å¹…ä¸‹è½")
        
        # åŠ é‡å¹³å‡ä¸‹è½ç‡
        avg_decline = weighted_decline / total_weight if total_weight > 0 else 0
        
        # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š
        if avg_decline < -3:
            risk_level = "ğŸ”´ é«˜ãƒªã‚¹ã‚¯"
            risk_description = "å¸‚å ´å…¨ä½“ã®å¤§å¹…ä¸‹è½ã€‚ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´éŠ˜æŸ„ã¯å¤§ããä¸‹è½ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            action_recommended = "åˆ©ç¢ºã—ã¦ç¾é‡‘ãƒã‚¸ã‚·ãƒ§ãƒ³ã¸ã®é€€é¿ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
        elif avg_decline < -1.5:
            risk_level = "ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯"
            risk_description = "å¸‚å ´ã«ä¸å®‰å®šãªå‹•ããŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚"
            action_recommended = "ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã®ç¸®å°ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
        elif avg_decline < -0.5:
            risk_level = "ğŸŸ  è»½å¾®ãƒªã‚¹ã‚¯"
            risk_description = "å¸‚å ´ã«è‹¥å¹²ã®ä¸‹è½åœ§åŠ›ãŒã‚ã‚Šã¾ã™ã€‚"
            action_recommended = "æ§˜å­è¦‹ã§è‰¯ã„ã§ã™ãŒã€æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ã®ç¢ºèªã‚’ã—ã¦ãã ã•ã„ã€‚"
        else:
            risk_level = "ğŸŸ¢ ä½ãƒªã‚¹ã‚¯"
            risk_description = "å¸‚å ´ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚"
            action_recommended = "é€šå¸¸ã®æŠ•è³‡æˆ¦ç•¥ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚"
        
        return {
            'risk_level': risk_level,
            'avg_decline': avg_decline,
            'risk_description': risk_description,
            'action_recommended': action_recommended,
            'risk_signals': risk_signals,
            'total_signals': len(risk_signals)
        }
        
    except Exception as e:
        return {
            'risk_level': "â“ ä¸æ˜",
            'avg_decline': 0,
            'risk_description': f"ãƒªã‚¹ã‚¯è¨ˆç®—ã‚¨ãƒ©ãƒ¼: {str(e)}",
            'action_recommended': "æ‰‹å‹•ã§å¸‚å ´çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
            'risk_signals': [],
            'total_signals': 0
        }

def calculate_portfolio_survival_probability(market_decline, portfolio_tickers):
    """ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®ç”Ÿå­˜ç¢ºç‡è¨ˆç®—"""
    try:
        # ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´ã®ãƒ™ãƒ¼ã‚¿å€¤ï¼ˆå¤§å‹æ ªã«å¯¾ã™ã‚‹æ„Ÿå¿œåº¦ï¼‰
        # ä¸€èˆ¬çš„ã«ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´ã¯ãƒ™ãƒ¼ã‚¿ãŒ1.2-1.5ç¨‹åº¦
        beta_multiplier = 1.3
        
        expected_portfolio_decline = market_decline * beta_multiplier
        
        # å¼·åˆ¶çµ‚äº†ãƒ©ã‚¤ãƒ³ï¼ˆ-10%ï¼‰ã«å¯¾ã™ã‚‹ä½™è£•åº¦
        margin_to_liquidation = -10 - expected_portfolio_decline
        
        if margin_to_liquidation <= 0:
            survival_prob = 0  # å¼·åˆ¶çµ‚äº†ã®å¯èƒ½æ€§é«˜
            warning_level = "ğŸš¨ ç·Šæ€¥"
        elif margin_to_liquidation <= 2:
            survival_prob = 30  # ä½ã„ç”Ÿå­˜ç¢ºç‡
            warning_level = "ğŸ”´ å±é™º"
        elif margin_to_liquidation <= 5:
            survival_prob = 70  # ä¸­ç¨‹åº¦ã®ç”Ÿå­˜ç¢ºç‡
            warning_level = "ğŸŸ¡ æ³¨æ„"
        else:
            survival_prob = 95  # é«˜ã„ç”Ÿå­˜ç¢ºç‡
            warning_level = "ğŸŸ¢ å®‰å…¨"
        
        return {
            'survival_probability': survival_prob,
            'expected_decline': expected_portfolio_decline,
            'margin_to_liquidation': margin_to_liquidation,
            'warning_level': warning_level
        }
        
    except Exception as e:
        return {
            'survival_probability': 50,
            'expected_decline': 0,
            'margin_to_liquidation': 0,
            'warning_level': "â“ ä¸æ˜"
        }

def analyze_individual_ticker_risk(ticker, market_decline):
    """å€‹åˆ¥éŠ˜æŸ„ã®ãƒªã‚¹ã‚¯åˆ†æ"""
    try:
        # éŠ˜æŸ„ãƒ‡ãƒ¼ã‚¿å–å¾—
        data = yf.download(ticker, period='1mo', progress=False, auto_adjust=True)
        if data.empty:
            return None
        
        # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£è¨ˆç®—
        if isinstance(data.columns, pd.MultiIndex):
            close_prices = data.iloc[:, data.columns.get_level_values(0) == 'Close'].iloc[:, 0]
        else:
            close_prices = data['Close']
        
        daily_returns = close_prices.pct_change().dropna()
        current_price = close_prices.iloc[-1]
        
        # ãƒ™ãƒ¼ã‚¿å€¤æ¨å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
        if len(daily_returns) > 10:
            volatility = daily_returns.std()
            # ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´ã®ãƒ™ãƒ¼ã‚¿å€¤ã¯é€šå¸¸1.2-1.5
            estimated_beta = 1.3 if volatility > 0.03 else 1.1
        else:
            estimated_beta = 1.3
        
        # äºˆæƒ³ä¸‹è½ç‡
        expected_decline = market_decline * estimated_beta
        expected_price = current_price * (1 + expected_decline / 100)
        
        # å¼·åˆ¶çµ‚äº†ãƒ©ã‚¤ãƒ³ã¾ã§ã®ä½™è£•
        liquidation_threshold = current_price * 0.9  # -10%
        margin_to_liquidation = ((expected_price - liquidation_threshold) / liquidation_threshold) * 100
        
        # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¤å®š
        if margin_to_liquidation <= -5:
            risk_status = "ğŸš¨ å³åº§ã«å£²å´æ¨å¥¨"
            risk_color = "error"
        elif margin_to_liquidation <= 0:
            risk_status = "ğŸ”´ é«˜ãƒªã‚¹ã‚¯"
            risk_color = "error"
        elif margin_to_liquidation <= 5:
            risk_status = "ğŸŸ¡ æ³¨æ„"
            risk_color = "warning"
        else:
            risk_status = "ğŸŸ¢ ç›¸å¯¾çš„ã«å®‰å…¨"
            risk_color = "success"
        
        return {
            'ticker': ticker,
            'current_price': current_price,
            'expected_price': expected_price,
            'expected_decline': expected_decline,
            'margin_to_liquidation': margin_to_liquidation,
            'risk_status': risk_status,
            'risk_color': risk_color,
            'estimated_beta': estimated_beta
        }
        
    except Exception as e:
        return None

def render_portfolio_specific_risk_analysis():
    """ä¿æœ‰éŠ˜æŸ„å›ºæœ‰ã®ãƒªã‚¹ã‚¯åˆ†æ"""
    st.markdown("### ğŸ¯ ä¿æœ‰éŠ˜æŸ„ãƒªã‚¹ã‚¯åˆ†æ")
    
    target_tickers = ['6357.T', '4816.T', '2991.T', '7564.T', '7711.T', '6405.T', 
                     '2428.T', '6231.T', '6855.T', '4832.T', '4767.T']
    
    # å¸‚å ´ãƒ‡ãƒ¼ã‚¿å–å¾—
    market_data = get_market_indices_data()
    if not market_data:
        st.error("å¸‚å ´ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“")
        return
    
    risk_info = calculate_market_risk_level(market_data)
    market_decline = risk_info['avg_decline']
    
    # ä¿æœ‰éŠ˜æŸ„ã‚’é¸æŠ
    selected_tickers = st.multiselect(
        "ãƒªã‚¹ã‚¯åˆ†æã—ãŸã„ä¿æœ‰éŠ˜æŸ„ã‚’é¸æŠ:",
        target_tickers,
        default=target_tickers[:3],  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ€åˆã®3éŠ˜æŸ„
        format_func=lambda x: f"{x.replace('.T', '')} - {TICKER_NAMES.get(x, 'Unknown')}"
    )
    
    if selected_tickers:
        st.markdown(f"**å¸‚å ´ä¸‹è½ç‡:** {market_decline:.1f}% ã‚’åŸºæº–ã«ã—ãŸåˆ†æ")
        
        risk_analysis_results = []
        
        for ticker in selected_tickers:
            with st.spinner(f"ğŸ“Š {ticker} ã‚’åˆ†æä¸­..."):
                risk_result = analyze_individual_ticker_risk(ticker, market_decline)
                if risk_result:
                    risk_analysis_results.append(risk_result)
        
        if risk_analysis_results:
            # çµæœã®è¡¨ç¤º
            col1, col2 = st.columns([2, 1])
            
            with col1:
                # è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
                risk_df_data = []
                for result in risk_analysis_results:
                    risk_df_data.append({
                        'éŠ˜æŸ„': result['ticker'].replace('.T', ''),
                        'ä¼æ¥­å': TICKER_NAMES.get(result['ticker'], 'Unknown'),
                        'ç¾åœ¨ä¾¡æ ¼': f"Â¥{result['current_price']:,.0f}",
                        'äºˆæƒ³ä¾¡æ ¼': f"Â¥{result['expected_price']:,.0f}",
                        'äºˆæƒ³ä¸‹è½ç‡': f"{result['expected_decline']:+.1f}%",
                        'å¼·åˆ¶çµ‚äº†ä½™è£•': f"{result['margin_to_liquidation']:+.1f}%",
                        'ãƒªã‚¹ã‚¯è©•ä¾¡': result['risk_status']
                    })
                
                risk_df = pd.DataFrame(risk_df_data)
                st.dataframe(risk_df, use_container_width=True)
            
            with col2:
                # ãƒªã‚¹ã‚¯ã‚µãƒãƒªãƒ¼
                high_risk_count = sum(1 for r in risk_analysis_results if 'ğŸš¨' in r['risk_status'] or 'ğŸ”´' in r['risk_status'])
                medium_risk_count = sum(1 for r in risk_analysis_results if 'ğŸŸ¡' in r['risk_status'])
                low_risk_count = len(risk_analysis_results) - high_risk_count - medium_risk_count
                
                st.metric("ğŸš¨ é«˜ãƒªã‚¹ã‚¯éŠ˜æŸ„", f"{high_risk_count}éŠ˜æŸ„")
                st.metric("ğŸŸ¡ æ³¨æ„éŠ˜æŸ„", f"{medium_risk_count}éŠ˜æŸ„")
                st.metric("ğŸŸ¢ ç›¸å¯¾çš„å®‰å…¨", f"{low_risk_count}éŠ˜æŸ„")
            
            # æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            if high_risk_count > 0:
                st.error(f"""
                ğŸš¨ **ç·Šæ€¥æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**
                
                {high_risk_count}éŠ˜æŸ„ã§é«˜ãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚
                
                **å³åº§ã«å®Ÿè¡Œã‚’æ¨å¥¨:**
                1. ğŸƒ é«˜ãƒªã‚¹ã‚¯éŠ˜æŸ„ã®å³åº§å£²å´
                2. ğŸ’° åˆ©ç¢ºå¯èƒ½éŠ˜æŸ„ã®åˆ©ç¢ºå®Ÿè¡Œ
                3. ğŸ”’ æ–°è¦ãƒã‚¸ã‚·ãƒ§ãƒ³å–å¾—åœæ­¢
                4. ğŸ“Š å¸‚å ´å›å¾©ã¾ã§ç¾é‡‘ãƒã‚¸ã‚·ãƒ§ãƒ³ç¶­æŒ
                """)
            elif medium_risk_count > 0:
                st.warning(f"""
                âš ï¸ **æ³¨æ„ãŒå¿…è¦**
                
                {medium_risk_count}éŠ˜æŸ„ã§æ³¨æ„ãƒ¬ãƒ™ãƒ«ã®ãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ã€‚
                
                **æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
                1. ğŸ“‰ ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºç¸®å°æ¤œè¨
                2. ğŸ¯ æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³å†è¨­å®š
                3. ğŸ‘€ å¸‚å ´å‹•å‘ã®ç¶™ç¶šç›£è¦–
                """)
            else:
                st.success("""
                ğŸŸ¢ **ç¾åœ¨ã¯ç›¸å¯¾çš„ã«å®‰å…¨**
                
                é¸æŠã•ã‚ŒãŸéŠ˜æŸ„ã¯ç¾åœ¨ã®å¸‚å ´çŠ¶æ³ã§ã¯æ¯”è¼ƒçš„å®‰å…¨ã§ã™ã€‚
                
                **ç¶™ç¶šæ¨å¥¨:**
                1. ğŸ“Š å®šæœŸçš„ãªãƒªã‚¹ã‚¯ãƒã‚§ãƒƒã‚¯
                2. ğŸ¯ æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ã®ç¶­æŒ
                3. ğŸ“ˆ å¸‚å ´å‹•å‘ã®ç›£è¦–ç¶™ç¶š
                """)

def render_market_risk_alert():
    """å¸‚å ´ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆã®è¡¨ç¤º"""
    st.markdown("### ğŸš¨ å¸‚å ´ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆ")
    
    with st.spinner("ğŸ“Š å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æä¸­..."):
        market_data = get_market_indices_data()
    
    if not market_data:
        st.error("âŒ å¸‚å ´ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
        return
    
    # ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«è¨ˆç®—
    risk_info = calculate_market_risk_level(market_data)
    
    # ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    with st.container(border=True):
        col_risk1, col_risk2, col_risk3 = st.columns(3)
        
        with col_risk1:
            st.metric(
                "ç¾åœ¨ã®ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«",
                risk_info['risk_level'],
                f"å¸‚å ´å¹³å‡: {risk_info['avg_decline']:+.1f}%"
            )
        
        with col_risk2:
            st.metric(
                "ã‚¢ãƒ©ãƒ¼ãƒˆä»¶æ•°",
                f"{risk_info['total_signals']}ä»¶",
                "å¤§å‹æ ªä¸‹è½æ¤œå‡º"
            )
        
        with col_risk3:
            # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç”Ÿå­˜ç¢ºç‡ï¼ˆä¾‹ã¨ã—ã¦æœ€åˆã®2éŠ˜æŸ„ï¼‰
            target_tickers = ['6357.T', '4816.T']  # ä¾‹
            survival_info = calculate_portfolio_survival_probability(
                risk_info['avg_decline'], target_tickers
            )
            
            st.metric(
                "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç”Ÿå­˜ç¢ºç‡",
                f"{survival_info['survival_probability']}%",
                survival_info['warning_level']
            )
    
    # è©³ç´°æƒ…å ±
    with st.expander("ğŸ“‹ è©³ç´°ãªå¸‚å ´åˆ†æ"):
        st.markdown(f"**çŠ¶æ³èª¬æ˜:** {risk_info['risk_description']}")
        st.markdown(f"**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:** {risk_info['action_recommended']}")
        
        if risk_info['risk_signals']:
            st.markdown("**å€‹åˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆ:**")
            for signal in risk_info['risk_signals']:
                st.write(f"- {signal}")
        
        # å¸‚å ´ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
        market_summary = []
        for ticker, info in market_data.items():
            try:
                # Seriesã®å ´åˆã¯å€¤ã‚’å–å¾—
                latest_price = float(info['latest_price'])
                prev_price = float(info['prev_price'])
                change_pct = ((latest_price - prev_price) / prev_price) * 100
                
                market_summary.append({
                    'æŒ‡æ•°/éŠ˜æŸ„': info['name'],
                    'ãƒ†ã‚£ãƒƒã‚«ãƒ¼': ticker,
                    'æœ€æ–°ä¾¡æ ¼': f"{latest_price:,.0f}",
                    'å‰æ—¥æ¯”(%)': f"{change_pct:+.2f}",
                    'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹': 'ğŸ”´ ä¸‹è½' if change_pct < -1 else 'ğŸŸ¡ è»Ÿèª¿' if change_pct < 0 else 'ğŸŸ¢ ä¸Šæ˜‡'
                })
            except Exception as e:
                # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                continue
        
        if market_summary:
            market_df = pd.DataFrame(market_summary)
            
            # å‰æ—¥æ¯”ã®è‰²ä»˜ã‘ç”¨ã‚¹ã‚¿ã‚¤ãƒ«é–¢æ•°
            def color_change_pct_market(val):
                """å‰æ—¥æ¯”ã®å€¤ã«å¿œã˜ã¦è‰²ã‚’è¨­å®šï¼ˆæ­£ã¯èµ¤ã€è² ã¯é’ï¼‰"""
                try:
                    # æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡ºï¼ˆ+ã‚„%ã‚’é™¤å»ï¼‰
                    numeric_val = float(val.replace('+', '').replace('%', ''))
                    if numeric_val > 0:
                        return 'background-color: #ffebee; color: #d32f2f; font-weight: bold'  # è–„ã„èµ¤èƒŒæ™¯ã€æ¿ƒã„èµ¤æ–‡å­—
                    elif numeric_val < 0:
                        return 'background-color: #e3f2fd; color: #1976d2; font-weight: bold'  # è–„ã„é’èƒŒæ™¯ã€æ¿ƒã„é’æ–‡å­—
                    else:
                        return 'background-color: #f5f5f5; color: #666666'  # ã‚°ãƒ¬ãƒ¼
                except:
                    return 'color: black'
            
            # ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            styled_df = market_df.style.apply(
                lambda x: [''] * len(x) if x.name != 'å‰æ—¥æ¯”(%)' 
                else [color_change_pct_market(val) for val in x], 
                axis=0
            )
            
            st.dataframe(styled_df, use_container_width=True)
    
    # ä¿æœ‰éŠ˜æŸ„å›ºæœ‰ã®ãƒªã‚¹ã‚¯åˆ†æ
    st.markdown("---")
    render_portfolio_specific_risk_analysis()
    
    # ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ
    if risk_info['avg_decline'] < -3:
        st.error("""
        ğŸš¨ **ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ: å¸‚å ´å¤§å¹…ä¸‹è½**
        
        å¤§å‹æ ªãƒ»æŒ‡æ•°ãŒå¤§å¹…ä¸‹è½ã—ã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´éŠ˜æŸ„ã¯é€£å‹•ã—ã¦ä¸‹è½ã™ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
        
        **æ¨å¥¨è¡Œå‹•:**
        1. ğŸ’° å³åº§ã«åˆ©ç¢ºã‚’æ¤œè¨
        2. ğŸƒ ç¾é‡‘ãƒã‚¸ã‚·ãƒ§ãƒ³ã¸ã®é€€é¿
        3. ğŸ“‰ æ–°è¦ãƒã‚¸ã‚·ãƒ§ãƒ³å–å¾—ã®å»¶æœŸ
        4. ğŸ” å¸‚å ´å›å¾©ã¾ã§æ§˜å­è¦‹
        """)
    elif risk_info['avg_decline'] < -1.5:
        st.warning("""
        âš ï¸ **æ³¨æ„: å¸‚å ´ä¸å®‰å®š**
        
        å¸‚å ´ã«ä¸å®‰å®šãªå‹•ããŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚æ…é‡ãªå¯¾å¿œãŒå¿…è¦ã§ã™ã€‚
        
        **æ¨å¥¨è¡Œå‹•:**
        1. ğŸ“‰ ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã®ç¸®å°
        2. ğŸ¯ æåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ã®å†ç¢ºèª
        3. ğŸ‘€ å¸‚å ´å‹•å‘ã®ç¶™ç¶šç›£è¦–
        """)

# --- ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæˆ¦ç•¥å®¤ ---
def render_portfolio_strategy_page():
    """ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæˆ¦ç•¥å®¤ã®ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸"""
    st.title("ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæˆ¦ç•¥å®¤")
    st.markdown("---")
    
    # ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«ã®èª¬æ˜
    with st.container(border=True):
        st.subheader("ğŸ® æŠ•è³‡ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«")
        col_rule1, col_rule2 = st.columns(2)
        
        with col_rule1:
            st.markdown("""
            **åŸºæœ¬è¨­å®š:**
            - ğŸ’° åˆæœŸè³‡é‡‘: 3,000,000å††
            - ğŸ“ˆ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª: 2éŠ˜æŸ„ã®ã¿
            - ğŸ¢ å¯¾è±¡: æ±è¨¼ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´
            - ğŸ“Š æ¡ä»¶: æ™‚ä¾¡ç·é¡50å„„å††ä»¥ä¸Šã€ä¸Šå ´1å¹´ä»¥ä¸Š
            """)
        
        with col_rule2:
            st.markdown("""
            **å–å¼•ãƒ«ãƒ¼ãƒ«:**
            - â° å–å¼•æ™‚é–“: 9:00å§‹å€¤ ã¾ãŸã¯ 15:00çµ‚å€¤
            - ğŸ”’ æœ€ä½ä¿æœ‰æœŸé–“: 3æ—¥é–“
            - ğŸš¨ å¼·åˆ¶çµ‚äº†: ç´¯ç©æå¤±30ä¸‡å††
            - ğŸ“… æŠ•è³‡æœŸé–“: éå»ãƒ‡ãƒ¼ã‚¿ã§ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
            """)
    
    # ã‚¿ãƒ–åˆ†ã‘ã«ã‚ˆã‚‹æ©Ÿèƒ½æ•´ç†
    tab1, tab2, tab3, tab4 = st.tabs(["ğŸš¨ å¸‚å ´ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆ", "ğŸ” éŠ˜æŸ„åˆ†æ", "ğŸ“Š ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æ", "ğŸ¯ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–"])

    with tab1:
        render_market_risk_alert()
    
    with tab2:
        render_ticker_analysis_tab()
    
    with tab3:
        render_volatility_analysis_tab()
    
    with tab4:
        render_portfolio_optimization_tab()

def render_ticker_analysis_tab():
    """éŠ˜æŸ„åˆ†æã‚¿ãƒ–"""
    target_tickers = ['6357.T', '4816.T', '2991.T', '7564.T', '7711.T', '6405.T', 
                     '2428.T', '6231.T', '6855.T', '4832.T', '4767.T']
    
    # ãƒ†ã‚¹ãƒˆç”¨: 1ã¤ã®éŠ˜æŸ„ã§ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
    st.subheader("ğŸ” ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ")
    test_ticker = target_tickers[0]
    
    with st.expander("ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆçµæœ"):
        try:
            test_data = yf.download(test_ticker, period='1mo', progress=False, auto_adjust=True)
            if not test_data.empty:
                st.success(f"âœ… {test_ticker}: ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ ({len(test_data)}æ—¥åˆ†)")
                
                # ã‚«ãƒ©ãƒ æ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
                if isinstance(test_data.columns, pd.MultiIndex):
                    st.write("ã‚«ãƒ©ãƒ æ§‹é€ : MultiIndex")
                    st.write(f"ãƒ¬ãƒ™ãƒ«0: {list(test_data.columns.get_level_values(0))}")
                    st.write(f"ãƒ¬ãƒ™ãƒ«1: {list(test_data.columns.get_level_values(1))}")
                else:
                    st.write(f"ã‚«ãƒ©ãƒ : {list(test_data.columns)}")
                    
                st.write(f"æœŸé–“: {test_data.index[0].strftime('%Y-%m-%d')} ï½ {test_data.index[-1].strftime('%Y-%m-%d')}")
            else:
                st.error(f"âŒ {test_ticker}: ãƒ‡ãƒ¼ã‚¿ãŒç©º")
        except Exception as e:
            st.error(f"âŒ {test_ticker}: ã‚¨ãƒ©ãƒ¼ - {str(e)}")
    
    # éŠ˜æŸ„ã®äº‹å‰åˆ†æ
    st.subheader("ğŸ“‹ éŠ˜æŸ„åˆ†æ")
    
    with st.spinner("ğŸ“Š éŠ˜æŸ„ã®äº‹å‰æ¡ä»¶ã‚’ç¢ºèªä¸­..."):
        eligible_tickers = analyze_ticker_eligibility(target_tickers)
    
    if eligible_tickers:
        st.success(f"âœ… æ¡ä»¶ã‚’æº€ãŸã™éŠ˜æŸ„: {len(eligible_tickers)}éŠ˜æŸ„")
        
        # çµ„ã¿åˆã‚ã›åˆ†æ
        st.subheader("ğŸ” ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªçµ„ã¿åˆã‚ã›åˆ†æ")
        combinations_df = analyze_portfolio_combinations(eligible_tickers)
        
        if not combinations_df.empty:
            # ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ä»˜ããƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
            sort_option = st.selectbox(
                "ã‚½ãƒ¼ãƒˆåŸºæº–:",
                ["ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª(é™é †)", "ãƒªã‚¹ã‚¯(æ˜‡é †)", "ç›¸é–¢(æ˜‡é †)", "æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³(é™é †)"]
            )
            
            sorted_df = sort_combinations(combinations_df, sort_option)
            
            st.dataframe(
                sorted_df.style.format({
                    'æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³(å¹´ç‡)': '{:.2%}',
                    'ãƒªã‚¹ã‚¯(å¹´ç‡)': '{:.2%}',
                    'ç›¸é–¢ä¿‚æ•°': '{:.3f}',
                    'ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª': '{:.3f}'
                }),
                use_container_width=True
            )
        else:
            st.error("âŒ çµ„ã¿åˆã‚ã›åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
    else:
        st.error("âŒ æ¡ä»¶ã‚’æº€ãŸã™éŠ˜æŸ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")

def render_volatility_analysis_tab():
    """ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æã‚¿ãƒ–"""
    st.subheader("ğŸ“Š å€‹åˆ¥éŠ˜æŸ„ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æ")
    
    target_tickers = ['6357.T', '4816.T', '2991.T', '7564.T', '7711.T', '6405.T', 
                     '2428.T', '6231.T', '6855.T', '4832.T', '4767.T']
    
    # éŠ˜æŸ„é¸æŠ
    selected_ticker = st.selectbox(
        "åˆ†æã™ã‚‹éŠ˜æŸ„ã‚’é¸æŠ:",
        target_tickers,
        format_func=lambda x: f"{x.replace('.T', '')} - {TICKER_NAMES.get(x, 'Unknown')}"
    )
    
    # åˆ†ææœŸé–“é¸æŠ
    period_option = st.selectbox(
        "åˆ†ææœŸé–“:",
        [("1å¹´", "1y"), ("6ãƒ¶æœˆ", "6mo"), ("3ãƒ¶æœˆ", "3mo"), ("1ãƒ¶æœˆ", "1mo")]
    )
    
    if st.button("ğŸ“Š ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æå®Ÿè¡Œ", type="primary"):
        with st.spinner(f"ğŸ“Š {selected_ticker}ã®ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’åˆ†æä¸­..."):
            try:
                # ãƒ‡ãƒ¼ã‚¿å–å¾—
                data = yf.download(selected_ticker, period=period_option[1], progress=False, auto_adjust=True)
                
                if not data.empty:
                    # ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£åˆ†æè¡¨ç¤º
                    render_volatility_analysis(selected_ticker, data)
                    
                    # ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ
                    st.markdown("### ğŸ“ˆ ä¾¡æ ¼ãƒãƒ£ãƒ¼ãƒˆ")
                    
                    if isinstance(data.columns, pd.MultiIndex):
                        close_prices = data.iloc[:, data.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                    else:
                        close_prices = data['Close']
                    
                    fig = go.Figure()
                    fig.add_trace(go.Scatter(
                        x=close_prices.index,
                        y=close_prices.values,
                        mode='lines',
                        name='çµ‚å€¤',
                        line=dict(color='blue', width=2)
                    ))
                    
                    fig.update_layout(
                        title=f"{TICKER_NAMES.get(selected_ticker, selected_ticker)} ä¾¡æ ¼æ¨ç§»",
                        xaxis_title="æ—¥ä»˜",
                        yaxis_title="ä¾¡æ ¼ (å††)",
                        height=400
                    )
                    
                    st.plotly_chart(fig, use_container_width=True)
                    
                else:
                    st.error(f"âŒ {selected_ticker}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
                    
            except Exception as e:
                st.error(f"âŒ åˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}")

def render_portfolio_optimization_tab():
    """ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–ã‚¿ãƒ–"""
    st.subheader("ğŸ¯ 2éŠ˜æŸ„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–")
    
    target_tickers = ['6357.T', '4816.T', '2991.T', '7564.T', '7711.T', '6405.T', 
                     '2428.T', '6231.T', '6855.T', '4832.T', '4767.T']
    
    col1, col2 = st.columns(2)
    
    with col1:
        ticker1 = st.selectbox(
            "éŠ˜æŸ„1ã‚’é¸æŠ:",
            target_tickers,
            format_func=lambda x: f"{x.replace('.T', '')} - {TICKER_NAMES.get(x, 'Unknown')}"
        )
    
    with col2:
        ticker2 = st.selectbox(
            "éŠ˜æŸ„2ã‚’é¸æŠ:",
            [t for t in target_tickers if t != ticker1],
            format_func=lambda x: f"{x.replace('.T', '')} - {TICKER_NAMES.get(x, 'Unknown')}"
        )
    
    # æŠ•è³‡é…åˆ†
    col_weight1, col_weight2 = st.columns(2)
    
    with col_weight1:
        weight1 = st.slider(f"{ticker1.replace('.T', '')}ã®é…åˆ†", 0, 100, 50, 5)
    
    with col_weight2:
        weight2 = 100 - weight1
        st.metric(f"{ticker2.replace('.T', '')}ã®é…åˆ†", f"{weight2}%")
    
    if st.button("ğŸ” ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªåˆ†æå®Ÿè¡Œ", type="primary"):
        with st.spinner("ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒªã‚¹ã‚¯ã‚’åˆ†æä¸­..."):
            try:
                # ä¸¡éŠ˜æŸ„ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
                data1 = yf.download(ticker1, period='1y', progress=False, auto_adjust=True)
                data2 = yf.download(ticker2, period='1y', progress=False, auto_adjust=True)
                
                if not data1.empty and not data2.empty:
                    # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒªã‚¹ã‚¯åˆ†æ
                    portfolio_metrics = calculate_portfolio_risk_metrics(
                        data1, data2, weight1/100, weight2/100
                    )
                    
                    if portfolio_metrics:
                        st.markdown("### ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒªã‚¹ã‚¯åˆ†æçµæœ")
                        
                        col_port1, col_port2, col_port3 = st.columns(3)
                        
                        with col_port1:
                            st.metric(
                                "ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£",
                                f"{portfolio_metrics['portfolio_volatility']:.1%}",
                                help="2éŠ˜æŸ„çµ„ã¿åˆã‚ã›ã®å¹´ç‡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£"
                            )
                        
                        with col_port2:
                            st.metric(
                                "ç›¸é–¢ä¿‚æ•°",
                                f"{portfolio_metrics['correlation']:.3f}",
                                help="2éŠ˜æŸ„é–“ã®ä¾¡æ ¼å¤‰å‹•ã®ç›¸é–¢"
                            )
                        
                        with col_port3:
                            diversification_pct = (portfolio_metrics['diversification_benefit'] / 
                                                 portfolio_metrics['weighted_avg_vol']) * 100
                            st.metric(
                                "åˆ†æ•£åŠ¹æœ",
                                f"{diversification_pct:.1f}%",
                                help="åˆ†æ•£æŠ•è³‡ã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯è»½æ¸›åŠ¹æœ"
                            )
                        
                        # åˆ†æ•£åŠ¹æœã®å¯è¦–åŒ–
                        st.markdown("### ğŸ“ˆ åˆ†æ•£åŠ¹æœã®æ¯”è¼ƒ")
                        
                        comparison_data = {
                            'æŒ‡æ¨™': ['éŠ˜æŸ„1å˜ç‹¬', 'éŠ˜æŸ„2å˜ç‹¬', 'åŠ é‡å¹³å‡', 'ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª'],
                            'ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£': [
                                portfolio_metrics['vol1'],
                                portfolio_metrics['vol2'],
                                portfolio_metrics['weighted_avg_vol'],
                                portfolio_metrics['portfolio_volatility']
                            ]
                        }
                        
                        comparison_df = pd.DataFrame(comparison_data)
                        
                        fig = go.Figure()
                        colors = ['lightcoral', 'lightblue', 'orange', 'green']
                        
                        for i, row in comparison_df.iterrows():
                            fig.add_trace(go.Bar(
                                x=[row['æŒ‡æ¨™']],
                                y=[row['ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£']],
                                name=row['æŒ‡æ¨™'],
                                marker_color=colors[i],
                                showlegend=False
                            ))
                        
                        fig.update_layout(
                            title="ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£æ¯”è¼ƒ",
                            yaxis_title="å¹´ç‡ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£",
                            height=400
                        )
                        
                        st.plotly_chart(fig, use_container_width=True)
                        
                        # ãƒªã‚¹ã‚¯åˆ†æã®ã¾ã¨ã‚
                        st.markdown("### ğŸ’¡ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè©•ä¾¡")
                        
                        if portfolio_metrics['correlation'] < 0.3:
                            correlation_grade = "ğŸŸ¢ å„ªç§€ãªåˆ†æ•£åŠ¹æœ"
                        elif portfolio_metrics['correlation'] < 0.7:
                            correlation_grade = "ğŸŸ¡ é©åº¦ãªåˆ†æ•£åŠ¹æœ"
                        else:
                            correlation_grade = "ğŸ”´ åˆ†æ•£åŠ¹æœãŒé™å®šçš„"
                        
                        st.info(f"""
                        **ç›¸é–¢åˆ†æ:** {correlation_grade}
                        
                        **åˆ†æ•£åŠ¹æœ:** {diversification_pct:.1f}%ã®ãƒªã‚¹ã‚¯å‰Šæ¸›
                        
                        **æ¨å¥¨åº¦:**
                        - ç›¸é–¢ä¿‚æ•°: {portfolio_metrics['correlation']:.3f} {'(ä½ç›¸é–¢ã§è‰¯å¥½)' if portfolio_metrics['correlation'] < 0.5 else '(é«˜ç›¸é–¢ã§æ³¨æ„)'}
                        - ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£: {portfolio_metrics['portfolio_volatility']:.1%}
                        """)
                        
                        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œéƒ¨åˆ†
                        st.markdown("---")
                        st.subheader("ğŸ¯ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
                        
                        selected_tickers_clean = [ticker1.replace('.T', ''), ticker2.replace('.T', '')]
                        render_simulation_interface(selected_tickers_clean)
                        
                else:
                    st.error("âŒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ")
                    
            except Exception as e:
                st.error(f"âŒ åˆ†æã‚¨ãƒ©ãƒ¼: {str(e)}")

def render_simulation_interface(selected_tickers):
    """ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆä¿®æ­£ç‰ˆï¼‰"""
    if len(selected_tickers) != 2:
        st.warning("âš ï¸ 2éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„")
        return
    
    st.markdown("### âš™ï¸ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š")
    
    col_sim1, col_sim2 = st.columns(2)
    
    with col_sim1:
        # æŠ•è³‡é…åˆ†
        allocation_a = st.slider(
            f"{selected_tickers[0]}ã®é…åˆ†(%)",
            min_value=10, max_value=90, value=50, step=5
        )
        allocation_b = 100 - allocation_a
        st.metric(f"{selected_tickers[1]}ã®é…åˆ†", f"{allocation_b}%")
        
        # å–å¼•ã‚¿ã‚¤ãƒŸãƒ³ã‚°
        trading_time = st.selectbox(
            "å–å¼•ã‚¿ã‚¤ãƒŸãƒ³ã‚°:",
            ["9:00 å§‹å€¤", "15:00 çµ‚å€¤"]
        )
    
    with col_sim2:
        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“
        start_date = st.date_input(
            "é–‹å§‹æ—¥:",
            value=datetime.now() - timedelta(days=365),
            max_value=datetime.now() - timedelta(days=1)
        )
        
        end_date = st.date_input(
            "çµ‚äº†æ—¥:",
            value=datetime.now() - timedelta(days=1),
            max_value=datetime.now() - timedelta(days=1)
        )
    
    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    if st.button("ğŸš€ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ", type="primary", use_container_width=True):
        with st.spinner("ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."):
            results = run_portfolio_simulation(
                [f"{selected_tickers[0]}.T", f"{selected_tickers[1]}.T"],
                [allocation_a/100, allocation_b/100],
                start_date,
                end_date,
                trading_time == "9:00 å§‹å€¤"
            )
            
            if results:
                display_simulation_results(results, selected_tickers)

def analyze_ticker_eligibility(tickers):
    """éŠ˜æŸ„ã®å‚åŠ æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯"""
    eligible_tickers = []
    eligibility_data = []
    
    # å„éŠ˜æŸ„ã®å®Ÿéš›ã®ä¸Šå ´å¹´ï¼ˆèª¿æŸ»æ¸ˆã¿ï¼‰
    listing_years = {
        '6357.T': 2000,  # ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚º
        '4816.T': 1998,  # æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        '2991.T': 2017,  # ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆ
        '7564.T': 2000,  # ãƒ¯ãƒ¼ã‚¯ãƒãƒ³
        '7711.T': 1961,  # åŠ©å·é›»æ°—å·¥æ¥­
        '6405.T': 1961,  # éˆ´èŒ‚å™¨å·¥
        '2428.T': 2000,  # ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆ
        '6231.T': 1997,  # æœ¨æ‘å·¥æ©Ÿ
        '6855.T': 1961,  # æ—¥æœ¬é›»å­ææ–™
        '4832.T': 1989,  # JFEã‚·ã‚¹ãƒ†ãƒ ã‚º
        '4767.T': 1998   # ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼
    }
    
    current_year = datetime.now().year
    
    for ticker in tickers:
        try:
            yf_ticker = yf.Ticker(ticker)
            info = yf_ticker.info
            
            # æ™‚ä¾¡ç·é¡ãƒã‚§ãƒƒã‚¯ (50å„„å††ä»¥ä¸Š)
            market_cap = info.get('marketCap', 0)
            market_cap_ok = market_cap >= 5_000_000_000  # 50å„„å††
            
            # ä¸Šå ´æœŸé–“ãƒã‚§ãƒƒã‚¯ (1å¹´ä»¥ä¸Š) - å®Ÿéš›ã®ä¸Šå ´å¹´ã‚’ä½¿ç”¨
            listing_year = listing_years.get(ticker, current_year)
            years_listed = current_year - listing_year
            listing_ok = years_listed >= 1
            
            # æ±è¨¼ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰å¸‚å ´ãƒã‚§ãƒƒã‚¯ï¼ˆ.Tã§åˆ¤æ–­ï¼‰
            market_ok = ticker.endswith('.T')
            
            is_eligible = market_cap_ok and listing_ok and market_ok
            
            if is_eligible:
                eligible_tickers.append(ticker)
            
            eligibility_data.append({
                'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰': ticker,
                'ä¼æ¥­å': get_japanese_company_name(ticker, info),
                'æ™‚ä¾¡ç·é¡(å„„å††)': f"{market_cap/1e8:.0f}" if market_cap > 0 else "N/A",
                'ä¸Šå ´å¹´': f"{listing_year}å¹´" if listing_year < current_year else "ä¸æ˜",
                'ä¸Šå ´æœŸé–“': f"{years_listed}å¹´",
                'æ™‚ä¾¡ç·é¡OK': "âœ…" if market_cap_ok else "âŒ",
                'ä¸Šå ´æœŸé–“OK': "âœ…" if listing_ok else "âŒ",
                'å¸‚å ´OK': "âœ…" if market_ok else "âŒ",
                'å‚åŠ å¯èƒ½': "âœ…" if is_eligible else "âŒ"
            })
            
        except Exception as e:
            st.warning(f"âš ï¸ {ticker} ã®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")
            eligibility_data.append({
                'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰': ticker,
                'ä¼æ¥­å': 'ã‚¨ãƒ©ãƒ¼',
                'æ™‚ä¾¡ç·é¡(å„„å††)': 'N/A',
                'ä¸Šå ´å¹´': 'N/A',
                'ä¸Šå ´æœŸé–“': 'N/A',
                'æ™‚ä¾¡ç·é¡OK': "âŒ",
                'ä¸Šå ´æœŸé–“OK': "âŒ", 
                'å¸‚å ´OK': "âŒ",
                'å‚åŠ å¯èƒ½': "âŒ"
            })
    
    # çµæœè¡¨ç¤º
    eligibility_df = pd.DataFrame(eligibility_data)
    st.dataframe(eligibility_df, use_container_width=True)
    
    st.info(f"âœ… å‚åŠ å¯èƒ½éŠ˜æŸ„: {len(eligible_tickers)}å€‹ / {len(tickers)}å€‹")
    
    if len(eligible_tickers) > 0:
        st.success(f"å‚åŠ å¯èƒ½éŠ˜æŸ„: {', '.join([t.replace('.T', '') for t in eligible_tickers])}")
    else:
        st.error("âŒ å‚åŠ å¯èƒ½ãªéŠ˜æŸ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    
    return eligible_tickers

def analyze_portfolio_combinations(eligible_tickers):
    """å…¨ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªçµ„ã¿åˆã‚ã›ã®åˆ†æ"""
    if len(eligible_tickers) < 2:
        st.warning("âš ï¸ åˆ†æã«å¿…è¦ãªæœ€ä½2éŠ˜æŸ„ãŒä¸è¶³ã—ã¦ã„ã¾ã™")
        return pd.DataFrame()
    
    combinations = list(itertools.combinations(eligible_tickers, 2))
    portfolio_data = []
    failed_combinations = []
    
    # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’è¡¨ç¤º
    progress_bar = st.progress(0)
    total_combinations = len(combinations)
    
    st.write(f"ğŸ“Š {total_combinations}çµ„ã¿åˆã‚ã›ã®åˆ†æã‚’é–‹å§‹...")
    
    # ã¾ãš1ã¤ã®çµ„ã¿åˆã‚ã›ã§è©³ç´°ãƒ†ã‚¹ãƒˆ
    if combinations:
        test_ticker1, test_ticker2 = combinations[0]
        st.write(f"ğŸ” è©³ç´°ãƒ†ã‚¹ãƒˆ: {test_ticker1} Ã— {test_ticker2}")
        
        with st.expander("è©³ç´°ãƒ†ã‚¹ãƒˆçµæœ"):
            try:
                # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
                st.write("1. ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...")
                data1 = yf.download(test_ticker1, period='1y', progress=False, auto_adjust=True)
                data2 = yf.download(test_ticker2, period='1y', progress=False, auto_adjust=True)
                
                st.write(f"   {test_ticker1}: {len(data1)}è¡Œ, ã‚«ãƒ©ãƒ : {list(data1.columns)}")
                st.write(f"   {test_ticker2}: {len(data2)}è¡Œ, ã‚«ãƒ©ãƒ : {list(data2.columns)}")
                
                if not data1.empty and not data2.empty:
                    st.write("2. ãƒªã‚¿ãƒ¼ãƒ³è¨ˆç®—ä¸­...")
                    
                    # MultiIndexã®å ´åˆã®å‡¦ç†
                    if isinstance(data1.columns, pd.MultiIndex):
                        # MultiIndexã‹ã‚‰å˜ä¸€ã®ã‚«ãƒ©ãƒ ã‚’å–å¾—
                        close1 = data1.iloc[:, data1.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                        close2 = data2.iloc[:, data2.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                    else:
                        close1 = data1['Close']
                        close2 = data2['Close']
                    
                    returns1 = close1.pct_change().dropna()
                    returns2 = close2.pct_change().dropna()
                    
                    st.write(f"   {test_ticker1} ãƒªã‚¿ãƒ¼ãƒ³: {len(returns1)}å€‹")
                    st.write(f"   {test_ticker2} ãƒªã‚¿ãƒ¼ãƒ³: {len(returns2)}å€‹")
                    
                    # å…±é€šæ—¥ä»˜
                    common_dates = returns1.index.intersection(returns2.index)
                    st.write(f"   å…±é€šæ—¥ä»˜: {len(common_dates)}å€‹")
                    
                    if len(common_dates) >= 50:
                        returns1_common = returns1[common_dates]
                        returns2_common = returns2[common_dates]
                        
                        # çµ±è¨ˆè¨ˆç®—
                        portfolio_returns = 0.5 * returns1_common + 0.5 * returns2_common
                        expected_return = portfolio_returns.mean() * 252
                        portfolio_risk = portfolio_returns.std() * np.sqrt(252)
                        correlation = returns1_common.corr(returns2_common)
                        
                        st.write("3. è¨ˆç®—çµæœ:")
                        st.write(f"   æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³: {expected_return:.4f}")
                        st.write(f"   ãƒªã‚¹ã‚¯: {portfolio_risk:.4f}")
                        st.write(f"   ç›¸é–¢: {correlation:.4f}")
                        
                        if not (pd.isna(expected_return) or pd.isna(portfolio_risk) or pd.isna(correlation)):
                            st.success("âœ… ãƒ†ã‚¹ãƒˆçµ„ã¿åˆã‚ã›ã¯æ­£å¸¸ã«è¨ˆç®—ã§ãã¾ã—ãŸ")
                        else:
                            st.error("âŒ NaNå€¤ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
                    else:
                        st.error(f"âŒ å…±é€šæ—¥ä»˜ãŒä¸è¶³: {len(common_dates)}æ—¥")
                else:
                    st.error("âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—")
                    
            except Exception as e:
                st.error(f"âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    for idx, (ticker1, ticker2) in enumerate(combinations):
        try:
            # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
            progress_bar.progress((idx + 1) / total_combinations)
            
            # éå»1å¹´ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
            data1 = yf.download(ticker1, period='1y', progress=False, auto_adjust=True)
            data2 = yf.download(ticker2, period='1y', progress=False, auto_adjust=True)
            
            # ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒã‚§ãƒƒã‚¯
            if data1.empty:
                failed_combinations.append(f"{ticker1}: ãƒ‡ãƒ¼ã‚¿ãŒç©º")
                continue
                
            if data2.empty:
                failed_combinations.append(f"{ticker2}: ãƒ‡ãƒ¼ã‚¿ãŒç©º")
                continue
            
            # MultiIndexã®å ´åˆã®å‡¦ç†
            try:
                if isinstance(data1.columns, pd.MultiIndex):
                    # MultiIndexã‹ã‚‰'Close'ã‚«ãƒ©ãƒ ã‚’å–å¾—
                    close1 = data1.iloc[:, data1.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                    close2 = data2.iloc[:, data2.columns.get_level_values(0) == 'Close'].iloc[:, 0]
                else:
                    close1 = data1['Close']
                    close2 = data2['Close']
            except Exception as e:
                failed_combinations.append(f"{ticker1}Ã—{ticker2}: Closeã‚«ãƒ©ãƒ å–å¾—ã‚¨ãƒ©ãƒ¼ - {str(e)}")
                continue
                
            # æ—¥æ¬¡ãƒªã‚¿ãƒ¼ãƒ³è¨ˆç®—
            returns1 = close1.pct_change().dropna()
            returns2 = close2.pct_change().dropna()
            
            # ãƒ‡ãƒ¼ã‚¿æ•°ãƒã‚§ãƒƒã‚¯
            if len(returns1) == 0:
                failed_combinations.append(f"{ticker1}: ãƒªã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—")
                continue
                
            if len(returns2) == 0:
                failed_combinations.append(f"{ticker2}: ãƒªã‚¿ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—")
                continue
            
            # å…±é€šæ—¥ä»˜ã®ã¿
            common_dates = returns1.index.intersection(returns2.index)
            if len(common_dates) < 50:  # æœ€ä½50å–¶æ¥­æ—¥
                failed_combinations.append(f"{ticker1}Ã—{ticker2}: å…±é€šãƒ‡ãƒ¼ã‚¿ä¸è¶³ ({len(common_dates)}æ—¥)")
                continue
                
            returns1_common = returns1[common_dates]
            returns2_common = returns2[common_dates]
            
            # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæŒ‡æ¨™è¨ˆç®— (50%:50%ã®é…åˆ†)
            portfolio_returns = 0.5 * returns1_common + 0.5 * returns2_common
            
            # å¹´ç‡æ›ç®— (252å–¶æ¥­æ—¥)
            expected_return = portfolio_returns.mean() * 252
            portfolio_risk = portfolio_returns.std() * np.sqrt(252)
            
            # ç›¸é–¢ä¿‚æ•°è¨ˆç®—
            try:
                correlation = returns1_common.corr(returns2_common)
            except:
                correlation = 0.0
            
            # NaNãƒã‚§ãƒƒã‚¯
            if pd.isna(expected_return) or pd.isna(portfolio_risk) or pd.isna(correlation):
                failed_combinations.append(f"{ticker1}Ã—{ticker2}: NaNå€¤ãŒç™ºç”Ÿ")
                continue
            
            # ç„¡é™å¤§ãƒã‚§ãƒƒã‚¯
            if np.isinf(expected_return) or np.isinf(portfolio_risk) or np.isinf(correlation):
                failed_combinations.append(f"{ticker1}Ã—{ticker2}: ç„¡é™å¤§å€¤ãŒç™ºç”Ÿ")
                continue
            
            # ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ªï¼ˆãƒªã‚¹ã‚¯ãƒ•ãƒªãƒ¼ãƒ¬ãƒ¼ãƒˆ0%ã¨ä»®å®šï¼‰
            sharpe_ratio = expected_return / portfolio_risk if portfolio_risk > 0 and not np.isnan(portfolio_risk) else 0
            
            portfolio_data.append({
                'éŠ˜æŸ„1': get_japanese_company_name(ticker1, {}),
                'éŠ˜æŸ„2': get_japanese_company_name(ticker2, {}),
                'ãƒ†ã‚£ãƒƒã‚«ãƒ¼1': ticker1,
                'ãƒ†ã‚£ãƒƒã‚«ãƒ¼2': ticker2,
                'æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³(å¹´ç‡)': expected_return,
                'ãƒªã‚¹ã‚¯(å¹´ç‡)': portfolio_risk,
                'ç›¸é–¢ä¿‚æ•°': correlation,
                'ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª': sharpe_ratio,
                'ãƒ‡ãƒ¼ã‚¿æœŸé–“': f"{len(common_dates)}æ—¥"
            })
            
        except Exception as e:
            failed_combinations.append(f"{ticker1}Ã—{ticker2}: {str(e)}")
            continue
    
    # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’å‰Šé™¤
    progress_bar.empty()
    
    # çµæœã‚µãƒãƒªãƒ¼
    success_count = len(portfolio_data)
    failure_count = len(failed_combinations)
    
    if success_count > 0:
        st.success(f"âœ… æˆåŠŸ: {success_count}çµ„ã¿åˆã‚ã› / å¤±æ•—: {failure_count}çµ„ã¿åˆã‚ã›")
    else:
        st.error(f"âŒ æˆåŠŸ: {success_count}çµ„ã¿åˆã‚ã› / å¤±æ•—: {failure_count}çµ„ã¿åˆã‚ã›")
    
    # å¤±æ•—è©³ç´°ã‚’è¡¨ç¤ºï¼ˆæœ€å¤§10ä»¶ï¼‰
    if failed_combinations:
        with st.expander(f"âš ï¸ å¤±æ•—ã—ãŸçµ„ã¿åˆã‚ã›ã®è©³ç´° ({len(failed_combinations)}ä»¶)"):
            for i, failure in enumerate(failed_combinations[:10]):
                st.text(f"{i+1}. {failure}")
            if len(failed_combinations) > 10:
                st.text(f"... ä»– {len(failed_combinations) - 10}ä»¶")
    
    return pd.DataFrame(portfolio_data)

def sort_combinations(df, sort_option):
    """çµ„ã¿åˆã‚ã›ãƒ‡ãƒ¼ã‚¿ã®ã‚½ãƒ¼ãƒˆ"""
    if sort_option == "ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª(é™é †)":
        return df.sort_values('ã‚·ãƒ£ãƒ¼ãƒ—ãƒ¬ã‚·ã‚ª', ascending=False)
    elif sort_option == "ãƒªã‚¹ã‚¯(æ˜‡é †)":
        return df.sort_values('ãƒªã‚¹ã‚¯(å¹´ç‡)', ascending=True)
    elif sort_option == "ç›¸é–¢(æ˜‡é †)":
        return df.sort_values('ç›¸é–¢ä¿‚æ•°', ascending=True)
    elif sort_option == "æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³(é™é †)":
        return df.sort_values('æœŸå¾…ãƒªã‚¿ãƒ¼ãƒ³(å¹´ç‡)', ascending=False)
    return df

def render_simulation_interface(selected_tickers):
    """ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³UI"""
    st.subheader(f"ğŸ“ˆ {selected_tickers[0]} Ã— {selected_tickers[1]} ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
    
    col_sim1, col_sim2 = st.columns(2)
    
    with col_sim1:
        # æŠ•è³‡é…åˆ†è¨­å®š
        allocation_a = st.slider(
            f"{selected_tickers[0]}ã¸ã®æŠ•è³‡æ¯”ç‡(%)",
            min_value=0,
            max_value=100,
            value=50,
            step=5
        )
        allocation_b = 100 - allocation_a
        st.write(f"{selected_tickers[1]}ã¸ã®æŠ•è³‡æ¯”ç‡: {allocation_b}%")
        
        # å–å¼•ã‚¿ã‚¤ãƒŸãƒ³ã‚°
        trading_time = st.selectbox(
            "å–å¼•ã‚¿ã‚¤ãƒŸãƒ³ã‚°:",
            ["9:00 å§‹å€¤", "15:00 çµ‚å€¤"]
        )
    
    with col_sim2:
        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœŸé–“
        start_date = st.date_input(
            "é–‹å§‹æ—¥:",
            value=datetime.now() - timedelta(days=365),
            max_value=datetime.now() - timedelta(days=1)
        )
        
        end_date = st.date_input(
            "çµ‚äº†æ—¥:",
            value=datetime.now() - timedelta(days=1),
            max_value=datetime.now() - timedelta(days=1)
        )
    
    # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    if st.button("ğŸš€ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ", type="primary", use_container_width=True):
        with st.spinner("ğŸ“Š ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."):
            results = run_portfolio_simulation(
                [f"{selected_tickers[0]}.T", f"{selected_tickers[1]}.T"],
                [allocation_a/100, allocation_b/100],
                start_date,
                end_date,
                trading_time == "9:00 å§‹å€¤"
            )
            
            if results:
                display_simulation_results(results, selected_tickers)

def run_portfolio_simulation(tickers, allocations, start_date, end_date, use_open_price):
    """ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"""
    try:
        initial_capital = 3_000_000  # 300ä¸‡å††
        max_loss = 300_000  # 30ä¸‡å††
        min_capital = initial_capital - max_loss
        
        # ãƒ‡ãƒ¼ã‚¿å–å¾—
        data = {}
        for ticker in tickers:
            ticker_data = yf.download(ticker, start=start_date, end=end_date, progress=False, auto_adjust=True)
            if ticker_data.empty:
                st.error(f"âŒ {ticker}ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
                return None
            data[ticker] = ticker_data
        
        # å…±é€šã®å–å¼•æ—¥ã‚’å–å¾—
        common_dates = None
        for ticker_data in data.values():
            if common_dates is None:
                common_dates = ticker_data.index
            else:
                common_dates = common_dates.intersection(ticker_data.index)
        
        if len(common_dates) == 0:
            st.error("âŒ å…±é€šã®å–å¼•æ—¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
            return None
        
        # åˆæ—¥ã®æŠ•è³‡å®Ÿè¡Œ
        first_date = common_dates[0]
        portfolio = {}
        remaining_cash = 0
        
        price_column = 'Open' if use_open_price else 'Close'
        
        for i, ticker in enumerate(tickers):
            investment_amount = initial_capital * allocations[i]
            
            # MultiIndexã®å ´åˆã®å‡¦ç†
            if isinstance(data[ticker].columns, pd.MultiIndex):
                stock_price = data[ticker].iloc[:, data[ticker].columns.get_level_values(0) == price_column].iloc[0, 0]
            else:
                stock_price = data[ticker].loc[first_date, price_column]
                
            shares = int(investment_amount / stock_price)  # åˆ‡ã‚Šæ¨ã¦
            actual_investment = shares * stock_price
            
            portfolio[ticker] = shares
            remaining_cash += investment_amount - actual_investment
        
        # æ—¥æ¬¡è³‡ç”£è©•ä¾¡
        daily_values = []
        portfolio_values = []
        
        for date in common_dates:
            total_value = remaining_cash
            
            for ticker in tickers:
                if ticker in portfolio:
                    # MultiIndexã®å ´åˆã®å‡¦ç†
                    if isinstance(data[ticker].columns, pd.MultiIndex):
                        current_price = data[ticker].iloc[:, data[ticker].columns.get_level_values(0) == 'Close'].loc[date].iloc[0]
                    else:
                        current_price = data[ticker].loc[date, 'Close']
                    total_value += portfolio[ticker] * current_price
            
            daily_values.append({
                'Date': date,
                'Portfolio_Value': total_value,
                'Return': (total_value - initial_capital) / initial_capital
            })
            
            portfolio_values.append(total_value)
            
            # å¼·åˆ¶çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if total_value <= min_capital:
                st.warning(f"âš ï¸ {date.strftime('%Y-%m-%d')}ã«æœ€å¤§æå¤±ã«é”ã—ãŸãŸã‚ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†")
                break
        
        # çµæœè¨ˆç®—
        final_value = portfolio_values[-1]
        total_return = (final_value - initial_capital) / initial_capital
        max_value = max(portfolio_values)
        max_drawdown = (max_value - min(portfolio_values)) / max_value
        
        return {
            'daily_values': pd.DataFrame(daily_values),
            'portfolio': portfolio,
            'initial_capital': initial_capital,
            'final_value': final_value,
            'total_return': total_return,
            'max_drawdown': max_drawdown,
            'first_date': first_date,
            'price_column': price_column,
            'tickers': tickers,
            'allocations': allocations
        }
        
    except Exception as e:
        st.error(f"âŒ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}")
        return None

def display_simulation_results(results, selected_tickers):
    """ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœã®è¡¨ç¤º"""
    st.markdown("---")
    st.subheader("ğŸ“Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ")
    
    # ã‚µãƒãƒªãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    col_metric1, col_metric2, col_metric3, col_metric4 = st.columns(4)
    
    with col_metric1:
        st.metric(
            "æœ€çµ‚è³‡ç”£",
            f"Â¥{results['final_value']:,.0f}",
            f"Â¥{results['final_value'] - results['initial_capital']:+,.0f}"
        )
    
    with col_metric2:
        st.metric(
            "ãƒˆãƒ¼ã‚¿ãƒ«ãƒªã‚¿ãƒ¼ãƒ³",
            f"{results['total_return']:.2%}",
            "vs åˆæœŸè³‡é‡‘"
        )
    
    with col_metric3:
        st.metric(
            "æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³",
            f"{results['max_drawdown']:.2%}",
            "æœ€å¤§ä¸‹è½ç‡"
        )
    
    with col_metric4:
        # æ—¥æ¬¡ã®ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£
        daily_returns = results['daily_values']['Return'].pct_change().dropna()
        volatility = daily_returns.std() * np.sqrt(252) if len(daily_returns) > 1 else 0
        st.metric(
            "ãƒœãƒ©ãƒ†ã‚£ãƒªãƒ†ã‚£",
            f"{volatility:.2%}",
            "å¹´ç‡"
        )
    
    # è³‡ç”£æ¨ç§»ã‚°ãƒ©ãƒ•
    st.subheader("ğŸ“ˆ è³‡ç”£æ¨ç§»")
    
    fig = go.Figure()
    
    # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªä¾¡å€¤
    fig.add_trace(go.Scatter(
        x=results['daily_values']['Date'],
        y=results['daily_values']['Portfolio_Value'],
        mode='lines',
        name='ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª',
        line=dict(color='blue', width=3)
    ))
    
    # åˆæœŸè³‡é‡‘ãƒ©ã‚¤ãƒ³
    fig.add_hline(
        y=results['initial_capital'],
        line_dash="dash",
        line_color="gray",
        annotation_text="åˆæœŸè³‡é‡‘"
    )
    
    # å¼·åˆ¶çµ‚äº†ãƒ©ã‚¤ãƒ³
    fig.add_hline(
        y=results['initial_capital'] - 300_000,
        line_dash="dash",
        line_color="red",
        annotation_text="å¼·åˆ¶çµ‚äº†ãƒ©ã‚¤ãƒ³"
    )
    
    fig.update_layout(
        title="ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªè³‡ç”£æ¨ç§»",
        xaxis_title="æ—¥ä»˜",
        yaxis_title="è³‡ç”£ä¾¡å€¤ (å††)",
        height=500
    )
    
    st.plotly_chart(fig, use_container_width=True)
    
    # å–å¼•ã‚µãƒãƒªãƒ¼
    st.subheader("ğŸ“‹ å–å¼•ã‚µãƒãƒªãƒ¼")
    
    trade_data = []
    for i, ticker in enumerate(results['tickers']):
        ticker_code = ticker.replace('.T', '')
        shares = results['portfolio'][ticker]
        allocation = results['allocations'][i]
        investment = results['initial_capital'] * allocation
        
        trade_data.append({
            'éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰': ticker_code,
            'ä¼æ¥­å': get_japanese_company_name(ticker, {}),
            'è³¼å…¥æ ªæ•°': f"{shares:,}æ ª",
            'æŠ•è³‡é…åˆ†': f"{allocation:.1%}",
            'æŠ•è³‡é¡': f"Â¥{investment:,.0f}"
        })
    
    trade_df = pd.DataFrame(trade_data)
    st.dataframe(trade_df, use_container_width=True)

# --- ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ† ---
def main():
    """ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³"""
    
    # ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
    if not st.session_state.authenticated:
        login_page()
        return
    
    # ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¿½åŠ 
    with st.sidebar:
        st.write(f"ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³ä¸­: **{st.session_state.username}**")
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´", type="secondary", use_container_width=True):
                st.session_state.page = 'password_change'
                st.rerun()
        with col2:
            if st.button("ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", type="secondary", use_container_width=True):
                logout()
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š
    with st.sidebar:
        st.title("ğŸ“Š åˆ†æè¨­å®š")
        
        # éŠ˜æŸ„å…¥åŠ›
        ticker_input = st.text_input(
            "åˆ†æå¯¾è±¡éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰:", 
            value="6357",
            help="ä¾‹: 6357, 4816, 2991 ãªã©"
        )
        
        # åˆ†æå®Ÿè¡Œãƒœã‚¿ãƒ³
        if st.button("ğŸ” çµ±åˆåˆ†æå®Ÿè¡Œ", use_container_width=True):
            if ticker_input:
                st.session_state.page = 'detail'
                st.session_state.selected_ticker = f"{ticker_input}.T"
                st.rerun()
        
        st.markdown("---")
        
        # ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        st.subheader("ğŸ§­ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³")
        if st.button("ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰", use_container_width=True):
            st.session_state.page = 'dashboard'
            st.rerun()
        
        if st.button("ğŸ“Š ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæˆ¦ç•¥å®¤", use_container_width=True):
            st.session_state.page = 'portfolio_strategy'
            st.rerun()
        
        # æ©Ÿèƒ½èª¬æ˜
        st.markdown("---")
        st.subheader("ğŸ’¡ æ©Ÿèƒ½èª¬æ˜")
        
        with st.expander("ğŸ“ˆ ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ"):
            st.write("""
            - ãƒ­ãƒ¼ã‚½ã‚¯è¶³ãƒãƒ£ãƒ¼ãƒˆï¼ˆç§»å‹•å¹³å‡ç·šä»˜ãï¼‰
            - RSIæŒ‡æ¨™ãƒ»ä¾¡æ ¼çµ±è¨ˆ
            """)
        
        with st.expander("ğŸ¢ ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«åˆ†æ"):
            st.write("""
            - è²¡å‹™æŒ‡æ¨™æ¨ç§»ï¼ˆå£²ä¸Šé«˜ãƒ»å–¶æ¥­åˆ©ç›Šç­‰ï¼‰
            - æˆé•·ç‡ãƒ»åç›Šæ€§åˆ†æ
            """)
        
        with st.expander("ğŸ” æ ªä¾¡å¤‰å‹•è¦å› åˆ†æ"):
            st.write("""
            - 5%ä»¥ä¸Šã®å¤§ããªæ ªä¾¡å¤‰å‹•ã®è¦å› åˆ†æ
            - ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«ãƒ»ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ»æ¥­ç•Œç‰¹æœ‰è¦å› ã®ç‰¹å®š
            - ä¸Šæ˜‡ãƒ»ä¸‹è½ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è©³ç´°åˆ†æ
            """)
        
        with st.expander("ğŸ“Š æ¥­ç¸¾äºˆæƒ³ç²¾åº¦åˆ†æ"):
            st.write("""
            å¯¾å¿œéŠ˜æŸ„: ä¸‰ç²¾ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºã€æ±æ˜ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€
            ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒˆã€ãƒ¯ãƒ¼ã‚¯ãƒãƒ³ã€åŠ©å·é›»æ°—å·¥æ¥­ã€éˆ´èŒ‚å™¨å·¥ã€
            ã‚¦ã‚§ãƒ«ãƒãƒƒãƒˆã€æœ¨æ‘å·¥æ©Ÿã€æ—¥æœ¬é›»å­ææ–™ã€JFEã‚·ã‚¹ãƒ†ãƒ ã‚ºã€
            ãƒ†ãƒ¼ãƒ»ã‚ªãƒ¼ãƒ»ãƒ€ãƒ–ãƒªãƒ¥ãƒ¼
            
            - äºˆæƒ³vså®Ÿç¸¾ã®æ¨ç§»åˆ†æ
            - äºˆæƒ³ç²¾åº¦ã®èª¤å·®ç‡è¨ˆç®—
            - ä¼æ¥­ã®äºˆæƒ³å‚¾å‘åˆ†æ
            """)
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
    tickers = ['6357.T', '4816.T', '2991.T', '7564.T', '7711.T', '6405.T', 
              '2428.T', '6231.T', '6855.T', '4832.T', '4767.T']
    
    # æ ªä¾¡ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    all_data = {}
    ticker_info_dict = {}
    fundamental_data_dict = {}
    market_indices = {}
    
    with st.spinner('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...'):
        # å¸‚å ´æŒ‡æ¨™ã®å–å¾—ï¼ˆæ—¥çµŒå¹³å‡ã€TOPIXï¼‰
        try:
            # æ—¥çµŒå¹³å‡ï¼ˆ^N225ï¼‰
            nikkei = yf.Ticker("^N225")
            nikkei_data = nikkei.history(period='1y')
            if not nikkei_data.empty:
                market_indices['æ—¥çµŒå¹³å‡'] = nikkei_data
                
            # TOPIXï¼ˆ1306.T - TOPIXé€£å‹•å‹ETFï¼‰
            # ^TPXãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ã€TOPIXé€£å‹•ETFã‚’ä½¿ç”¨
            try:
                topix = yf.Ticker("1306.T")  # TOPIXé€£å‹•å‹ETF
                topix_data = topix.history(period='1y')
                if not topix_data.empty:
                    market_indices['TOPIX'] = topix_data
            except:
                # ä»£æ›¿ã¨ã—ã¦åˆ¥ã®TOPIXé–¢é€£ETFã‚’è©¦ã™
                try:
                    topix = yf.Ticker("1308.T")  # TOPIX Core 30é€£å‹•å‹ETF
                    topix_data = topix.history(period='1y')
                    if not topix_data.empty:
                        market_indices['TOPIX'] = topix_data
                except:
                    st.sidebar.info("â„¹ï¸ TOPIXæŒ‡æ¨™ã®å–å¾—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ")
        except Exception as e:
            st.sidebar.warning(f"âš ï¸ å¸‚å ´æŒ‡æ¨™ã®å–å¾—ã‚¨ãƒ©ãƒ¼: {str(e)}")
        
        # å€‹åˆ¥æ ªå¼ã®å–å¾—
        for ticker in tickers:
            try:
                # æ ªä¾¡ãƒ‡ãƒ¼ã‚¿
                yf_ticker = yf.Ticker(ticker)
                hist_data = yf_ticker.history(period='1y')
                
                if not hist_data.empty:
                    # ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã‚’è¿½åŠ 
                    hist_data = calculate_rsi(hist_data)
                    hist_data['MA20'] = hist_data['Close'].rolling(window=20).mean()
                    hist_data['MA50'] = hist_data['Close'].rolling(window=50).mean()
                    all_data[ticker] = hist_data
                    
                    # ä¼æ¥­æƒ…å ±
                    ticker_info_dict[ticker] = yf_ticker.info
                
                # ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå¯¾å¿œéŠ˜æŸ„ã®ã¿ï¼‰
                fund_file_path = f'cleaned_financials_{ticker.replace(".T", "")}.csv'
                if os.path.exists(fund_file_path):
                    try:
                        fund_data = pd.read_csv(fund_file_path, index_col=0, parse_dates=True)
                        fundamental_data_dict[ticker] = fund_data
                    except Exception as e:
                        st.sidebar.warning(f"âš ï¸ {ticker} ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {str(e)}")
                        pass
                        
            except Exception as e:
                st.sidebar.error(f"âŒ {ticker} ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—: {str(e)}")
                continue
    
    # ãƒšãƒ¼ã‚¸ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    if st.session_state.page == 'dashboard':
        render_main_dashboard(all_data, ticker_info_dict, fundamental_data_dict, market_indices)
    
    elif st.session_state.page == 'password_change':
        password_change_page()
    
    elif st.session_state.page == 'portfolio_strategy':
        render_portfolio_strategy_page()
    
    elif st.session_state.page == 'detail' and st.session_state.selected_ticker:
        ticker = st.session_state.selected_ticker
        if ticker in all_data:
            render_detail_page(
                ticker, 
                all_data[ticker], 
                ticker_info_dict.get(ticker, {}),
                fundamental_data_dict.get(ticker)
            )
        else:
            st.error(f"âŒ {ticker} ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
            if st.button("ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹"):
                st.session_state.page = 'dashboard'
                st.rerun()
    
    else:
        st.session_state.page = 'dashboard'
        render_main_dashboard(all_data, ticker_info_dict, fundamental_data_dict, market_indices)

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
if __name__ == "__main__":
    main()
else:
    main()
